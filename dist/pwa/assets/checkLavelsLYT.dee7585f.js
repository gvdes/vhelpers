import{u as j,r as d,c as b,o as _,d as M,w as m,e as r,ab as h,g as T,j as f,i as x,k as C,Y as P,z as S}from"./index.52a3c292.js";import{Q as N}from"./QHeader.84a24e56.js";import{Q as E}from"./QTable.73570121.js";import{Q as O}from"./QPage.a8a9aaec.js";import{Q as U,a as H}from"./QLayout.1023dce7.js";import{_ as F}from"./UserToolbar.d387172b.js";import"./QList.cf079002.js";import"./QSelect.c9c7c333.js";import"./axios.172360c8.js";import{u as I}from"./use-quasar.c1be6315.js";/* empty css                                                                         */import{_ as J}from"./OptionsLabels.b3d3532c.js";import{p as W}from"./productsApi.66936c85.js";import{d as D}from"./dayjs.min.cbcf888d.js";import{E as G}from"./exceljs.min.9e24d01d.js";import"./jspdf.plugin.autotable.bb7ae945.js";import"./browser.c61f550a.js";import{H as K}from"./html5-qrcode-scanner.64619f17.js";import"./QResizeObserver.81625c6a.js";import"./QLinearProgress.4a89e476.js";import"./QScrollObserver.c4256086.js";import"./QExpansionItem.e2dc76cf.js";import"./QDrawer.f2292652.js";import"./ClosePopup.db2b9d28.js";import"./auth.0286d7c7.js";import"./QImg.cfafbdca.js";import"./JsBarcode.cb858474.js";import"./labels.7f2610c1.js";import"./_commonjsHelpers.88e99c8f.js";const X={class:"q-mb-md flex justify-center"},Z={key:0,id:"reader"},ee={key:1,class:"q-mt-md row"},Re={__name:"checkLavelsLYT",setup(ae){const k=j(),y=I();d([]);const p=d({state:!1}),L=d({val:[0,1,2,4],opts:[{label:"Menudeo",value:1},{label:"Mayoreo",value:2},{label:"Docena",value:3},{label:"Caja",value:4}]}),s=d([]);d([]);let n=null;const v=d(!1),g=[{name:"id",label:"Producto",field:a=>a.modelo,align:"left"},{name:"code",label:"Producto",field:a=>{var e;return(e=a.item)==null?void 0:e.code},align:"left"},{name:"description",label:"Descripcion",field:a=>{var e;return(e=a.item)==null?void 0:e.description},align:"left"},{name:"ubicacion",label:"Ubicaciones",field:a=>{var e;return(e=a.item)==null?void 0:e.locations.map(o=>o.path).join("/")},align:"left"},{name:"stock",label:"Stocks",field:a=>{var e;return(e=a.item)==null?void 0:e.stocks[0].pivot.gen},align:"left"},{name:"ult",label:"Ult.Actualizacion",field:a=>{var e;return D((e=a.update)==null?void 0:e.created_at).format("YYYY-MM-DD")},align:"center"}],Y=b(()=>{var a;return(a=s.value)==null?void 0:a.filter(e=>e.status)}),u=b(()=>{var a;return(a=s.value)==null?void 0:a.filter(e=>!e.status)}),B=b(()=>u.value.map(a=>a.item)),R=async()=>{if(y.loading.show({message:"Obteniendo Informacion"}),s.value.size===0){console.log("No hay nada brou");return}const a=s.value,e={products:a,workpoint:k.session.store.id_viz};console.log(`Enviando ${a.length} QR al backend...`);const o=await W.checkLabel(e);o.fail?console.log(o):(console.log(o),o.forEach(t=>{const l=s.value.findIndex(i=>i.modelo===t.code.id);if(l!==-1){s.value[l].status=t.status,s.value[l].item=t.code;let i=V(s.value[l].item.prices);s.value[l].item._copies=1,s.value[l].item.type=i.type,s.value[l].item.usedPrices=i.prices,s.value[l].update=t.actualizado}}),y.loading.hide())},q=()=>{if(n){console.log("La c\xE1mara ya est\xE1 activa");return}v.value=!0,S(()=>{n=new K("reader");const a={fps:10,qrbox:300};n.start({facingMode:"environment"},a,e=>{try{const o=JSON.parse(e);s.value.some(l=>l.modelo===o.modelo&&l.idChange===o.idChange)?console.log(`QR repetido ignorado: ${o.modelo}`):(s.value.push(o),console.log(`QR agregado: ${o.modelo}`))}catch{console.log("QR inv\xE1lido: "+e)}}).catch(e=>console.log("Error al iniciar c\xE1mara: "+e.message)),console.log("C\xE1mara iniciada")})},z=()=>{if(!n){console.log("La c\xE1mara no estaba activa");return}n.stop().then(()=>{n.clear(),n=null,v.value=!1,console.log("C\xE1mara detenida"),R()}).catch(a=>console.log("Error al detener c\xE1mara: "+a.message))},A=async()=>{const a=new G.Workbook,e=a.addWorksheet("ActualizaEtiquetas");e.addRow(g.map(t=>t.label)),u.value.forEach(t=>{var l,i,c,w,Q;return e.addRow([t.modelo,(l=t.item)==null?void 0:l.code,(i=t.item)==null?void 0:i.description,(c=t.item)==null?void 0:c.locations.map($=>$.path).join("/"),(w=t.item)==null?void 0:w.stocks[0].pivot.gen,D((Q=t.update)==null?void 0:Q.created_at).format("YYYY-MM-DD")])}),(async()=>{const t=await a.xlsx.writeBuffer(),l=new Blob([t],{type:"application/octet-stream"}),i=URL.createObjectURL(l),c=document.createElement("a");c.href=i,c.download=`Comparativo${k.session.store.alias}.xlsx`,document.body.appendChild(c),c.click(),document.body.removeChild(c)})()},V=(a,e)=>{let o=[...a];const t=o.find(i=>i.pivot._type==4),l=o.find(i=>i.pivot._type==1);if(t.pivot.price==l.pivot.price){let i={id:0,alias:"OFERTA",name:"Oferta",pivot:{price:o[0].pivot.price},used:!0};return console.log("oferta"),{type:"off",prices:[i]}}else return console.log("estandar"),{type:"std",prices:o}};return(a,e)=>(_(),M(U,{view:"hHh Lpr fFf"},{default:m(()=>[r(N,{class:"bg-grey-3 text-dark",bordered:""},{default:m(()=>[r(F),r(h)]),_:1}),r(H,null,{default:m(()=>[r(O,{padding:"",class:"q-pa-md"},{default:m(()=>[T("div",X,[r(f,{label:"Iniciar Escaneo",color:"primary",onClick:q}),r(f,{label:"Detener Escaneo",color:"negative",class:"q-ml-md",onClick:z})]),v.value?(_(),x("div",Z)):C("",!0),s.value.length?(_(),x("div",ee,[r(E,{dense:"",title:"Actualizados",rows:Y.value,"row-key":"code",columns:g,class:"col"},null,8,["rows"]),r(h,{spaced:"",inset:"",vertical:"",dark:""}),r(E,{dense:"",title:"Sin Actualizar",rows:u.value,"row-key":"code",columns:g,class:"col"},{"top-right":m(()=>[r(f,{color:"primary","icon-right":"archive",flat:"",onClick:A,disable:u.value.length<=0},null,8,["disable"]),r(h,{spaced:"",inset:"",vertical:"",dark:""}),r(f,{class:"col",flat:"",color:"primary",icon:"label",rounded:"",title:"Crear Etiquetas",onClick:e[0]||(e[0]=o=>p.value.state=!p.value.state)})]),_:1},8,["rows"])])):C("",!0),r(P,{modelValue:p.value.state,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.state=o),persistent:""},{default:m(()=>[r(J,{products:B.value,prices:L.value},null,8,["products","prices"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}};export{Re as default};

import{b as V,a as oe,d as O,e as h,Q as z}from"./QList.c8ebc72f.js";import{Q as ae}from"./QHeader.92a468b0.js";import{aH as le,a as se,u as re,r as C,c as A,l as de,p as ne,m as ie,a$ as ue,o as g,d as N,w as a,e,a1 as d,Q as m,h as Q,f as r,a0 as n,g as D,ak as p,S as T,aF as ce,aG as me,a4 as L,al as pe}from"./index.be192ee6.js";import{a as x,Q as U}from"./QSelect.cd223c52.js";import{Q as ve}from"./QToolbarTitle.28ba1ec4.js";import{Q as fe}from"./QToolbar.33476caf.js";import{Q as P}from"./QCardSection.30d8e469.js";import{Q as _e}from"./QInput.6e9b67fc.js";import{Q as j}from"./QCardActions.c1937265.js";import{Q as w}from"./QCard.dd592c54.js";import{Q as be}from"./QImg.b5b50261.js";import{Q as S}from"./QTd.c82c5612.js";import{Q as ge}from"./QTable.3120fa4a.js";import{Q as xe,a as we}from"./QLayout.36d2f8a9.js";import{C as E}from"./ClosePopup.42cde6d5.js";import"./dayjs.min.cbcf888d.js";import{c as ye,a as ke}from"./catalogStore.85ff8730.js";import{o as H}from"./orderApi.e0c959a7.js";import{v as R}from"./axios.0d58d5b3.js";import{u as Ce}from"./use-quasar.cebbf4cd.js";import{_ as Qe}from"./UserToolbar.343606ac.js";import{$sktOrders as y}from"./socket.05630e21.js";import"./use-key-composition.d4319e60.js";import"./QResizeObserver.30f73c00.js";import"./QLinearProgress.90a5e3b9.js";import"./QCheckbox.30873060.js";import"./QScrollObserver.0e6dcf79.js";import"./_commonjsHelpers.88e99c8f.js";import"./QDrawer.40d07889.js";import"./auth.03d73b5b.js";const Pe={class:"col text-bold text-h5 q-mt-md"},Se={key:0,class:"col"},$e={key:1},Ve={class:"text-subtitle2"},he={class:"row q-col-gutter-md"},Ne={class:"col-6 col-md-3"},Oe={class:"text-h6 text-bold"},qe={class:"col-6 col-md-3"},Ie={class:"text-h6 text-bold"},Be={class:"col-6 col-md-3"},Fe={class:"text-bold"},ze={class:"text-bold"},Ae={class:"col-6 col-md-3"},De={class:"text-bold"},Te={class:"text-bold"},Le={class:"ellipsis",style:{"max-width":"250px"}},Ue={class:"row items-center justify-center q-gutter-xs"},je={class:"text-bold q-mx-sm"},wt={__name:"Catalog",setup(Ee){const k=le(),q=se(),s=ye(),$=Ce(),v=re(),b=C(!1),u=C({state:!1,order:{_created_by:null,_workpoint:v.session.store.id_viz,name:null}}),f=C({val:null,opts:[],optsFil:null}),I={profile:{me:{id:v.session.credentials.staff.id_va,nick:v.session.credentials.nick,picture:"",names:v.session.credentials.staff.complete_name,surname_pat:"",surname_mat:"",change_password:!1,_rol:1},workpoint:v.session.store},workpoint:v.session.store,room:"sales"},c=C({val:null,opts:[]}),J=C({columns:[{name:"picture",label:"Imagen",field:o=>o.imgcover},{name:"code",label:"Codigo",field:o=>o.code},{name:"description",label:"Descripcion",field:o=>o.description},{name:"amount",label:"Cantidad",field:o=>o.pivot.amount}]}),B=A(()=>k.name==="sinx"),M=A(()=>k.name==="fidca"),G=async()=>{const o=await ke.getPrinters(v.session.store);if(o.fail)console.log(o),alert("Hay Problema para recibir las impresoras");else{console.log(o),s.setPrinters(o),c.value.opts=o.printers,f.value.opts=o.users;const l=localStorage.getItem("selectedPrinter");if(l){const _=JSON.parse(l),t=c.value.opts.find(i=>i.id===_.id);t&&(c.value.val=t)}}},K=()=>{if(k.name==="fidca"){const{sid:o}=k.params;q.push({name:"sidca",params:{sid:o}})}else k.name==="sidca"&&q.push({name:"sinx"})},W=async()=>{u.value.order._created_by=f.value.val.id,console.log(u.value.order),$.loading.show({message:"Creando Pedido"});const o=await H.create(u.value.order);o.fail?console.log(o):(console.log(o),u.value.state=!1,s.setOrderState(!0),s.setOrder(o),y.connected?(y.emit("order_add",{order:o,user:I.profile}),console.log("Evento order_add emitido por socket")):console.warn("Socket no conectado, no se envi\xF3 el evento order_add"),$.loading.hide())},X=o=>{o.pivot.amount++,o.pivot.units++,o.pivot.total=o.pivot.amount*o.pivot.price,s.updateProduct(o)},Y=o=>{o.pivot.amount--,o.pivot.units--,o.pivot.amount<=0?(delete o.pivot,s.removeProduct(o.id)):(o.pivot.total=o.pivot.amount*o.pivot.price,s.updateProduct(o))},Z=()=>{s.clearOrder(),b.value=!1,window.location.reload()},ee=async()=>{$.loading.show({message:"Cerrando Pedido"});let o={order:s.order,_printer:c.value.val};const l=await H.orderCatalog(o);if(l.fail)console.log(l);else{if(y.connected){let _={order:s.order,newstate:l.status};console.log(_),y.emit("order_update",_),console.log("Evento order_update emitido por socket")}else console.warn("Socket no conectado, no se envi\xF3 el evento order_update");$.loading.hide(),console.log(l),s.clearOrder(),b.value=!1,window.location.reload()}},te=(o,l,_)=>{l(()=>{const t=o.toLowerCase();f.value.optsFil=f.value.opts.filter(i=>{let F=`${i.names} ${i.surname_pat} ${i.surname_mat}`;return/^\d+$/.test(t)&&String(i.id_tpv).includes(t)||F.toLowerCase().includes(t)})})};return de(()=>c.value.val,o=>{o&&localStorage.setItem("selectedPrinter",JSON.stringify(o))}),ne(()=>{y.connect(),y.emit("join",I),s.loadOrder(),G();const o=localStorage.getItem("selectedPrinter");o&&(c.value.val=JSON.parse(o))}),ie(()=>{}),(o,l)=>{const _=ue("router-view");return g(),N(xe,{view:"hHh Lpr fFf"},{default:a(()=>[e(ae,{class:"transparent text-dark",bordered:""},{default:a(()=>[e(Qe),e(V)]),_:1}),e(we,null,{default:a(()=>[e(fe,null,{default:a(()=>[!B.value&&!d(s).orderState?(g(),N(m,{key:0,round:"",dense:"",icon:"arrow_back",disable:B.value,onClick:K},null,8,["disable"])):Q("",!0),e(V,{spaced:"",inset:"",vertical:"",dark:""}),e(ve,{class:"row"},{default:a(()=>[r("div",Pe,n(d(s).title),1),d(s).orderState?(g(),D("div",Se,[e(oe,{bordered:""},{default:a(()=>[e(O,null,{default:a(()=>[e(h,null,{default:a(()=>[e(x,{overline:""},{default:a(()=>l[7]||(l[7]=[p("Pedido")])),_:1}),e(x,null,{default:a(()=>[p(n(d(s).order.id),1)]),_:1})]),_:1}),e(h,null,{default:a(()=>[e(x,{overline:""},{default:a(()=>l[8]||(l[8]=[p("Cliente")])),_:1}),e(x,null,{default:a(()=>[p(n(d(s).order.name),1)]),_:1})]),_:1})]),_:1})]),_:1})])):Q("",!0)]),_:1}),M.value?(g(),D("div",$e,[d(s).orderState?(g(),N(m,{key:0,flat:"",round:"",dense:"",icon:"shopping_cart",onClick:l[0]||(l[0]=t=>b.value=!b.value)},{default:a(()=>[p(n(d(s).order.products.reduce((t,i)=>t+Number(i.pivot.amount),0)),1)]),_:1})):Q("",!0),d(s).orderState?Q("",!0):(g(),N(m,{key:1,flat:"",round:"",dense:"",icon:"add",onClick:l[1]||(l[1]=t=>u.value.state=!u.value.state)}))])):Q("",!0)]),_:1}),e(_),e(z,{modelValue:u.value.state,"onUpdate:modelValue":l[4]||(l[4]=t=>u.value.state=t),persistent:""},{default:a(()=>[e(w,null,{default:a(()=>[e(P,{class:"row items-center bg-primary text-white"},{default:a(()=>[e(T,{name:"list"}),l[9]||(l[9]=r("span",{class:"q-ml-sm"},"Nevo Pedido",-1))]),_:1}),e(P,null,{default:a(()=>[e(U,{modelValue:f.value.val,"onUpdate:modelValue":l[2]||(l[2]=t=>f.value.val=t),options:f.value.optsFil,label:"Vendedor","option-label":"nick","use-input":"","hide-selected":"",filled:"","fill-input":"","input-debounce":"0",onFilter:te,dense:""},{option:a(t=>[e(O,ce(me(t.itemProps)),{default:a(()=>[e(h,null,{default:a(()=>[e(x,null,{default:a(()=>[p(n(`${t.opt.names} ${t.opt.surname_mat} ${t.opt.surname_pat}`),1)]),_:2},1024),e(x,{caption:""},{default:a(()=>[p(n(t.opt.nick)+" ("+n(t.opt.id_tpv)+")",1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),"no-option":a(()=>[e(O,null,{default:a(()=>[e(h,{class:"text-grey"},{default:a(()=>l[10]||(l[10]=[p(" APOCO AUN NO TE DICEN? ")])),_:1})]),_:1})]),_:1},8,["modelValue","options"]),e(V,{spaced:"",inset:"",vertical:"",dark:""}),e(_e,{modelValue:u.value.order.name,"onUpdate:modelValue":l[3]||(l[3]=t=>u.value.order.name=t),type:"text",label:"Nombre Cliente"},{prepend:a(()=>[e(T,{name:"person_add"})]),_:1},8,["modelValue"])]),_:1}),e(j,{align:"right"},{default:a(()=>[L(e(m,{flat:"",label:"Cancelar",color:"negative"},null,512),[[E]]),e(m,{flat:"",label:"Crear",color:"positive",onClick:W})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(z,{modelValue:b.value,"onUpdate:modelValue":l[6]||(l[6]=t=>b.value=t),persistent:""},{default:a(()=>[e(w,{class:"q-pa-md",style:{width:"950px","max-width":"90vw","border-radius":"16px"}},{default:a(()=>[e(P,{class:"bg-primary text-white q-pa-md flex items-center justify-between rounded-borders"},{default:a(()=>[r("div",null,[l[11]||(l[11]=r("div",{class:"text-h6 text-weight-bold"},"Resumen del Pedido",-1)),r("div",Ve,"#"+n(d(s).order.id)+" \u2014 "+n(d(s).order.name),1)]),L(e(m,{flat:"",dense:"",round:"",icon:"close",color:"white"},null,512),[[E]])]),_:1}),e(P,{class:"q-pt-md"},{default:a(()=>[r("div",he,[r("div",Ne,[e(w,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:a(()=>[l[12]||(l[12]=r("div",{class:"text-grey"},"Modelos",-1)),r("div",Oe,n(d(s).order.products.length),1)]),_:1})]),r("div",qe,[e(w,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:a(()=>[l[13]||(l[13]=r("div",{class:"text-grey"},"Total piezas",-1)),r("div",Ie,n(d(s).order.products.reduce((t,i)=>t+Number(i.pivot.amount),0)),1)]),_:1})]),r("div",Be,[e(w,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:a(()=>[l[14]||(l[14]=r("div",{class:"text-grey"},"Creado por",-1)),r("div",Fe,n(d(s).order.created_by.names),1),r("div",ze,n(`${d(s).order.created_by.surname_pat} ${d(s).order.created_by.surname_mat}`),1)]),_:1})]),r("div",Ae,[e(w,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:a(()=>[l[15]||(l[15]=r("div",{class:"text-grey"},"Sucursal",-1)),r("div",De,n(d(v).session.store.name),1)]),_:1})])])]),_:1}),e(V,{spaced:""}),e(P,null,{default:a(()=>[e(ge,{flat:"",bordered:"",dense:"",rows:d(s).order.products,columns:J.value.columns,"row-key":"id",separator:"cell","no-data-label":"No hay productos en este pedido"},{"body-cell-picture":a(t=>[e(S,{props:t,class:"text-center"},{default:a(()=>[e(pe,{size:"70px",square:""},{default:a(()=>[e(be,{src:t.row.imgcover?`${d(R)}/Products/${t.row.id}/${t.row.imgcover}`:`${d(R)}/Products/sinpicture.png`,"spinner-color":"primary",style:{"object-fit":"contain"}},null,8,["src"])]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-code":a(t=>[e(S,{props:t},{default:a(()=>[r("div",Te,n(t.row.code),1)]),_:2},1032,["props"])]),"body-cell-description":a(t=>[e(S,{props:t},{default:a(()=>[r("div",Le,n(t.row.description),1)]),_:2},1032,["props"])]),"body-cell-amount":a(t=>[e(S,{props:t,class:"text-center"},{default:a(()=>[r("div",Ue,[e(m,{dense:"",flat:"",round:"",icon:"remove",size:"sm",color:"negative",onClick:i=>Y(t.row)},null,8,["onClick"]),r("div",je,n(t.row.pivot.amount),1),e(m,{dense:"",flat:"",round:"",icon:"add",size:"sm",color:"primary",onClick:i=>X(t.row)},null,8,["onClick"])])]),_:2},1032,["props"])]),"body-cell-total":a(t=>[e(S,{props:t,class:"text-center"},{default:a(()=>[p(" $"+n((t.row.pivot.amount*t.row.pivot.price).toFixed(2)),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1}),e(j,{class:"justify-between items-center"},{default:a(()=>[e(U,{modelValue:c.value.val,"onUpdate:modelValue":l[5]||(l[5]=t=>c.value.val=t),options:c.value.opts,label:"Impresora",outlined:"",dense:"",style:{"min-width":"200px"},"option-label":"name"},null,8,["modelValue","options"]),r("div",null,[e(m,{flat:"",color:"negative",label:"Cancelar Pedido",onClick:Z}),e(m,{unelevated:"",color:"primary",label:"Finalizar Pedido",onClick:ee,disable:!c.value.val||d(s).order.products.reduce((t,i)=>t+Number(i.pivot.amount),0)<=0},null,8,["disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}};export{wt as default};

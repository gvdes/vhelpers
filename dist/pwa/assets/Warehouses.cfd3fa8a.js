import{Q as L}from"./QToolbarTitle.031605b4.js";import{Q as B}from"./QToolbar.de2d017f.js";import{b as h}from"./QList.985dae21.js";import{Q as C}from"./QSelect.f32eddcd.js";import{u as D,r as f,c as p,o as I,d as P,w as b,e as i,ak as M,Q as y}from"./index.acb33d1b.js";import{Q as U}from"./axios.890361f7.js";import{Q as F}from"./QCard.bc61e47d.js";import{Q as W}from"./QTable.2d4dd908.js";import{Q as j}from"./QPage.7b2b59b2.js";import{r as N}from"./reportApi.65fc7182.js";import{u as G}from"./use-quasar.09ab3f1b.js";import"./jspdf.plugin.autotable.ce083cdf.js";import{E as K}from"./exceljs.min.9e24d01d.js";import"./JsBarcode.cb858474.js";import"./browser.c61f550a.js";import{d as o}from"./dayjs.min.cbcf888d.js";import"./QLinearProgress.dea54f45.js";import"./QCheckbox.4f88f243.js";import"./_commonjsHelpers.88e99c8f.js";const pe={__name:"Warehouses",setup(q){D();const w=G(),t=f({all:[],seccion:{val:[]},familias:{val:[]},categories:{val:[]}});f({opts:[],val:null}),f({opts:[],val:null}),f("");const E=f(!1),u=f([]),T=f([{name:"code",label:"CODIGO",field:e=>e.code,align:"left"},{name:"description",label:"DESCRIPCION",field:e=>e.description,align:"left"},{name:"barcode",label:"CB",field:e=>e.barcode,align:"left"},{name:"section",label:"SECCION",field:e=>e.category.familia.seccion.name,align:"left"},{name:"family",label:"FAMILIA",field:e=>e.category.familia.name,align:"left"},{name:"category",label:"CATEGORIA",field:e=>e.category.name,align:"left"},{name:"mennav",label:"MEDNAV/PERS",field:e=>e.large,align:"left"},{name:"provider",label:"PROVEEDOR",field:e=>e.providers.name,align:"left"},{name:"maker",label:"FABRICANTE",field:e=>{var a;return(a=e.makers)==null?void 0:a.name},align:"left"},{name:"pxc",label:"PXC",field:e=>e.pieces,align:"center"},{name:"ultfch",label:"ULT FECH LL",field:e=>e.purchases.length>0?o(e.purchases.reduce((a,l)=>new Date(l.created_at)>new Date(a)?l.created_at:a,0)).format("YYYY-MM-DD"):null,align:"center"},{name:"purchases",label:"COMPRAS",field:e=>e.purchases.length>0?e.purchases.reduce((a,l)=>a+Number(l.pivot.amount),0):null,align:"center"},{name:"totalpurchases",label:"TC_$",field:e=>e.purchases.length>0?e.purchases.reduce((a,l)=>a+Number(l.pivot.total),0):null,align:"center"},{name:`sales${Number(o().format("YYYY"))-1}`,label:`VENTAS ${o().format("YYYY")-1}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")==o().format("YYYY")-1?a+Number(l.pivot.amount):a,0):null,align:"center"},{name:`totalsales${Number(o().format("YYYY"))-1}`,label:`TV_$ ${o().format("YYYY")-1}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")==o().format("YYYY")-1?a+Number(l.pivot.total):a,0):null,align:"center"},{name:`sales${o().year}`,label:`VENTAS ${o().format("YYYY")}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")===o().format("YYYY")?a+Number(l.pivot.amount):a,0):null,align:"center"},{name:`totalsales${o().year}`,label:`TV_$ ${o().format("YYYY")}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")===o().format("YYYY")?a+Number(l.pivot.total):a,0):null,align:"center"},{name:"stock",label:"STOCK",field:e=>e.stocks.length>0?e.stocks.reduce((a,l)=>a+Number(l.pivot.stock)+Number(l.pivot.fdt),0):null,align:"center"},{name:"totalstock",label:"STOCK_$",field:e=>e.stocks.length>0?e.stocks.reduce((a,l)=>a+Number(l.pivot.stock)+Number(l.pivot.fdt),0)*e.cost:null,align:"center"}]),_=p(()=>u.value.length===0?[]:u.value[0].stocks.map(a=>({name:a.alias.toLowerCase(),label:a.alias,field:l=>{const s=l.stocks.find(n=>n.alias===a.alias);return s?Number(s.pivot.stock)+Number(s.pivot.fdt):0},align:"center"}))),S=p(()=>u.value.length===0?[]:u.value[0].prices.map(a=>({name:a.alias.toLowerCase(),label:a.name,field:l=>{const s=l.prices.find(n=>n.alias===a.alias);return s?s.pivot.price:0},align:"center"}))),V=p(()=>{if(u.value.length===0)return[];u.value[0];const e=[];return u.value.forEach(a=>{a.sales.forEach(l=>{var n;const s=(n=l.cash_register)==null?void 0:n.workpoint;s&&s.active===1&&!e.find(r=>r.id===s.id)&&e.push(s)})}),e.map(a=>({name:`sales_${a.alias}`,label:`Ventas ${a.alias}`,field:l=>l.sales.reduce((s,n)=>{var r,k;return((k=(r=n.cash_register)==null?void 0:r.workpoint)==null?void 0:k.id)===a.id&&o(n.created_at).format("YYYY")===o().format("YYYY")?s+Number(n.pivot.amount):s},0),align:"center"}))}),v=p(()=>({pagination:{rowsPerPage:10},columns:[...T.value,..._.value,...V.value,{id:"cost",label:"COSTO",field:e=>e.cost},...S.value]})),Q=p(()=>t.value.all.filter(e=>e.deep==0)),A=p(()=>t.value.seccion.val.length>0?t.value.all.filter(e=>e.deep==1&&t.value.seccion.val.map(a=>a.id).includes(e.root)):t.value.all.filter(e=>e.deep==1)),O=p(()=>{if(t.value.seccion.val.length>0&&t.value.familias.val.length==0){let e=t.value.all.filter(a=>a.deep==1&&t.value.seccion.val.map(l=>l.id).includes(a.root)).map(a=>a.id);return t.value.all.filter(a=>a.deep==2&&e.includes(a.root))}else return t.value.familias.val.length>0?t.value.all.filter(e=>e.deep==2&&t.value.familias.val.map(a=>a.id).includes(e.root)):t.value.all.filter(e=>e.deep==2)}),$=async()=>{w.loading.show({message:"Obteniendo Familias"});const e=await N.init();e.fail?(console.log(e),w.loading.hide()):(console.log(e),t.value.all=e,w.loading.hide())},x=async()=>{var l,s,n;let e={sections:(l=t.value.seccion.val)==null?void 0:l.map(r=>r.id),familys:(s=t.value.familias.val)==null?void 0:s.map(r=>r.id),categories:(n=t.value.categories.val)==null?void 0:n.map(r=>r.id)};console.log(e);const a=await N.reportWarehouses(e);a.fail,console.log(a)},R=async()=>{const e=new K.Workbook,a=e.addWorksheet("Almacenes"),l=v.value.columns.map(c=>({header:c.label,key:c.name,width:15}));a.columns=l;const n=u.value.map(c=>{const m={};return v.value.columns.forEach(d=>{let g;typeof d.field=="function"?g=d.field(c):g=c[d.field],m[d.name]=g}),m}).map(c=>v.value.columns.map(m=>c[m.name]));a.addTable({name:"AlmacenesTable",ref:"A1",headerRow:!0,style:{theme:"TableStyleMedium9",showRowStripes:!0},columns:v.value.columns.map(c=>({name:c.label,filterButton:!0})),rows:n}),a.columns.forEach(c=>{let m=0;c.eachCell({includeEmpty:!0},d=>{const g=d.value?d.value.toString().length:10;g>m&&(m=g)}),c.width=m<10?10:m});const r=await e.xlsx.writeBuffer(),k=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),Y=document.createElement("a");Y.href=URL.createObjectURL(k),Y.download="almacenes.xlsx",document.body.appendChild(Y),Y.click(),document.body.removeChild(Y)};return $(),(e,a)=>(I(),P(j,{padding:""},{default:b(()=>[i(B,null,{default:b(()=>[i(L,null,{default:b(()=>a[3]||(a[3]=[M(" ALMACENES ")])),_:1})]),_:1}),i(h),i(F,{class:"my-card"},{default:b(()=>[i(U,{class:"row"},{default:b(()=>[i(C,{class:"col",modelValue:t.value.seccion.val,"onUpdate:modelValue":a[0]||(a[0]=l=>t.value.seccion.val=l),options:Q.value,label:"Seccion",filled:"",dense:"","option-label":"name",multiple:"","use-chips":""},null,8,["modelValue","options"]),i(h,{spaced:"",inset:"",vertical:"",dark:""}),i(C,{class:"col",modelValue:t.value.familias.val,"onUpdate:modelValue":a[1]||(a[1]=l=>t.value.familias.val=l),options:A.value,label:"Familia",filled:"",dense:"","option-label":"name",multiple:"","use-chips":"",disable:t.value.seccion.val.length==0},null,8,["modelValue","options","disable"]),i(h,{spaced:"",inset:"",vertical:"",dark:""}),i(C,{class:"col",modelValue:t.value.categories.val,"onUpdate:modelValue":a[2]||(a[2]=l=>t.value.categories.val=l),options:O.value,label:"Categoria",filled:"",dense:"","option-label":"name",multiple:"","use-chips":"",disable:t.value.seccion.val.length==0||t.value.familias.val.length==0},null,8,["modelValue","options","disable"]),i(h,{spaced:"",inset:"",vertical:"",dark:""}),i(y,{color:"primary",label:t.value.seccion.val.length>0?"Obtener":"Todos",flat:"",onClick:x},null,8,["label"])]),_:1})]),_:1}),i(h,{spaced:"",inset:"",vertical:"",dark:""}),i(W,{rows:u.value,pagination:v.value.pagination,loading:E.value,columns:v.value.columns},{"top-right":b(()=>[i(y,{disable:u.value.value,color:"primary",icon:"download",flat:"",onClick:R},null,8,["disable"])]),_:1},8,["rows","pagination","loading","columns"])]),_:1}))}};export{pe as default};

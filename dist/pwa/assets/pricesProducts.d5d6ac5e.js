import{Q as le}from"./QToolbarTitle.cb82c49b.js";import{b as A,Q as I,a as T,d as z,e as O}from"./QList.2ac5eca7.js";import{u as ne,r as E,o as S,d as M,w as t,e,Q as j,b6 as N,f as p,ak as c,a0 as v,a4 as se,g as U,a2 as Y,a3 as $}from"./index.e40eb483.js";import{Q as ie}from"./QToolbar.6f6e5304.js";import{Q as H}from"./QSpace.d2a6ccbf.js";import{Q as W}from"./QTable.ed50ebb3.js";import{Q as q,a as R}from"./axios.a2d28419.js";import{Q as J}from"./QCardActions.5acea791.js";import{a as y}from"./QSelect.d08658eb.js";import{Q as re}from"./QPage.3fa3f222.js";import{C as de}from"./ClosePopup.8fedccbb.js";import{E as K}from"./exceljs.min.9e24d01d.js";import{u as ce}from"./use-quasar.d56e8514.js";import{d as ue}from"./dayjs.min.cbcf888d.js";import{p as G}from"./productsApi.a979503a.js";import{u as me}from"./ProductsStore.d4fc0859.js";import"./QLinearProgress.53268299.js";import"./QCheckbox.fc5dbcf1.js";import"./_commonjsHelpers.88e99c8f.js";const fe={class:"text-caption"},pe={class:"text-bold"},ye={class:"row"},ge={class:"col"},be={class:"col"},Ie={__name:"pricesProducts",setup(ve){const D=ce(),X=ne();me().setTitle("Modificacion de Precios");const V=E(null),C=E([]),w=E({data:[],state:!1}),_=E({state:!1,data:null}),f=E({state:!1,autor:X.session.credentials,nameDoc:null,date:null}),Z=E({columns:[{name:"code",label:"C\xF3digo",field:"code",align:"left"},{name:"description",label:"Descripci\xF3n",field:"description",align:"left"},{name:"section",label:"Section",field:"section",align:"left"},{name:"family",label:"Familia",field:"family",align:"left"},{name:"category",label:"Categoria",field:"category",align:"left"},{name:"priceFamil",label:"PFamilia",field:"familia",align:"left"},{name:"cost",label:"Costo",field:"cost",align:"right"},{name:"aaa",label:"AAA",field:"aaa",align:"right"},{name:"centro",label:"Centro",field:"centro",align:"right"},{name:"especial",label:"Especial",field:"especial",align:"right"},{name:"caja",label:"Caja",field:"caja",align:"right"},{name:"docena",label:"Docena",field:"docena",align:"right"},{name:"mayoreo",label:"Mayoreo",field:"mayoreo",align:"right"},{name:"menudeo",label:"Menudeo",field:"menudeo",align:"right"}]}),ee=()=>{V.value.click()},ae=async()=>{D.loading.show({message:"Cargando Archivo"}),C.value=[],w.value=[];const g=document.getElementById("inputFile").files[0],o=new K.Workbook,l={MODELO:"code",FAMILIA:"familia",COSTO:"cost",AAA:"aaa",CENTRO:"centro",ESPECIAL:"especial",CAJA:"caja",DOCENA:"docena",MAYOREO:"mayoreo",MENUDEO:"menudeo"};await o.xlsx.load(g);const n=o.worksheets[0],u=n.getRows(1,n.rowCount);if(!u)return;let B=[];const i=[],r=[];for(let a=0;a<u.length;a++){const h=u[a].values.slice(1);if(h.every(s=>s==null||s.toString().trim()===""))continue;if(a===0){B=h.map(s=>s==null?void 0:s.toString().trim());continue}const x={};for(let s=0;s<B.length;s++){const Q=l[B[s]];if(Q){let d=h[s];typeof d=="string"&&(d=d.trim()),typeof d=="number"&&(d=Q==="cost"?parseFloat(d.toFixed(2)):Math.round(d)),x[Q]=d!=null?d:null}}x.code&&(i.push(x.code),r.push(x))}const k=await G.lookupProducts({codes:i}),m=[],P=[];for(const a of r){const b=k.products.find(s=>s.code===a.code);if(!b){P.push({...a,error:"Producto no encontrado"});continue}if(a.menudeo==null&&a.mayoreo!=null){console.log(b);const s=b.category.familia.alias||"";s==="MBP"?a.menudeo=a.mayoreo+20:s==="MLB"||s==="MPC"?a.menudeo=a.mayoreo+10:a.mayoreo===a.centro?a.menudeo=a.caja:a.mayoreo>=0&&a.mayoreo<=49?a.menudeo=a.mayoreo+5:a.mayoreo>=50&&a.mayoreo<=99?a.menudeo=a.mayoreo+10:a.mayoreo>=100&&a.mayoreo<=499?a.menudeo=a.mayoreo+20:a.mayoreo>=500&&a.mayoreo<=999?a.menudeo=a.mayoreo+50:a.mayoreo>=1e3&&(a.menudeo=a.mayoreo+100)}const h={...a,id:b.id,description:b.description||"",section:b.category.familia.seccion.name||"",family:b.category.familia.name||"",category:b.category.name||""},F=["cost","aaa","centro","especial","caja","docena","mayoreo","menudeo"];let x=!0;for(let s=0;s<F.length-1;s++){const Q=h[F[s]],d=h[F[s+1]];if(Q!=null&&d!=null&&Q>d){x=!1;break}}x?m.push(h):P.push({...h,error:"Validaci\xF3n de precios fallida"})}C.value=m,w.value.data=P,w.value.data.length>0&&(w.value.state=!0),f.value.state=!0,f.value.nameDoc=g.name,f.value.date=ue().format("YYYY-MM-DD HH:mm:ss"),D.loading.hide()},oe=async()=>{D.loading.show({message:"Insertando datos"});const g=C.value.map(n=>({_product:n.id,code:n.code,costo:n.cost,familia:n.familia,prices:{7:n.aaa,6:n.centro,5:n.especial,4:n.caja,3:n.docena,2:n.mayoreo,1:n.menudeo}})),o={head:f.value,data:g};console.log(o);const l=await G.highPrices(o);console.log(l),l.fail?console.log(l):(console.log(l),_.value.state=!0,_.value.data=l,D.loading.hide())},L=g=>{console.log(g);const o=new K.Workbook,l=o.addWorksheet("Reporte"),n=Object.keys(g[0]).map(i=>i),u=n.map((i,r)=>{const k=r===n.length-1;return{name:i.toUpperCase(),filterButton:!0,totalsRowFunction:k?"sum":void 0}});l.addTable({name:"ReporteAlta",ref:"A1",headerRow:!0,style:{showRowStripes:!0},columns:u,rows:g.map(i=>n.map(r=>i[r]))}),l.columns.forEach(i=>{let r=0;i.eachCell({includeEmpty:!0},k=>{const m=k.value?k.value.toString().length:10;m>r&&(r=m)}),i.width=r<10?10:r}),(async()=>{const i=await o.xlsx.writeBuffer(),r=new Blob([i],{type:"application/octet-stream"}),k=URL.createObjectURL(r),m=document.createElement("a");m.href=k,m.download="Reporte.xlsx",document.body.appendChild(m),m.click(),document.body.removeChild(m)})()},te=()=>{window.location.reload()};return(g,o)=>(S(),M(re,{padding:""},{default:t(()=>[e(ie,null,{default:t(()=>[e(le),e(A,{spaced:"",inset:"",vertical:"",dark:""}),e(j,{flat:"",round:"",dense:"",icon:"upload_file",size:"lg",onClick:ee,title:"Subir Archivo",disable:f.value.state},null,8,["disable"]),e(j,{flat:"",round:"",dense:"",icon:"download",size:"lg",onClick:o[0]||(o[0]=l=>L(C.value)),title:"Descargar Archivo",disable:C.value.length==0},null,8,["disable"])]),_:1}),e(W,{rows:C.value,columns:Z.value.columns},N({_:2},[f.value.state?{name:"top",fn:t(()=>[p("div",null,[p("div",fe,[c(v(f.value.autor.staff.complete_name)+" ",1),e(A),c(" "+v(f.value.date),1)]),p("div",pe,v(f.value.nameDoc),1)]),e(H),e(j,{color:"primary",icon:"cloud_sync",flat:"",onClick:oe})]),key:"0"}:void 0]),1032,["rows","columns"]),e(I,{modelValue:w.value.state,"onUpdate:modelValue":o[2]||(o[2]=l=>w.value.state=l),persistent:""},{default:t(()=>[e(q,null,{default:t(()=>[e(R,null,{default:t(()=>[e(W,{rows:w.value.data},N({_:2},[f.value.state?{name:"top",fn:t(()=>[o[4]||(o[4]=p("div",{class:"text-bold text-h6"}," Errores ",-1)),e(H),e(j,{color:"primary",icon:"download",flat:"",onClick:o[1]||(o[1]=l=>L(w.value.data))})]),key:"0"}:void 0]),1032,["rows"])]),_:1}),e(J,{align:"right"},{default:t(()=>[se(e(j,{flat:"",label:"OK",color:"primary"},null,512),[[de]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(I,{modelValue:_.value.state,"onUpdate:modelValue":o[3]||(o[3]=l=>_.value.state=l),persistent:""},{default:t(()=>[e(q,{style:{width:"600px","max-width":"80vw"}},{default:t(()=>[e(R,{class:"text-center text-bold text-h6"},{default:t(()=>[c(" Actualizados Base "+v(_.value.data.mysql.update.goal.length),1)]),_:1}),e(R,null,{default:t(()=>[p("div",ye,[p("div",ge,[o[8]||(o[8]=p("span",{class:"text-center text-bold"},"Correcto",-1)),e(A,{spaced:"",inset:"",vertical:"",dark:""}),e(T,{bordered:""},{default:t(()=>[(S(!0),U($,null,Y(_.value.data.sucursales.update.goal,(l,n)=>(S(),M(z,{key:n},{default:t(()=>[e(O,null,{default:t(()=>[e(y,{caption:""},{default:t(()=>o[5]||(o[5]=[c("Sucursal")])),_:1}),e(y,null,{default:t(()=>[c(v(Object.keys(l)[0]),1)]),_:2},1024)]),_:2},1024),e(O,null,{default:t(()=>{var u;return[e(y,{caption:""},{default:t(()=>o[6]||(o[6]=[c("Bien")])),_:1}),e(y,{title:`${(u=l[Object.keys(l)[0]].actualizados.goals)==null?void 0:u.join("/")}`},{default:t(()=>[c(v(l[Object.keys(l)].actualizados.goals.length),1)]),_:2},1032,["title"])]}),_:2},1024),e(O,null,{default:t(()=>{var u;return[e(y,{caption:""},{default:t(()=>o[7]||(o[7]=[c("Error")])),_:1}),e(y,{title:`${(u=l[Object.keys(l)[0]].actualizados.fails)==null?void 0:u.join("/")}`},{default:t(()=>[c(v(l[Object.keys(l)].actualizados.fails.length),1)]),_:2},1032,["title"])]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),e(A,{spaced:"",inset:"",vertical:"",dark:""}),p("div",be,[o[11]||(o[11]=p("span",{class:"text-center text-bold"},"Errores",-1)),e(A,{spaced:"",inset:"",vertical:"",dark:""}),e(T,{bordered:""},{default:t(()=>[(S(!0),U($,null,Y(_.value.data.sucursales.update.fails,(l,n)=>(S(),M(z,{key:n},{default:t(()=>[e(O,null,{default:t(()=>[e(y,{caption:""},{default:t(()=>o[9]||(o[9]=[c("Sucursal")])),_:1}),e(y,null,{default:t(()=>[c(v(Object.keys(l)[0]),1)]),_:2},1024)]),_:2},1024),e(O,null,{default:t(()=>[e(y,{caption:""},{default:t(()=>o[10]||(o[10]=[c("Sucursal")])),_:1}),e(y,null,{default:t(()=>[c(v(Object.values(l)[0]),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])])]),_:1}),e(J,{align:"right"},{default:t(()=>[e(j,{flat:"",label:"OK",color:"primary",onClick:te})]),_:1})]),_:1})]),_:1},8,["modelValue"]),p("input",{type:"file",ref_key:"inputFile",ref:V,id:"inputFile",onInput:ae,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1}))}};export{Ie as default};

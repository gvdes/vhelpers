import{W as le,a as oe,u as ae,r as b,o as v,d as h,w as d,k as B,g as s,e as l,a4 as p,j as k,_ as n,Q as P,f,a1 as V,i as D,$ as O,a0 as z,Y as _,a2 as j,aV as E,a3 as U,ae as ie,bN as de}from"./index.5a92cc75.js";import{d as ne,Q as N}from"./QSelect.b6220e71.js";import{Q as re}from"./QExpansionItem.41f6d994.js";import{Q as ue}from"./QList.7902a402.js";import{Q as R}from"./QFooter.fb2eab2a.js";import{Q as pe}from"./QPage.db03b36e.js";import{C as T}from"./ClosePopup.7a8a9cc5.js";import"./dayjs.min.cbcf888d.js";import"./axios.36a303a2.js";import{P as ce}from"./ProductsAutocomplete.95d5afb3.js";import{_ as ve}from"./productView.401a15c8.js";import{o as M}from"./orderApi.e01bfb14.js";import{u as me}from"./OrderStore.237c5b77.js";import{u as fe}from"./use-quasar.317cf8ee.js";import{$sktOrders as _e}from"./socket.168d2ba4.js";import"./QResizeObserver.a3f95062.js";import"./_commonjsHelpers.88e99c8f.js";/* empty css                                                                         */import"./QSpace.4de7e916.js";import"./resoursesOrder.ac3a0f3a.js";const xe={class:"row items-center justify-between bg-primary text-white q-py-xs q-px-sm"},ye={class:"row items-center col"},ge={class:"q-pa-xs col text-center"},be={class:"text-body2 text-bold"},we={class:"q-pa-xs col text-center"},he={class:"text-body2 text-bold"},ke={class:"row items-center justify-between q-mt-xs"},Ve={class:"row text-center"},Ce={class:"q-px-md col"},Qe={class:"text-body2 text-bold"},qe={class:"q-px-md col"},Pe={class:"text-body2 text-bold"},$e={class:"q-px-md col"},Ie={class:"text-body2 text-bold"},Se={class:"row full-width items-center justify-between q-py-sm"},Fe={class:"text-bold"},Be=["onClick"],De={class:"row items-center"},Ue={class:"col q-pr-sm"},Ae={class:"row items-center justify-between"},Oe={class:"text-caption text-right text-grey-6"},ze={class:"text--2 text-grey-6"},je={class:"col text--2 text-caption"},Ee={class:"text--2 text-amber-13"},Ne={class:"text-right"},Re={class:"text-caption text-bold"},Te={class:"text-caption"},Me={class:"text-bold text-red"},Le={class:"row q-ml-sm"},vt={__name:"Viewpreorders",setup(We){const L=le(),S=oe(),u=me();u.setshowLyt(!1);const m=fe(),C=ae(),i=b(null),W=b({opts:[],val:null}),r=b({state:!1,val:null,edit:!1}),x=b({state:!1,notfound:[],added:[]}),G=b(null),Q=b({amount:1,amountDelivered:0,price:0,toDelivered:0,total:0,units:1,_price_list:1,_supply_by:1}),$=b({state:!1,val:null,opts:[]}),J=async()=>{m.loading.show({message:"Obtenidendo datos"});let a={pedido:L.params.oid,store:C.session.store.id_viz,uid:C.session.credentials.staff.id_va,_rol:C.session.credentials._rol};const e=await M.getOrderPrv(a);e.fail?(console.log(e),(e.fail.status==401||e.fail.status==404)&&(m.notify({message:e.fail.response.data.mssg,type:"negative",position:"top"}),S.push("/preorders/pedidos"))):(console.log(e),i.value=e,m.loading.hide())},K=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(r.value.val=i.value.products[e],r.value.state=!0,r.value.edit=!0):(Q.value._supply_by=u.units.val.id,a.pivot={...Q.value},console.log(a.pivot),a.units=u.units.val,r.value.val=a,r.value.state=!0,r.value.edit=!1)},Y=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(r.value.val=i.value.products[e],r.value.state=!0,r.value.edit=!0):(Q.value._supply_by=u.units.val.id,a.pivot={...Q.value},console.log(a.pivot),a.units=u.units.val,r.value.val=a,r.value.state=!0,r.value.edit=!1)},F=()=>{r.value={state:!1,val:null,edit:!1},Q.value._supply_by=1},H=a=>{i.value.products.push(a),F()},X=a=>{let e=i.value.products.findIndex(t=>t.id==a.id);e>=0&&(i.value.products.splice(e,1),F())},Z=a=>{console.log(a),console.log(W.value),a.units=u.units.opts.find(e=>e.id==a.pivot._supply_by),r.value.val=a,r.value.state=!0,r.value.edit=!0},ee=async()=>{let a=document.getElementById("inputFile").files[0],e=new ExcelJS.Workbook,t={};e.xlsx.load(a).then(async w=>{let o=e.worksheets[0],y=o.getColumn("A");o.getColumn("B"),y.eachCell({includeEmpty:!0},function(g,c){if(c===1)return;let I=g.value,se=o.getCell(`B${c}`),A=parseFloat(se.value);I&&(t[I]?t[I]+=A:t[I]=A)});let q=Object.keys(t).map(g=>({codigo:g,cantidad:t[g]}));if(q.length){let g={codes:q,_requisition:i.value.id};m.loading.show({message:"Procesando archivo, espera.."}),console.log(g);const c=await RestockApi.addMassiveProducts(g);c.fail?console.log(c):(console.log(c),i.value.products=c.products,x.value.state=!0,x.value.added=c.products,x.value.notfound=c.notFound,m.loading.hide())}else m.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},te=async()=>{m.loading.show({message:"Mandando Pedido"});let a={id:i.value.id,_printer:u.printers.val};console.log(a);const e=await M.nextStepPrv(a);if(e.fail)console.log(e);else{console.log(e);let t={order:e.order,newstate:e.status};console.log(t),_e.emit("order_update",t),u.addOrUpdate(t),S.push("/preorders/pedidos"),m.loading.hide()}};return J(),(a,e)=>i.value?(v(),h(pe,{key:0,padding:""},{default:d(()=>[s("div",xe,[l(k,{onClick:e[0]||(e[0]=t=>p(S).push("/preorders/pedidos")),dense:"",flat:"",icon:"close",color:"white"}),s("div",ye,[s("div",ge,[e[7]||(e[7]=s("div",{class:"text-caption"},"Folio:",-1)),s("div",be,n(i.value.id),1)]),s("div",we,[e[8]||(e[8]=s("div",{class:"text-caption"},"Cliente:",-1)),s("div",he,n(i.value.name),1)])]),l(k,{icon:"settings",dense:"",flat:""},{default:d(()=>[l(ne,{style:{width:"100%"}},{default:d(()=>[l(P,null,{default:d(()=>[l(f,{class:"q-pa-sm"},{default:d(()=>[l(N,{modelValue:p(u).units.val,"onUpdate:modelValue":e[1]||(e[1]=t=>p(u).units.val=t),options:p(u).units.opts,label:"Pedir Por",filled:"","option-label":"name",dense:"",disable:i.value._status!=1},null,8,["modelValue","options","disable"])]),_:1}),l(f,null,{default:d(()=>[s("div",ke,[s("div",Ve,[s("div",Ce,[e[9]||(e[9]=s("div",{class:"text-caption"},"Modelos",-1)),s("span",Qe,n(i.value.products.length),1)]),s("div",qe,[e[10]||(e[10]=s("div",{class:"text-caption"},"Unidades",-1)),s("span",Pe,n(i.value.products.reduce((t,w)=>t+Number(w.pivot.units),0)),1)]),s("div",$e,[e[11]||(e[11]=s("div",{class:"text-caption"},"Total",-1)),s("span",Ie," $ "+n(i.value.products.reduce((t,w)=>t+Number(w.pivot.total),0)),1)])])])]),_:1})]),_:1})]),_:1})]),_:1})]),l(V),(v(!0),D(z,null,O(p(u).units.opts,(t,w)=>(v(),h(ue,{bordered:"",key:w},{default:d(()=>[i.value.products.filter(o=>o.pivot._supply_by==t.id).length?(v(),h(re,{key:0,"expand-separator":"","default-opened":"","header-class":"text-bold","expand-icon-class":"hidden"},{header:d(()=>[s("div",Se,[s("div",null,[_(n(t.name.toUpperCase())+" - "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).length)+" productos ",1),l(ie,{name:"fas fa-caret-right"}),_(" "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.units,0))+" pzs ",1)]),s("div",Fe,"$ "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.total,0)),1)])]),default:d(()=>[l(V),l(de,{appear:"","enter-active-class":"animated zoomIn","leave-active-class":"animated zoomOut"},{default:d(()=>[(v(!0),D(z,null,O(i.value.products.filter(o=>o.pivot._supply_by==t.id),(o,y)=>(v(),D("div",{key:y,class:"q-py-md q-px-sm wrapper_prod",onClick:q=>Z(o)},[s("div",De,[s("div",Ue,[s("div",Ae,[s("div",null,[s("span",null,n(o.code),1),e[12]||(e[12]=_(" -- ")),s("span",null,n(o.name),1)]),s("span",Oe,n(o.category.familia.name)+" (pxc "+n(o.pieces)+")",1)]),e[13]||(e[13]=s("div",{class:"text--3 text-uppercase text-italic"},null,-1)),s("div",ze,n(o.description),1),s("div",je,n(o._supply_by!=1?`(${o.pivot.units} pzs)`:"")+", PU: $"+n(o.pivot.price),1),s("div",Ee,n(o.pivot.comments),1)]),s("div",Ne,[s("div",Re,"$ "+n(o.pivot.total),1),s("div",Te,n(o.prices.find(q=>q.id==o.pivot._price_list).name),1)])]),l(V)],8,Be))),128))]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1024))),128)),l(U,{modelValue:$.value.state,"onUpdate:modelValue":e[3]||(e[3]=t=>$.value.state=t),persistent:""},{default:d(()=>[l(P,null,{default:d(()=>[l(f,{class:"row items-center bg-primary text-white text-h6"},{default:d(()=>e[14]||(e[14]=[_(" Selecciona Impresora ")])),_:1}),l(f,{class:""},{default:d(()=>[l(N,{modelValue:p(u).printers.val,"onUpdate:modelValue":e[2]||(e[2]=t=>p(u).printers.val=t),options:p(u).printers.opts.filter(t=>t._type==1),label:"Impresoras","option-label":"name",filled:""},null,8,["modelValue","options"])]),_:1}),l(j,{align:"right"},{default:d(()=>[E(l(k,{flat:"",label:"Cancelar",color:"primary"},null,512),[[T]]),l(k,{flat:"",label:"Terminar",color:"primary",onClick:te,disabled:!p(u).printers.val},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:r.value.state,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.state=t),persistent:"",position:"bottom"},{default:d(()=>[l(ve,{product:r.value.val,order:i.value,edit:r.value.edit,onReset:F,products:i.value.products,rules:p(u).rules,onAddProduct:H,onDeleteProduct:X,units:p(u).units.opts,unit:p(u).units.val},null,8,["product","order","edit","products","rules","units","unit"])]),_:1},8,["modelValue"]),l(U,{modelValue:x.value.state,"onUpdate:modelValue":e[5]||(e[5]=t=>x.value.state=t),persistent:""},{default:d(()=>[l(P,null,{default:d(()=>[l(f,{class:"text-center text-h5 text-bold"},{default:d(()=>e[15]||(e[15]=[_(" Resultados de Importacion ")])),_:1}),l(f,{class:"text-centet text-h6 text-bold"},{default:d(()=>[_(" Correctos: "+n(x.value.added.length),1)]),_:1}),l(f,null,{default:d(()=>[e[16]||(e[16]=_(" Modelos sin Coincidencia: ")),s("span",Me,n(x.value.notfound),1)]),_:1}),l(j,{align:"right"},{default:d(()=>[E(l(k,{flat:"",label:"OK",color:"primary"},null,512),[[T]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i.value._status==1?(v(),h(R,{key:0,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",Le,[l(P,{class:"col"},{default:d(()=>[l(ce,{checkState:!0,onInput:Y,with_prices:"",onAgregar:K,"workpoint-status":[1,2,p(C).session.store.id_viz],wkpToVal:p(C).session.store.id_viz},null,8,["workpoint-status","wkpToVal"])]),_:1}),l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",null,[i.value.products.length>0?(v(),h(k,{key:0,flat:"",icon:"send",onClick:e[6]||(e[6]=t=>$.value.state=!$.value.state)})):B("",!0)])]),l(V,{spaced:"",inset:"",vertical:"",dark:""})]),_:1})):(v(),h(R,{key:1,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(P,{class:"my-card"},{default:d(()=>[l(f,{class:"text-center text-bold bg-primary"},{default:d(()=>e[17]||(e[17]=[_(" El pedido ya esta terminado :/ ")])),_:1})]),_:1})]),_:1})),s("input",{type:"file",ref_key:"inputFile",ref:G,id:"inputFile",onInput:ee,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1})):B("",!0)}};export{vt as default};

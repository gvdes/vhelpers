import{Q as L}from"./QToolbarTitle.716a7152.js";import{Q as B}from"./QToolbar.fbfe65df.js";import{b as k}from"./QList.01e1304b.js";import{Q as y}from"./QSelect.909b0821.js";import{u as D,r as f,c as p,o as I,d as P,w as Y,e as i,ak as M,Q as N}from"./index.7070277f.js";import{Q as U}from"./axios.97eb91c6.js";import{Q as F}from"./QCard.57aaff64.js";import{Q as W}from"./QTable.b9a063dd.js";import{Q as j}from"./QPage.13cf001b.js";import{r as E}from"./reportApi.1d93ba10.js";import{u as q}from"./use-quasar.64b87885.js";import"./jspdf.plugin.autotable.711d9f80.js";import{E as G}from"./exceljs.min.9e24d01d.js";import"./JsBarcode.cb858474.js";import"./browser.c61f550a.js";import{d as o}from"./dayjs.min.cbcf888d.js";import"./QLinearProgress.bdc661e2.js";import"./QCheckbox.8a9cf3c1.js";import"./_commonjsHelpers.88e99c8f.js";const pe={__name:"Warehouses",setup(K){D();const v=q(),t=f({all:[],seccion:{val:[]},familias:{val:[]},categories:{val:[]}});f({opts:[],val:null}),f({opts:[],val:null}),f("");const C=f(!1),c=f([]),T=f([{name:"code",label:"CODIGO",field:e=>e.code,align:"left"},{name:"description",label:"DESCRIPCION",field:e=>e.description,align:"left"},{name:"barcode",label:"CB",field:e=>e.barcode,align:"left"},{name:"section",label:"SECCION",field:e=>e.category.familia.seccion.name,align:"left"},{name:"family",label:"FAMILIA",field:e=>e.category.familia.name,align:"left"},{name:"category",label:"CATEGORIA",field:e=>e.category.name,align:"left"},{name:"mennav",label:"MEDNAV/PERS",field:e=>e.large,align:"left"},{name:"provider",label:"PROVEEDOR",field:e=>e.providers.name,align:"left"},{name:"maker",label:"FABRICANTE",field:e=>{var a;return(a=e.makers)==null?void 0:a.name},align:"left"},{name:"pxc",label:"PXC",field:e=>e.pieces,align:"center"},{name:"ultfch",label:"ULT FECH LL",field:e=>e.purchases.length>0?o(e.purchases.reduce((a,l)=>new Date(l.created_at)>new Date(a)?l.created_at:a,0)).format("YYYY-MM-DD"):null,align:"center"},{name:"purchases",label:"COMPRAS",field:e=>e.purchases.length>0?e.purchases.reduce((a,l)=>a+Number(l.pivot.amount),0):null,align:"center"},{name:"totalpurchases",label:"TC_$",field:e=>e.purchases.length>0?e.purchases.reduce((a,l)=>a+Number(l.pivot.total),0):null,align:"center"},{name:`sales${Number(o().format("YYYY"))-1}`,label:`VENTAS ${o().format("YYYY")-1}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")==o().format("YYYY")-1?a+Number(l.pivot.amount):a,0):null,align:"center"},{name:`totalsales${Number(o().format("YYYY"))-1}`,label:`TV_$ ${o().format("YYYY")-1}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")==o().format("YYYY")-1?a+Number(l.pivot.total):a,0):null,align:"center"},{name:`sales${o().year}`,label:`VENTAS ${o().format("YYYY")}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")===o().format("YYYY")?a+Number(l.pivot.amount):a,0):null,align:"center"},{name:`totalsales${o().year}`,label:`TV_$ ${o().format("YYYY")}`,field:e=>e.sales.length>0?e.sales.reduce((a,l)=>o(l.created_at).format("YYYY")===o().format("YYYY")?a+Number(l.pivot.total):a,0):null,align:"center"},{name:"stock",label:"STOCK",field:e=>e.stocks.length>0?e.stocks.reduce((a,l)=>a+Number(l.pivot.stock)+Number(l.pivot.fdt),0):null,align:"center"},{name:"totalstock",label:"STOCK_$",field:e=>e.stocks.length>0?e.stocks.reduce((a,l)=>a+Number(l.pivot.stock)+Number(l.pivot.fdt),0)*e.cost:null,align:"center"}]),_=p(()=>c.value.length===0?[]:c.value[0].stocks.map(a=>({name:a.alias.toLowerCase(),label:a.alias,field:l=>{const s=l.stocks.find(n=>n.alias===a.alias);return s?Number(s.pivot.stock)+Number(s.pivot.fdt):0},align:"center"}))),S=p(()=>c.value.length===0?[]:c.value[0].prices.map(a=>({name:a.alias.toLowerCase(),label:a.name,field:l=>{const s=l.prices.find(n=>n.alias===a.alias);return s?s.pivot.price:0},align:"center"}))),V=p(()=>{if(c.value.length===0)return[];c.value[0];const e=[];return c.value.forEach(a=>{a.sales.forEach(l=>{var n;const s=(n=l.cash_register)==null?void 0:n.workpoint;s&&s.active===1&&!e.find(r=>r.id===s.id)&&e.push(s)})}),e.map(a=>({name:`sales_${a.alias}`,label:`Ventas ${a.alias}`,field:l=>l.sales.reduce((s,n)=>{var r,w;return((w=(r=n.cash_register)==null?void 0:r.workpoint)==null?void 0:w.id)===a.id&&o(n.created_at).format("YYYY")===o().format("YYYY")?s+Number(n.pivot.amount):s},0),align:"center"}))}),g=p(()=>({pagination:{rowsPerPage:10},columns:[...T.value,..._.value,...V.value,{id:"cost",label:"COSTO",field:e=>e.cost},...S.value]})),Q=p(()=>t.value.all.filter(e=>e.deep==0)),A=p(()=>t.value.seccion.val.length>0?t.value.all.filter(e=>e.deep==1&&t.value.seccion.val.map(a=>a.id).includes(e.root)):t.value.all.filter(e=>e.deep==1)),O=p(()=>{if(t.value.seccion.val.length>0&&t.value.familias.val.length==0){let e=t.value.all.filter(a=>a.deep==1&&t.value.seccion.val.map(l=>l.id).includes(a.root)).map(a=>a.id);return t.value.all.filter(a=>a.deep==2&&e.includes(a.root))}else return t.value.familias.val.length>0?t.value.all.filter(e=>e.deep==2&&t.value.familias.val.map(a=>a.id).includes(e.root)):t.value.all.filter(e=>e.deep==2)}),$=async()=>{v.loading.show({message:"Obteniendo Familias"});const e=await E.init();e.fail?(console.log(e),v.loading.hide()):(console.log(e),t.value.all=e,v.loading.hide())},x=async()=>{var l,s,n;v.loading.show({message:"El reporte puede tardar unos minutos"}),C.value=!0;let e={sections:(l=t.value.seccion.val)==null?void 0:l.map(r=>r.id),familys:(s=t.value.familias.val)==null?void 0:s.map(r=>r.id),categories:(n=t.value.categories.val)==null?void 0:n.map(r=>r.id)};console.log(e);const a=await E.reportWarehouses(e);a.fail?(console.log(a),v.notify({message:"No se pudo obtener el reporte comuniquese con soporte",type:"negative",position:"center"})):(console.log(a),c.value=a,C.value=!1,v.loading.hide())},R=async()=>{const e=new G.Workbook,a=e.addWorksheet("Almacenes"),l=g.value.columns.map(u=>({header:u.label,key:u.name,width:15}));a.columns=l;const n=c.value.map(u=>{const m={};return g.value.columns.forEach(d=>{let b;typeof d.field=="function"?b=d.field(u):b=u[d.field],m[d.name]=b}),m}).map(u=>g.value.columns.map(m=>u[m.name]));a.addTable({name:"AlmacenesTable",ref:"A1",headerRow:!0,style:{theme:"TableStyleMedium9",showRowStripes:!0},columns:g.value.columns.map(u=>({name:u.label,filterButton:!0})),rows:n}),a.columns.forEach(u=>{let m=0;u.eachCell({includeEmpty:!0},d=>{const b=d.value?d.value.toString().length:10;b>m&&(m=b)}),u.width=m<10?10:m});const r=await e.xlsx.writeBuffer(),w=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=document.createElement("a");h.href=URL.createObjectURL(w),h.download="almacenes.xlsx",document.body.appendChild(h),h.click(),document.body.removeChild(h)};return $(),(e,a)=>(I(),P(j,{padding:""},{default:Y(()=>[i(B,null,{default:Y(()=>[i(L,null,{default:Y(()=>a[3]||(a[3]=[M(" ALMACENES ")])),_:1})]),_:1}),i(k),i(F,{class:"my-card"},{default:Y(()=>[i(U,{class:"row"},{default:Y(()=>[i(y,{class:"col",modelValue:t.value.seccion.val,"onUpdate:modelValue":a[0]||(a[0]=l=>t.value.seccion.val=l),options:Q.value,label:"Seccion",filled:"",dense:"","option-label":"name",multiple:"","use-chips":""},null,8,["modelValue","options"]),i(k,{spaced:"",inset:"",vertical:"",dark:""}),i(y,{class:"col",modelValue:t.value.familias.val,"onUpdate:modelValue":a[1]||(a[1]=l=>t.value.familias.val=l),options:A.value,label:"Familia",filled:"",dense:"","option-label":"name",multiple:"","use-chips":"",disable:t.value.seccion.val.length==0},null,8,["modelValue","options","disable"]),i(k,{spaced:"",inset:"",vertical:"",dark:""}),i(y,{class:"col",modelValue:t.value.categories.val,"onUpdate:modelValue":a[2]||(a[2]=l=>t.value.categories.val=l),options:O.value,label:"Categoria",filled:"",dense:"","option-label":"name",multiple:"","use-chips":"",disable:t.value.seccion.val.length==0||t.value.familias.val.length==0},null,8,["modelValue","options","disable"]),i(k,{spaced:"",inset:"",vertical:"",dark:""}),i(N,{color:"primary",label:t.value.seccion.val.length>0?"Obtener":"Todos",flat:"",onClick:x},null,8,["label"])]),_:1})]),_:1}),i(k,{spaced:"",inset:"",vertical:"",dark:""}),i(W,{rows:c.value,pagination:g.value.pagination,loading:C.value,columns:g.value.columns},{"top-right":Y(()=>[i(N,{disable:c.value.value,color:"primary",icon:"download",flat:"",onClick:R},null,8,["disable"])]),_:1},8,["rows","pagination","loading","columns"])]),_:1}))}};export{pe as default};

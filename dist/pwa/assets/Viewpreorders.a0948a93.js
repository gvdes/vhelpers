import{aW as le,a as oe,u as ae,r as b,o as v,d as h,w as d,h as B,f as s,e as l,a1 as p,Q as k,a0 as n,g as D,a2 as O,a3 as z,al as f,a4 as E,S as ie,bd as de}from"./index.4ec92603.js";import{d as ne,Q as R}from"./QSelect.2fd94609.js";import{Q as _}from"./QCardSection.a5c7acdc.js";import{Q as P}from"./QCard.3d861cc2.js";import{b as V,Q as U,a as re}from"./QList.598a2190.js";import{Q as ue}from"./QExpansionItem.ed933133.js";import{Q as T}from"./QCardActions.3c8cecf8.js";import{Q as j}from"./QFooter.7d2f6059.js";import{Q as pe}from"./QPage.fb2e21ce.js";import{C as M}from"./ClosePopup.df452371.js";import"./dayjs.min.cbcf888d.js";import"./axios.4fbe9239.js";import{P as ce}from"./ProductsAutocomplete.c0235d91.js";import{_ as ve}from"./productView.1cf9e97c.js";import{o as N}from"./orderApi.898acd99.js";import{u as me}from"./OrderStore.f7bf5897.js";import{u as fe}from"./use-quasar.599def75.js";import{$sktOrders as _e}from"./socket.41f46bf6.js";import"./use-key-composition.0a046c6b.js";import"./QResizeObserver.fe7070ea.js";import"./_commonjsHelpers.88e99c8f.js";import"./QInput.e2a1c041.js";/* empty css                                                                         */import"./QSpace.b15b7df5.js";import"./resoursesOrder.f9386f1b.js";const xe={class:"row items-center justify-between bg-primary text-white q-py-xs q-px-sm"},ye={class:"row items-center col"},ge={class:"q-pa-xs col text-center"},be={class:"text-body2 text-bold"},we={class:"q-pa-xs col text-center"},he={class:"text-body2 text-bold"},ke={class:"row items-center justify-between q-mt-xs"},Ve={class:"row text-center"},Qe={class:"q-px-md col"},Ce={class:"text-body2 text-bold"},qe={class:"q-px-md col"},Pe={class:"text-body2 text-bold"},$e={class:"q-px-md col"},Se={class:"text-body2 text-bold"},Ie={class:"row full-width items-center justify-between q-py-sm"},Fe={class:"text-bold"},Be=["onClick"],De={class:"row items-center"},Ue={class:"col q-pr-sm"},Ae={class:"row items-center justify-between"},Oe={class:"text-caption text-right text-grey-6"},ze={class:"text--2 text-grey-6"},Ee={class:"col text--2 text-caption"},Re={class:"text--2 text-amber-13"},Te={class:"text-right"},je={class:"text-caption text-bold"},Me={class:"text-caption"},Ne={class:"text-bold text-red"},Le={class:"row q-ml-sm"},yt={__name:"Viewpreorders",setup(We){const L=le(),I=oe(),u=me();u.setshowLyt(!1);const m=fe(),Q=ae(),i=b(null),W=b({opts:[],val:null}),r=b({state:!1,val:null,edit:!1}),x=b({state:!1,notfound:[],added:[]}),G=b(null),C=b({amount:1,amountDelivered:0,price:0,toDelivered:0,total:0,units:1,_price_list:1,_supply_by:1}),$=b({state:!1,val:null,opts:[]}),J=async()=>{m.loading.show({message:"Obtenidendo datos"});let a={pedido:L.params.oid,store:Q.session.store.id_viz,uid:Q.session.credentials.staff.id_va,_rol:Q.session.credentials._rol};const e=await N.getOrderPrv(a);e.fail?(console.log(e),(e.fail.status==401||e.fail.status==404)&&(m.notify({message:e.fail.response.data.mssg,type:"negative",position:"top"}),I.push("/preorders/pedidos"))):(console.log(e),i.value=e,m.loading.hide())},K=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(r.value.val=i.value.products[e],r.value.state=!0,r.value.edit=!0):(C.value._supply_by=u.units.val.id,a.pivot={...C.value},console.log(a.pivot),a.units=u.units.val,r.value.val=a,r.value.state=!0,r.value.edit=!1)},H=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(r.value.val=i.value.products[e],r.value.state=!0,r.value.edit=!0):(C.value._supply_by=u.units.val.id,a.pivot={...C.value},console.log(a.pivot),a.units=u.units.val,r.value.val=a,r.value.state=!0,r.value.edit=!1)},F=()=>{r.value={state:!1,val:null,edit:!1},C.value._supply_by=1},X=a=>{i.value.products.push(a),F()},Y=a=>{let e=i.value.products.findIndex(t=>t.id==a.id);e>=0&&(i.value.products.splice(e,1),F())},Z=a=>{console.log(a),console.log(W.value),a.units=u.units.opts.find(e=>e.id==a.pivot._supply_by),r.value.val=a,r.value.state=!0,r.value.edit=!0},ee=async()=>{let a=document.getElementById("inputFile").files[0],e=new ExcelJS.Workbook,t={};e.xlsx.load(a).then(async w=>{let o=e.worksheets[0],y=o.getColumn("A");o.getColumn("B"),y.eachCell({includeEmpty:!0},function(g,c){if(c===1)return;let S=g.value,se=o.getCell(`B${c}`),A=parseFloat(se.value);S&&(t[S]?t[S]+=A:t[S]=A)});let q=Object.keys(t).map(g=>({codigo:g,cantidad:t[g]}));if(q.length){let g={codes:q,_requisition:i.value.id};m.loading.show({message:"Procesando archivo, espera.."}),console.log(g);const c=await RestockApi.addMassiveProducts(g);c.fail?console.log(c):(console.log(c),i.value.products=c.products,x.value.state=!0,x.value.added=c.products,x.value.notfound=c.notFound,m.loading.hide())}else m.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},te=async()=>{m.loading.show({message:"Mandando Pedido"});let a={id:i.value.id,_printer:u.printers.val};console.log(a);const e=await N.nextStepPrv(a);if(e.fail)console.log(e);else{console.log(e);let t={order:e.order,newstate:e.status};console.log(t),_e.emit("order_update",t),u.addOrUpdate(t),I.push("/preorders/pedidos"),m.loading.hide()}};return J(),(a,e)=>i.value?(v(),h(pe,{key:0,padding:""},{default:d(()=>[s("div",xe,[l(k,{onClick:e[0]||(e[0]=t=>p(I).push("/preorders/pedidos")),dense:"",flat:"",icon:"close",color:"white"}),s("div",ye,[s("div",ge,[e[7]||(e[7]=s("div",{class:"text-caption"},"Folio:",-1)),s("div",be,n(i.value.id),1)]),s("div",we,[e[8]||(e[8]=s("div",{class:"text-caption"},"Cliente:",-1)),s("div",he,n(i.value.name),1)])]),l(k,{icon:"settings",dense:"",flat:""},{default:d(()=>[l(ne,{style:{width:"100%"}},{default:d(()=>[l(P,null,{default:d(()=>[l(_,{class:"q-pa-sm"},{default:d(()=>[l(R,{modelValue:p(u).units.val,"onUpdate:modelValue":e[1]||(e[1]=t=>p(u).units.val=t),options:p(u).units.opts,label:"Pedir Por",filled:"","option-label":"name",dense:"",disable:i.value._status!=1},null,8,["modelValue","options","disable"])]),_:1}),l(_,null,{default:d(()=>[s("div",ke,[s("div",Ve,[s("div",Qe,[e[9]||(e[9]=s("div",{class:"text-caption"},"Modelos",-1)),s("span",Ce,n(i.value.products.length),1)]),s("div",qe,[e[10]||(e[10]=s("div",{class:"text-caption"},"Unidades",-1)),s("span",Pe,n(i.value.products.reduce((t,w)=>t+Number(w.pivot.units),0)),1)]),s("div",$e,[e[11]||(e[11]=s("div",{class:"text-caption"},"Total",-1)),s("span",Se," $ "+n(i.value.products.reduce((t,w)=>t+Number(w.pivot.total),0)),1)])])])]),_:1})]),_:1})]),_:1})]),_:1})]),l(V),(v(!0),D(z,null,O(p(u).units.opts,(t,w)=>(v(),h(re,{bordered:"",key:w},{default:d(()=>[i.value.products.filter(o=>o.pivot._supply_by==t.id).length?(v(),h(ue,{key:0,"expand-separator":"","default-opened":"","header-class":"text-bold","expand-icon-class":"hidden"},{header:d(()=>[s("div",Ie,[s("div",null,[f(n(t.name.toUpperCase())+" - "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).length)+" productos ",1),l(ie,{name:"fas fa-caret-right"}),f(" "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.units,0))+" pzs ",1)]),s("div",Fe,"$ "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.total,0)),1)])]),default:d(()=>[l(V),l(de,{appear:"","enter-active-class":"animated zoomIn","leave-active-class":"animated zoomOut"},{default:d(()=>[(v(!0),D(z,null,O(i.value.products.filter(o=>o.pivot._supply_by==t.id),(o,y)=>(v(),D("div",{key:y,class:"q-py-md q-px-sm wrapper_prod",onClick:q=>Z(o)},[s("div",De,[s("div",Ue,[s("div",Ae,[s("div",null,[s("span",null,n(o.code),1),e[12]||(e[12]=f(" -- ")),s("span",null,n(o.name),1)]),s("span",Oe,n(o.category.familia.name)+" (pxc "+n(o.pieces)+")",1)]),e[13]||(e[13]=s("div",{class:"text--3 text-uppercase text-italic"},null,-1)),s("div",ze,n(o.description),1),s("div",Ee,n(o._supply_by!=1?`(${o.pivot.units} pzs)`:"")+", PU: $"+n(o.pivot.price),1),s("div",Re,n(o.pivot.comments),1)]),s("div",Te,[s("div",je,"$ "+n(o.pivot.total),1),s("div",Me,n(o.prices.find(q=>q.id==o.pivot._price_list).name),1)])]),l(V)],8,Be))),128))]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1024))),128)),l(U,{modelValue:$.value.state,"onUpdate:modelValue":e[3]||(e[3]=t=>$.value.state=t),persistent:""},{default:d(()=>[l(P,null,{default:d(()=>[l(_,{class:"row items-center bg-primary text-white text-h6"},{default:d(()=>e[14]||(e[14]=[f(" Selecciona Impresora ")])),_:1}),l(_,{class:""},{default:d(()=>[l(R,{modelValue:p(u).printers.val,"onUpdate:modelValue":e[2]||(e[2]=t=>p(u).printers.val=t),options:p(u).printers.opts.filter(t=>t._type==1),label:"Impresoras","option-label":"name",filled:""},null,8,["modelValue","options"])]),_:1}),l(T,{align:"right"},{default:d(()=>[E(l(k,{flat:"",label:"Cancelar",color:"primary"},null,512),[[M]]),l(k,{flat:"",label:"Terminar",color:"primary",onClick:te,disabled:!p(u).printers.val},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:r.value.state,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.state=t),persistent:"",position:"bottom"},{default:d(()=>[l(ve,{product:r.value.val,order:i.value,edit:r.value.edit,onReset:F,products:i.value.products,rules:p(u).rules,onAddProduct:X,onDeleteProduct:Y,units:p(u).units.opts,unit:p(u).units.val},null,8,["product","order","edit","products","rules","units","unit"])]),_:1},8,["modelValue"]),l(U,{modelValue:x.value.state,"onUpdate:modelValue":e[5]||(e[5]=t=>x.value.state=t),persistent:""},{default:d(()=>[l(P,null,{default:d(()=>[l(_,{class:"text-center text-h5 text-bold"},{default:d(()=>e[15]||(e[15]=[f(" Resultados de Importacion ")])),_:1}),l(_,{class:"text-centet text-h6 text-bold"},{default:d(()=>[f(" Correctos: "+n(x.value.added.length),1)]),_:1}),l(_,null,{default:d(()=>[e[16]||(e[16]=f(" Modelos sin Coincidencia: ")),s("span",Ne,n(x.value.notfound),1)]),_:1}),l(T,{align:"right"},{default:d(()=>[E(l(k,{flat:"",label:"OK",color:"primary"},null,512),[[M]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i.value._status==1?(v(),h(j,{key:0,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",Le,[l(P,{class:"col"},{default:d(()=>[l(ce,{checkState:!0,onInput:H,with_prices:"",onAgregar:K,"workpoint-status":[1,2,p(Q).session.store.id_viz],wkpToVal:p(Q).session.store.id_viz},null,8,["workpoint-status","wkpToVal"])]),_:1}),l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",null,[i.value.products.length>0?(v(),h(k,{key:0,flat:"",icon:"send",onClick:e[6]||(e[6]=t=>$.value.state=!$.value.state)})):B("",!0)])]),l(V,{spaced:"",inset:"",vertical:"",dark:""})]),_:1})):(v(),h(j,{key:1,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(P,{class:"my-card"},{default:d(()=>[l(_,{class:"text-center text-bold bg-primary"},{default:d(()=>e[17]||(e[17]=[f(" El pedido ya esta terminado :/ ")])),_:1})]),_:1})]),_:1})),s("input",{type:"file",ref_key:"inputFile",ref:G,id:"inputFile",onInput:ee,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1})):B("",!0)}};export{yt as default};

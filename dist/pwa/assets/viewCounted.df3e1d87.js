import{Q as X}from"./QCircularProgress.ccfa6e87.js";import{Q as y}from"./QCard.7cc3dc50.js";import{Q as k}from"./QCardSection.fed8a97e.js";import{Q as G}from"./QTable.41d37387.js";import{Q as J}from"./QSelect.2047fd6e.js";import{r as m,aW as K,a as Z,u as ee,c as h,l as te,o as $,d as N,w as l,e as s,f as i,a0 as f,a1 as oe,al as O,Q as C,h as se,ak as ae,b5 as le,am as ie,a4 as re}from"./index.c2f5f4e3.js";import{Q as ne}from"./QFooter.0e087754.js";import{b as ce,Q as S}from"./QList.ad92ec23.js";import{Q as ue}from"./QInput.d5f95cb2.js";import{Q as B}from"./QCardActions.d49ddb1a.js";import{Q as de}from"./QForm.1c2009e8.js";import{Q as pe}from"./QPage.17984628.js";import{C as me}from"./ClosePopup.8bd06445.js";import{u as fe}from"./use-quasar.39f9e42d.js";import{d as ve}from"./dayjs.min.cbcf888d.js";import"./QDrawer.0e1edfa0.js";import"./QExpansionItem.e926aa81.js";import"./axios.ea4a1dc9.js";import{C as Q}from"./cicsdb.5afbad8c.js";import"./QTr.f58aa799.js";import"./QTd.6d0955bc.js";/* empty css                                                                         */import{c as ge}from"./cyclecountStore.1d9a6cd1.js";import"./OrderStore.8312dcb3.js";import{$sktCounters as g}from"./socket.41f46bf6.js";import"./use-key-composition.a7b75bd7.js";import"./QLinearProgress.789a8ffd.js";import"./QCheckbox.d16d5612.js";import"./use-checkbox.7e1bd460.js";import"./QResizeObserver.121c3205.js";import"./_commonjsHelpers.88e99c8f.js";import"./QScrollObserver.e23a7fbb.js";const _e={class:"col"},ke={class:"text-h5 text-primary"},Ce={class:"text-caption text-grey"},be={class:"row justify-between"},ye={class:"text-left"},we={class:"text--3"},xe={class:"text-h6"},he={class:"row"},Qe={class:"text-center col"},Ve={class:"text-center col"},Pe={class:"text-center text-bold text-h6"},rt={__name:"viewCounted",setup(De){m("");const u=fe(),d=K(),R=Z(),_=ee(),r=ge();r.settitle(`Ciclico ${d.params.cid}`),r.setshowBtns(!1);const c=m(null);m({});const p=m(null),T=m({rowsPerPage:20}),V=m([]),b=m(!1),E=[{name:"code",label:"code",field:"code",align:"left",classes:t=>r.lockedProducts[t.id]?w():""},{name:"ubicacion",label:"Ubicacion",field:t=>{var e;return(e=t.locations)==null?void 0:e.map(o=>o.path).join("/")},align:"left",classes:t=>r.lockedProducts[t.id]?w():""},{name:"conteo",label:"Stock",field:t=>{var e;return((e=t.pivot)==null?void 0:e.stock_acc)||0},align:"right",classes:t=>r.lockedProducts[t.id]?w():""}],a=m({state:!1,val:null}),q=async()=>{u.loading.show({message:"Obteniendo Datos"});let t={cyclecount:d.params.cid,_rol:_.session.credentials._rol,id:_.session.credentials.staff.id_va};console.log(t);const e=await Q.getCyclecount(t);e.fail?e.fail.status==403||e.fail.status==404?(u.notify({message:`${e.fail.response.data.message}`,type:"negative",position:"top"}),R.push("/ciclicos/counted")):console.log(e):(c.value=e,console.log(e),u.loading.hide(),g.emit("joinat",{user:r.socket_user.profile,room:`COUNTER${d.params.cid}`}))},M=(t,e,o)=>{e(()=>{const n=t.toUpperCase();V.value=c.value.products.filter(v=>{var U;const L=(U=v.variants)==null?void 0:U.some(x=>(x==null?void 0:x.barcode.toUpperCase().indexOf(n))>-1),W=v.code.toUpperCase().indexOf(n)>-1||v.barcode.toUpperCase().indexOf(n)>-1||v.name.toUpperCase().indexOf(n)>-1;return L||W})})},P=h(()=>u.dark.isActive),I=h(()=>{var t,e;return(e=(t=c.value)==null?void 0:t.products)==null?void 0:e.filter(o=>o.pivot.stock_acc>0)}),D=h(()=>{var o;const t=((o=c.value)==null?void 0:o.products)||[];if(t.length===0)return 0;const e=t.filter(n=>Number(n.pivot.stock_acc)>0).length;return Math.round(e/t.length*100)}),j=async()=>{u.loading.show({message:"Registrando Contreo"});let t={_user:_.session.credentials.staff.id_va,_inventory:d.params.cid,_product:a.value.val.id,stock:a.value.val.pivot.stock_acc};const e=await Q.saveValue(t);if(e.fail)console.log(e);else{let o={by:r.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`,settings:"config"};g.emit("countingconfirmed",o),a.value={state:!1,val:null},u.loading.hide()}},z=()=>{let t={by:r.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`};g.emit("cancelcounting",t),a.value={state:!1,val:null}},F=t=>{if(r.lockedProducts[t.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),p.value=null;return}a.value.state=!0,a.value.val=t,p.value=null;let e={by:r.socket_user.profile,product:t,room:`COUNTER${d.params.cid}`};g.emit("counting",e)},Y=(t,e)=>{if(r.lockedProducts[e.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),p.value=null;return}a.value.state=!0,a.value.val=e,p.value=null;let o={by:r.socket_user.profile,product:e,room:`COUNTER${d.params.cid}`};g.emit("counting",o)},A=t=>{p.value=t,console.log(p.value)},w=()=>(P.value,"bg-red"),H=async()=>{u.loading.show({message:"Terminando Conteo"});let t={_inventory:d.params.cid,workpoint:_.session.credentials._rol,user:_.session.credentials.staff.id_va};const e=await Q.nextStep(t);if(e.fail)console.log(e);else{console.log(e);let o={by:r.socket_user.profile,counter:e.inventario,room:`COUNTER${d.params.cid}`};g.emit("endingCounting",o),u.loading.hide()}};return q(),te(()=>r.currentLockedProduct,t=>{if(!t)return;const e=c.value.products.findIndex(o=>o.id===t.id);e!==-1&&(c.value.products[e]={...c.value.products[e],...t})}),(t,e)=>($(),N(pe,{padding:""},{default:l(()=>[s(y,{flat:"",bordered:"",class:"q-pa-md row"},{default:l(()=>{var o,n,v;return[i("div",_e,[i("div",ke,f(((o=c.value)==null?void 0:o.notes)||"Inventario C\xEDclico"),1),i("div",Ce," ID: "+f((n=c.value)==null?void 0:n.id)+" \u2022 Creado: "+f(oe(ve)((v=c.value)==null?void 0:v.created_at).format("YYYY-MM-DD H:mm:ss")),1)]),i("div",null,[s(X,{"show-value":"","font-size":"12px",value:D.value,size:"45px",thickness:.22,color:"teal","track-color":"grey-3",class:"q-ma-md"},{default:l(()=>[O(f(D.value)+"% ",1)]),_:1},8,["value"])])]}),_:1}),s(y,{bordered:""},{default:l(()=>{var o;return[s(k,null,{default:l(()=>e[5]||(e[5]=[i("div",{class:"text-h6"},"Productos",-1)])),_:1}),s(G,{rows:((o=c.value)==null?void 0:o.products)||[],columns:E,"row-key":"id",dense:"",flat:"",bordered:"",onRowClick:Y,pagination:T.value},null,8,["rows","pagination"])]}),_:1}),s(ne,{class:ae(["row q-ml-sm q-mr-sm",P.value?"bg-grey-10 text-white":"bg-grey-4 text-dark"])},{default:l(()=>{var o;return[s(J,{class:"col",modelValue:p.value,"onUpdate:modelValue":[e[0]||(e[0]=n=>p.value=n),F],options:V.value,filled:"","option-label":"code","use-input":"","fill-input":"","hide-selected":"","input-debounce":"0",onFilter:M,onInputValue:A,dense:""},null,8,["modelValue","options"]),((o=I.value)==null?void 0:o.length)>0?($(),N(C,{key:0,size:"sm",icon:"send",onClick:e[1]||(e[1]=n=>b.value=!b.value)})):se("",!0)]}),_:1},8,["class"]),s(S,{modelValue:a.value.state,"onUpdate:modelValue":e[3]||(e[3]=o=>a.value.state=o),persistent:"",position:"bottom"},{default:l(()=>[s(y,null,{default:l(()=>[s(k,null,{default:l(()=>[i("div",be,[i("div",ye,[i("div",we,"CCO: "+f(a.value.val.name),1),i("div",xe,f(a.value.val.code),1)])])]),_:1}),s(ce),s(k,null,{default:l(()=>[O(f(a.value.val.description),1)]),_:1}),s(de,{onSubmit:le(j,["prevent"])},{default:l(()=>[s(k,null,{default:l(()=>[i("div",he,[i("div",Qe,[e[6]||(e[6]=i("div",null,"Conteo",-1)),s(ue,{dense:"",borderless:"",modelValue:a.value.val.pivot.stock_acc,"onUpdate:modelValue":e[2]||(e[2]=o=>a.value.val.pivot.stock_acc=o),type:"number",min:"0","input-class":"text-h6 text-center",ref:"iptcounter",autofocus:""},null,8,["modelValue"])]),i("div",Ve,[e[7]||(e[7]=i("div",null,"PXC",-1)),i("div",Pe,f(a.value.val.pieces),1)])])]),_:1}),s(B,{align:"center"},{default:l(()=>[s(C,{flat:"",icon:"close",color:"negative",onClick:z}),s(C,{color:"positive",type:"submit",square:"",icon:"done_all",flat:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(S,{modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=o=>b.value=o),persistent:""},{default:l(()=>[s(y,null,{default:l(()=>[s(k,{class:"row items-center"},{default:l(()=>[s(ie,{icon:"warning",color:"warning","text-color":"white"}),e[8]||(e[8]=i("span",{class:"q-ml-sm"},"Estas Seguro de terminar ?",-1))]),_:1}),s(B,{align:"right"},{default:l(()=>[re(s(C,{flat:"",label:"No",color:"negative"},null,512),[[me]]),s(C,{flat:"",label:"Si",color:"positive",onClick:H})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{rt as default};

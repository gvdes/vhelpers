import{aI as le,a as oe,u as ae,r as b,o as v,d as h,w as i,h as B,f as s,e as l,a1 as p,Q as k,a0 as r,g as D,a2 as O,a3 as z,al as f,a4 as E,S as ie,bd as de}from"./index.3cdfa26e.js";import{d as ne,Q as R}from"./QSelect.bf04ac42.js";import{Q as _}from"./QCardSection.4777ea36.js";import{Q as q}from"./QCard.1710dfc4.js";import{b as V,Q as U,a as re}from"./QList.9e83d7bb.js";import{Q as ue}from"./QExpansionItem.d1f27756.js";import{Q as T}from"./QCardActions.4a572d02.js";import{Q as j}from"./QFooter.5251d1ab.js";import{Q as pe}from"./QPage.736734a7.js";import{C as M}from"./ClosePopup.bfbf3c13.js";import"./dayjs.min.cbcf888d.js";import"./axios.554e33cc.js";import{P as ce}from"./ProductsAutocomplete.e961c8af.js";import{_ as ve}from"./productView.a0bac1b8.js";import{o as N}from"./orderApi.fd6b55e7.js";import{u as me}from"./OrderStore.8577c9a2.js";import{u as fe}from"./use-quasar.ce6af595.js";import{$sktOrders as _e}from"./socket.05630e21.js";import"./use-key-composition.83984d94.js";import"./QResizeObserver.abcb442b.js";import"./_commonjsHelpers.88e99c8f.js";import"./QInput.f4db2c99.js";/* empty css                                                                         */import"./QSpace.fd0438dc.js";import"./resoursesOrder.d78a8119.js";const xe={class:"row items-center justify-between bg-primary text-white q-py-xs q-px-sm"},ye={class:"row items-center col"},ge={class:"q-pa-xs col text-center"},be={class:"text-body2 text-bold"},we={class:"q-pa-xs col text-center"},he={class:"text-body2 text-bold"},ke={class:"row items-center justify-between q-mt-xs"},Ve={class:"row text-center"},Qe={class:"q-px-md col"},Ce={class:"text-body2 text-bold"},qe={class:"q-px-md col"},Pe={class:"text-body2 text-bold"},$e={class:"q-px-md col"},Ie={class:"text-body2 text-bold"},Se={class:"row full-width items-center justify-between q-py-sm"},Fe={class:"text-bold"},Be=["onClick"],De={class:"row items-center"},Ue={class:"col q-pr-sm"},Ae={class:"row items-center justify-between"},Oe={class:"text-caption text-right text-grey-6"},ze={class:"text--2 text-grey-6"},Ee={class:"col text--2 text-caption"},Re={class:"text--2 text-amber-13"},Te={class:"text-right"},je={class:"text-caption text-bold"},Me={class:"text-caption"},Ne={class:"text-bold text-red"},Le={class:"row q-ml-sm"},yt={__name:"Viewpreorders",setup(Ge){const L=le(),S=oe(),n=me();n.setshowLyt(!1);const m=fe(),P=ae(),d=b(null),G=b({opts:[],val:null}),u=b({state:!1,val:null,edit:!1}),x=b({state:!1,notfound:[],added:[]}),J=b(null),Q=b({amount:1,amountDelivered:0,price:0,toDelivered:0,total:0,units:1,_price_list:1,_supply_by:1}),$=b({state:!1,val:null,opts:[]}),K=async()=>{m.loading.show({message:"Obtenidendo datos"});let o={pedido:L.params.oid,store:P.session.store.id_viz,uid:P.session.credentials.staff.id_va};const e=await N.getOrderPrv(o);e.fail?(console.log(e),(e.fail.status==401||e.fail.status==404)&&(m.notify({message:e.fail.response.data.mssg,type:"negative",position:"top"}),S.push("/preorders/pedidos"))):(console.log(e),d.value=e,m.loading.hide())},W=o=>{console.log(o);let e=d.value.products.findIndex(t=>t.id==o.id);e>=0?(o.units=n.units.opts.find(t=>t.id==o.pivot._supply_by),u.value.val=d.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=n.units.val.id,o.pivot={...Q.value},console.log(o.pivot),o.units=n.units.val,u.value.val=o,u.value.state=!0,u.value.edit=!1)},H=o=>{console.log(o);let e=d.value.products.findIndex(t=>t.id==o.id);e>=0?(o.units=n.units.opts.find(t=>t.id==o.pivot._supply_by),u.value.val=d.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=n.units.val.id,o.pivot={...Q.value},console.log(o.pivot),o.units=n.units.val,u.value.val=o,u.value.state=!0,u.value.edit=!1)},F=()=>{u.value={state:!1,val:null,edit:!1},Q.value._supply_by=1},X=o=>{d.value.products.push(o),F()},Y=o=>{let e=d.value.products.findIndex(t=>t.id==o.id);e>=0&&(d.value.products.splice(e,1),F())},Z=o=>{console.log(o),console.log(G.value),o.units=n.units.opts.find(e=>e.id==o.pivot._supply_by),u.value.val=o,u.value.state=!0,u.value.edit=!0},ee=async()=>{let o=document.getElementById("inputFile").files[0],e=new ExcelJS.Workbook,t={};e.xlsx.load(o).then(async w=>{let a=e.worksheets[0],y=a.getColumn("A");a.getColumn("B"),y.eachCell({includeEmpty:!0},function(g,c){if(c===1)return;let I=g.value,se=a.getCell(`B${c}`),A=parseFloat(se.value);I&&(t[I]?t[I]+=A:t[I]=A)});let C=Object.keys(t).map(g=>({codigo:g,cantidad:t[g]}));if(C.length){let g={codes:C,_requisition:d.value.id};m.loading.show({message:"Procesando archivo, espera.."}),console.log(g);const c=await RestockApi.addMassiveProducts(g);c.fail?console.log(c):(console.log(c),d.value.products=c.products,x.value.state=!0,x.value.added=c.products,x.value.notfound=c.notFound,m.loading.hide())}else m.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},te=async()=>{m.loading.show({message:"Mandando Pedido"});let o={id:d.value.id,_printer:n.printers.val};console.log(o);const e=await N.nextStepPrv(o);if(e.fail)console.log(e);else{console.log(e);let t={order:e.order,newstate:e.status};console.log(t),_e.emit("order_update",t),n.addOrUpdate(t),S.push("/preorders/pedidos"),m.loading.hide()}};return K(),(o,e)=>d.value?(v(),h(pe,{key:0,padding:""},{default:i(()=>[s("div",xe,[l(k,{onClick:e[0]||(e[0]=t=>p(S).push("/preorders/pedidos")),dense:"",flat:"",icon:"close",color:"white"}),s("div",ye,[s("div",ge,[e[7]||(e[7]=s("div",{class:"text-caption"},"Folio:",-1)),s("div",be,r(d.value.id),1)]),s("div",we,[e[8]||(e[8]=s("div",{class:"text-caption"},"Cliente:",-1)),s("div",he,r(d.value.name),1)])]),l(k,{icon:"settings",dense:"",flat:""},{default:i(()=>[l(ne,{style:{width:"100%"}},{default:i(()=>[l(q,null,{default:i(()=>[l(_,{class:"q-pa-sm"},{default:i(()=>[l(R,{modelValue:p(n).units.val,"onUpdate:modelValue":e[1]||(e[1]=t=>p(n).units.val=t),options:p(n).units.opts,label:"Pedir Por",filled:"","option-label":"name",dense:""},null,8,["modelValue","options"])]),_:1}),l(_,null,{default:i(()=>[s("div",ke,[s("div",Ve,[s("div",Qe,[e[9]||(e[9]=s("div",{class:"text-caption"},"Modelos",-1)),s("span",Ce,r(d.value.products.length),1)]),s("div",qe,[e[10]||(e[10]=s("div",{class:"text-caption"},"Unidades",-1)),s("span",Pe,r(d.value.products.reduce((t,w)=>t+Number(w.pivot.units),0)),1)]),s("div",$e,[e[11]||(e[11]=s("div",{class:"text-caption"},"Total",-1)),s("span",Ie," $ "+r(d.value.products.reduce((t,w)=>t+Number(w.pivot.total),0)),1)])])])]),_:1})]),_:1})]),_:1})]),_:1})]),l(V),(v(!0),D(z,null,O(p(n).units.opts,(t,w)=>(v(),h(re,{bordered:"",key:w},{default:i(()=>[d.value.products.filter(a=>a.pivot._supply_by==t.id).length?(v(),h(ue,{key:0,"expand-separator":"","default-opened":"","header-class":"text-bold","expand-icon-class":"hidden"},{header:i(()=>[s("div",Se,[s("div",null,[f(r(t.name.toUpperCase())+" - "+r(d.value.products.filter(a=>a.pivot._supply_by==t.id).length)+" productos ",1),l(ie,{name:"fas fa-caret-right"}),f(" "+r(d.value.products.filter(a=>a.pivot._supply_by==t.id).reduce((a,y)=>a+y.pivot.units,0))+" pzs ",1)]),s("div",Fe,"$ "+r(d.value.products.filter(a=>a.pivot._supply_by==t.id).reduce((a,y)=>a+y.pivot.total,0)),1)])]),default:i(()=>[l(V),l(de,{appear:"","enter-active-class":"animated zoomIn","leave-active-class":"animated zoomOut"},{default:i(()=>[(v(!0),D(z,null,O(d.value.products.filter(a=>a.pivot._supply_by==t.id),(a,y)=>(v(),D("div",{key:y,class:"q-py-md q-px-sm wrapper_prod",onClick:C=>Z(a)},[s("div",De,[s("div",Ue,[s("div",Ae,[s("div",null,[s("span",null,r(a.code),1),e[12]||(e[12]=f(" -- ")),s("span",null,r(a.name),1)]),s("span",Oe,r(a.category.familia.name)+" (pxc "+r(a.pieces)+")",1)]),e[13]||(e[13]=s("div",{class:"text--3 text-uppercase text-italic"},null,-1)),s("div",ze,r(a.description),1),s("div",Ee,r(a._supply_by!=1?`(${a.pivot.units} pzs)`:"")+", PU: $"+r(a.pivot.price),1),s("div",Re,r(a.pivot.comments),1)]),s("div",Te,[s("div",je,"$ "+r(a.pivot.total),1),s("div",Me,r(a.prices.find(C=>C.id==a.pivot._price_list).name),1)])]),l(V)],8,Be))),128))]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1024))),128)),l(U,{modelValue:$.value.state,"onUpdate:modelValue":e[3]||(e[3]=t=>$.value.state=t),persistent:""},{default:i(()=>[l(q,null,{default:i(()=>[l(_,{class:"row items-center bg-primary text-white text-h6"},{default:i(()=>e[14]||(e[14]=[f(" Selecciona Impresora ")])),_:1}),l(_,{class:""},{default:i(()=>[l(R,{modelValue:p(n).printers.val,"onUpdate:modelValue":e[2]||(e[2]=t=>p(n).printers.val=t),options:p(n).printers.opts.filter(t=>t._type==1),label:"Impresoras","option-label":"name",filled:""},null,8,["modelValue","options"])]),_:1}),l(T,{align:"right"},{default:i(()=>[E(l(k,{flat:"",label:"Cancelar",color:"primary"},null,512),[[M]]),l(k,{flat:"",label:"Terminar",color:"primary",onClick:te,disabled:!p(n).printers.val},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:u.value.state,"onUpdate:modelValue":e[4]||(e[4]=t=>u.value.state=t),persistent:"",position:"bottom"},{default:i(()=>[l(ve,{product:u.value.val,order:d.value,edit:u.value.edit,onReset:F,products:d.value.products,rules:p(n).rules,onAddProduct:X,onDeleteProduct:Y,units:p(n).units.opts,unit:p(n).units.val},null,8,["product","order","edit","products","rules","units","unit"])]),_:1},8,["modelValue"]),l(U,{modelValue:x.value.state,"onUpdate:modelValue":e[5]||(e[5]=t=>x.value.state=t),persistent:""},{default:i(()=>[l(q,null,{default:i(()=>[l(_,{class:"text-center text-h5 text-bold"},{default:i(()=>e[15]||(e[15]=[f(" Resultados de Importacion ")])),_:1}),l(_,{class:"text-centet text-h6 text-bold"},{default:i(()=>[f(" Correctos: "+r(x.value.added.length),1)]),_:1}),l(_,null,{default:i(()=>[e[16]||(e[16]=f(" Modelos sin Coincidencia: ")),s("span",Ne,r(x.value.notfound),1)]),_:1}),l(T,{align:"right"},{default:i(()=>[E(l(k,{flat:"",label:"OK",color:"primary"},null,512),[[M]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),d.value._status==1?(v(),h(j,{key:0,reveal:"",elevated:"",bordered:""},{default:i(()=>[l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",Le,[l(q,{class:"col"},{default:i(()=>[l(ce,{checkState:!0,onInput:H,with_prices:"",onAgregar:W,"workpoint-status":[1,2,p(P).session.store.id_viz],wkpToVal:p(P).session.store.id_viz},null,8,["workpoint-status","wkpToVal"])]),_:1}),l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",null,[d.value.products.length>0?(v(),h(k,{key:0,flat:"",icon:"send",onClick:e[6]||(e[6]=t=>$.value.state=!$.value.state)})):B("",!0)])]),l(V,{spaced:"",inset:"",vertical:"",dark:""})]),_:1})):(v(),h(j,{key:1,reveal:"",elevated:"",bordered:""},{default:i(()=>[l(q,{class:"my-card"},{default:i(()=>[l(_,{class:"text-center text-bold bg-primary"},{default:i(()=>e[17]||(e[17]=[f(" El pedido ya esta terminado :/ ")])),_:1})]),_:1})]),_:1})),s("input",{type:"file",ref_key:"inputFile",ref:J,id:"inputFile",onInput:ee,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1})):B("",!0)}};export{yt as default};

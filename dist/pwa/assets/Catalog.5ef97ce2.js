import{b as V,a as X,d as Y,e as I,Q as B}from"./QList.824a9fd1.js";import{Q as Z}from"./QHeader.44391472.js";import{aH as ee,a as te,u as oe,r as S,c as z,l as ae,p as se,m as le,a$ as re,o as _,d as P,w as o,e,a1 as d,Q as u,h as Q,f as r,a0 as i,g as D,ak as b,S as T,a4 as A,al as de}from"./index.2fd7d489.js";import{a as h,Q as ie}from"./QSelect.8f226fdb.js";import{Q as ne}from"./QToolbarTitle.1cc1fb76.js";import{Q as ce}from"./QToolbar.3e2d7dce.js";import{Q as y}from"./QCardSection.fa61f17d.js";import{Q as ue}from"./QInput.3837222c.js";import{Q as me}from"./QForm.6a5e500f.js";import{Q as j}from"./QCardActions.a7e05898.js";import{Q as g}from"./QCard.8e7c3254.js";import{Q as pe}from"./QImg.f8c2a65d.js";import{Q as k}from"./QTd.622fdb3e.js";import{Q as fe}from"./QTable.b7ea36c3.js";import{Q as ve,a as _e}from"./QLayout.0ee27b2e.js";import{C as U}from"./ClosePopup.bf899985.js";import"./dayjs.min.cbcf888d.js";import{c as be,a as ge}from"./catalogStore.e1a7726c.js";import{o as F}from"./orderApi.a45c5055.js";import{v as H}from"./axios.9ef87cd9.js";import{u as xe}from"./use-quasar.3f172000.js";import{_ as we}from"./UserToolbar.2c842690.js";import{$sktOrders as x}from"./socket.05630e21.js";import"./use-key-composition.b62f19de.js";import"./QResizeObserver.87396d36.js";import"./QLinearProgress.7512cefc.js";import"./QCheckbox.f377c3ac.js";import"./QScrollObserver.0f61885c.js";import"./_commonjsHelpers.88e99c8f.js";import"./QDrawer.821a6e09.js";import"./auth.d7150cfb.js";const Qe={class:"col text-bold text-h5 q-mt-md"},ye={key:0,class:"col"},ke={key:1},Ce={class:"text-subtitle2"},Se={class:"row q-col-gutter-md"},Pe={class:"col-6 col-md-3"},he={class:"text-h6 text-bold"},Ve={class:"col-6 col-md-3"},$e={class:"text-h6 text-bold"},qe={class:"col-6 col-md-3"},Ne={class:"text-bold"},Oe={class:"col-6 col-md-3"},Ie={class:"text-bold"},Be={class:"text-bold"},ze={class:"ellipsis",style:{"max-width":"250px"}},De={class:"row items-center justify-center q-gutter-xs"},Te={class:"text-bold q-mx-sm"},_t={__name:"Catalog",setup(Ae){const w=ee(),$=te(),l=be(),C=xe(),n=oe(),f=S(!1),m=S({state:!1,order:{_created_by:n.session.credentials.staff.id_va,_workpoint:n.session.store.id_viz,name:null}}),q={profile:{me:{id:n.session.credentials.staff.id_va,nick:n.session.credentials.nick,picture:"",names:n.session.credentials.staff.complete_name,surname_pat:"",surname_mat:"",change_password:!1,_rol:1},workpoint:n.session.store},workpoint:n.session.store,room:"sales"},c=S({val:null,opts:[]}),L=S({columns:[{name:"picture",label:"Imagen",field:t=>t.imgcover},{name:"code",label:"Codigo",field:t=>t.code},{name:"description",label:"Descripcion",field:t=>t.description},{name:"amount",label:"Cantidad",field:t=>t.pivot.amount}]}),N=z(()=>w.name==="sinx"),E=z(()=>w.name==="fidca"),J=async()=>{const t=await ge.getPrinters(n.session.store.id_viz);if(t.fail)console.log(t),alert("Hay Problema para recibir las impresoras");else{console.log(t),l.setPrinters(t),c.value.opts=t;const s=localStorage.getItem("selectedPrinter");if(s){const v=JSON.parse(s),a=c.value.opts.find(p=>p.id===v.id);a&&(c.value.val=a)}}},M=()=>{if(w.name==="fidca"){const{sid:t}=w.params;$.push({name:"sidca",params:{sid:t}})}else w.name==="sidca"&&$.push({name:"sinx"})},O=async()=>{console.log(m.value.order),C.loading.show({message:"Creando Pedido"});const t=await F.create(m.value.order);t.fail?console.log(t):(console.log(t),m.value.state=!1,l.setOrderState(!0),l.setOrder(t),x.connected?(x.emit("order_add",{order:t,user:q.profile}),console.log("Evento order_add emitido por socket")):console.warn("Socket no conectado, no se envi\xF3 el evento order_add"),C.loading.hide())},R=t=>{t.pivot.amount++,t.pivot.units++,t.pivot.total=t.pivot.amount*t.pivot.price,l.updateProduct(t)},G=t=>{t.pivot.amount--,t.pivot.units--,t.pivot.amount<=0?(delete t.pivot,l.removeProduct(t.id)):(t.pivot.total=t.pivot.amount*t.pivot.price,l.updateProduct(t))},K=()=>{l.clearOrder(),f.value=!1,window.location.reload()},W=async()=>{C.loading.show({message:"Cerrando Pedido"});let t={order:l.order,_printer:c.value.val};const s=await F.orderCatalog(t);if(s.fail)console.log(s);else{if(x.connected){let v={order:l.order,newstate:s.status};console.log(v),x.emit("order_update",v),console.log("Evento order_update emitido por socket")}else console.warn("Socket no conectado, no se envi\xF3 el evento order_update");C.loading.hide(),console.log(s),l.clearOrder(),f.value=!1,window.location.reload()}};return ae(()=>c.value.val,t=>{t&&localStorage.setItem("selectedPrinter",JSON.stringify(t))}),se(()=>{x.connect(),x.emit("join",q),l.loadOrder(),J();const t=localStorage.getItem("selectedPrinter");t&&(c.value.val=JSON.parse(t))}),le(()=>{}),(t,s)=>{const v=re("router-view");return _(),P(ve,{view:"hHh Lpr fFf"},{default:o(()=>[e(Z,{class:"transparent text-dark",bordered:""},{default:o(()=>[e(we),e(V)]),_:1}),e(_e,null,{default:o(()=>[e(ce,null,{default:o(()=>[!N.value&&!d(l).orderState?(_(),P(u,{key:0,round:"",dense:"",icon:"arrow_back",disable:N.value,onClick:M},null,8,["disable"])):Q("",!0),e(V,{spaced:"",inset:"",vertical:"",dark:""}),e(ne,{class:"row"},{default:o(()=>[r("div",Qe,i(d(l).title),1),d(l).orderState?(_(),D("div",ye,[e(X,{bordered:""},{default:o(()=>[e(Y,null,{default:o(()=>[e(I,null,{default:o(()=>[e(h,{overline:""},{default:o(()=>s[6]||(s[6]=[b("Pedido")])),_:1}),e(h,null,{default:o(()=>[b(i(d(l).order.id),1)]),_:1})]),_:1}),e(I,null,{default:o(()=>[e(h,{overline:""},{default:o(()=>s[7]||(s[7]=[b("Cliente")])),_:1}),e(h,null,{default:o(()=>[b(i(d(l).order.name),1)]),_:1})]),_:1})]),_:1})]),_:1})])):Q("",!0)]),_:1}),E.value?(_(),D("div",ke,[d(l).orderState?(_(),P(u,{key:0,flat:"",round:"",dense:"",icon:"shopping_cart",onClick:s[0]||(s[0]=a=>f.value=!f.value)},{default:o(()=>[b(i(d(l).order.products.reduce((a,p)=>a+Number(p.pivot.amount),0)),1)]),_:1})):Q("",!0),d(l).orderState?Q("",!0):(_(),P(u,{key:1,flat:"",round:"",dense:"",icon:"add",onClick:s[1]||(s[1]=a=>m.value.state=!m.value.state)}))])):Q("",!0)]),_:1}),e(v),e(B,{modelValue:m.value.state,"onUpdate:modelValue":s[3]||(s[3]=a=>m.value.state=a),persistent:""},{default:o(()=>[e(g,null,{default:o(()=>[e(y,{class:"row items-center bg-primary text-white"},{default:o(()=>[e(T,{name:"list"}),s[8]||(s[8]=r("span",{class:"q-ml-sm"},"Nevo Pedido",-1))]),_:1}),e(y,null,{default:o(()=>[e(me,{onSubmit:O},{default:o(()=>[e(ue,{modelValue:m.value.order.name,"onUpdate:modelValue":s[2]||(s[2]=a=>m.value.order.name=a),type:"text",label:"Nombre Cliente"},{prepend:o(()=>[e(T,{name:"person_add"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(j,{align:"right"},{default:o(()=>[A(e(u,{flat:"",label:"Cancelar",color:"negative"},null,512),[[U]]),e(u,{flat:"",label:"Crear",color:"positive",onClick:O})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(B,{modelValue:f.value,"onUpdate:modelValue":s[5]||(s[5]=a=>f.value=a),persistent:""},{default:o(()=>[e(g,{class:"q-pa-md",style:{width:"950px","max-width":"90vw","border-radius":"16px"}},{default:o(()=>[e(y,{class:"bg-primary text-white q-pa-md flex items-center justify-between rounded-borders"},{default:o(()=>[r("div",null,[s[9]||(s[9]=r("div",{class:"text-h6 text-weight-bold"},"Resumen del Pedido",-1)),r("div",Ce,"#"+i(d(l).order.id)+" \u2014 "+i(d(l).order.name),1)]),A(e(u,{flat:"",dense:"",round:"",icon:"close",color:"white"},null,512),[[U]])]),_:1}),e(y,{class:"q-pt-md"},{default:o(()=>[r("div",Se,[r("div",Pe,[e(g,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:o(()=>[s[10]||(s[10]=r("div",{class:"text-grey"},"Modelos",-1)),r("div",he,i(d(l).order.products.length),1)]),_:1})]),r("div",Ve,[e(g,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:o(()=>[s[11]||(s[11]=r("div",{class:"text-grey"},"Total piezas",-1)),r("div",$e,i(d(l).order.products.reduce((a,p)=>a+Number(p.pivot.amount),0)),1)]),_:1})]),r("div",qe,[e(g,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:o(()=>[s[12]||(s[12]=r("div",{class:"text-grey"},"Creado por",-1)),r("div",Ne,i(d(n).session.credentials.staff.complete_name),1)]),_:1})]),r("div",Oe,[e(g,{flat:"",bordered:"",class:"q-pa-sm text-center"},{default:o(()=>[s[13]||(s[13]=r("div",{class:"text-grey"},"Sucursal",-1)),r("div",Ie,i(d(n).session.store.name),1)]),_:1})])])]),_:1}),e(V,{spaced:""}),e(y,null,{default:o(()=>[e(fe,{flat:"",bordered:"",dense:"",rows:d(l).order.products,columns:L.value.columns,"row-key":"id",separator:"cell","no-data-label":"No hay productos en este pedido"},{"body-cell-picture":o(a=>[e(k,{props:a,class:"text-center"},{default:o(()=>[e(de,{size:"70px",square:""},{default:o(()=>[e(pe,{src:a.row.imgcover?`${d(H)}/Products/${a.row.id}/${a.row.imgcover}`:`${d(H)}/Products/sinpicture.png`,"spinner-color":"primary",style:{"object-fit":"contain"}},null,8,["src"])]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-code":o(a=>[e(k,{props:a},{default:o(()=>[r("div",Be,i(a.row.code),1)]),_:2},1032,["props"])]),"body-cell-description":o(a=>[e(k,{props:a},{default:o(()=>[r("div",ze,i(a.row.description),1)]),_:2},1032,["props"])]),"body-cell-amount":o(a=>[e(k,{props:a,class:"text-center"},{default:o(()=>[r("div",De,[e(u,{dense:"",flat:"",round:"",icon:"remove",size:"sm",color:"negative",onClick:p=>G(a.row)},null,8,["onClick"]),r("div",Te,i(a.row.pivot.amount),1),e(u,{dense:"",flat:"",round:"",icon:"add",size:"sm",color:"primary",onClick:p=>R(a.row)},null,8,["onClick"])])]),_:2},1032,["props"])]),"body-cell-total":o(a=>[e(k,{props:a,class:"text-center"},{default:o(()=>[b(" $"+i((a.row.pivot.amount*a.row.pivot.price).toFixed(2)),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1}),e(j,{class:"justify-between items-center"},{default:o(()=>[e(ie,{modelValue:c.value.val,"onUpdate:modelValue":s[4]||(s[4]=a=>c.value.val=a),options:c.value.opts,label:"Impresora",outlined:"",dense:"",style:{"min-width":"200px"},"option-label":"name"},null,8,["modelValue","options"]),r("div",null,[e(u,{flat:"",color:"negative",label:"Cancelar Pedido",onClick:K}),e(u,{unelevated:"",color:"primary",label:"Finalizar Pedido",onClick:W,disable:!c.value.val||d(l).order.products.reduce((a,p)=>a+Number(p.pivot.amount),0)<=0},null,8,["disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}};export{_t as default};

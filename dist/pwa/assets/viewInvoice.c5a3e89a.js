import{u as ae,f as oe,Z as ie,r as m,g as se,a as p,c as S,h as k,i as n,p as h,d as o,a6 as O,k as i,a3 as $,n as f,a7 as ne,a1 as v,a4 as y,Q as B,l as x,j as V,a2 as de,m as j,a5 as T,aX as ue}from"./index.a1c295c1.js";import{Q as re}from"./QToolbarTitle.fdaad759.js";import{Q as ve}from"./QToolbar.0a659155.js";import{Q as ce}from"./QTable.6dbea056.js";import{Q as pe}from"./QFooter.eb8841dc.js";import{Q as me}from"./QPage.280a2f20.js";import{Q as fe}from"./QSelect.9d7be3ea.js";import{Q as ge}from"./QSpace.abbec46a.js";import{C as _e}from"./ClosePopup.e501f1d3.js";import{P as ke}from"./ProductsAutocomplete.b6496347.js";import{I as he}from"./invoices.d9d25dce.js";import{u as xe}from"./use-quasar.1aaac9b4.js";import{E as ye}from"./exceljs.min.9e24d01d.js";import{$sktRestock as U}from"./socket.168d2ba4.js";import{i as b}from"./invoicesApi.a0441b26.js";import{R as be}from"./RestockApi.19fe9c8d.js";import"./QList.48a27591.js";import"./QLinearProgress.8ae38f31.js";import"./QResizeObserver.73aad3aa.js";import"./axios.9730f76f.js";/* empty css                                                                         */import"./browser.c61f550a.js";import"./jspdf.plugin.autotable.7c2955ee.js";import"./_commonjsHelpers.88e99c8f.js";import"./JsBarcode.cb858474.js";import"./dayjs.min.cbcf888d.js";const we={class:"col"},Ce={class:"col"},Pe={class:"col text-right"},De={class:"row q-ml-sm"},Ie={class:"row justify-between"},Qe={class:"text-left"},Ve={class:"text--3"},Fe={class:"text-h6"},Se={class:"text-right"},Be={class:"text-bold"},Ae={class:"text--2"},Ee={class:"text-center"},Re={class:"text-h6"},qe={class:"text-h6"},Ne={class:"text--2"},Oe={class:"row items-start justify-between"},$e={class:"text-center col text-primary"},je={class:"text-center col"},Te={class:"text-center col"},Ue={class:"text-center col"},ze={class:"text-bold"},Me={class:"text-bold text-red"},kt={__name:"viewInvoice",setup(Le){const z=ae(),s=xe(),w=oe(),P=ie(),A=m(null),u=m(null),r=m([]),g=m({state:!1,notfound:[],added:[]}),d=m({val:{id:1,label:"Pieza"},opts:[{id:1,label:"Pieza"},{id:2,label:"Docena"},{id:3,label:"Caja"}]}),t=m({state:!1,val:null,edit:!1}),E=m({toDelivered:1,_supply_by:1,units:1,cost:0,total:0,comments:"",stock:0,ipack:0}),R=m({pagination:{rowsPerPage:0},columns:[{name:"code",label:"CODIGO",field:l=>l.code,align:"left"},{name:"description",label:"DESCRIPCION",field:l=>l.description,align:"left"},{name:"amount_delivered",label:"CANTIDAD",field:l=>l.pivot.units,align:"center"}]}),C=se(()=>{var l,e;return((l=d.value.val)==null?void 0:l.id)==3?t.value.val.pivot.toDelivered*t.value.val.pivot.ipack:((e=d.value.val)==null?void 0:e.id)==2?t.value.val.pivot.toDelivered*12:t.value.val.pivot.toDelivered}),M=async()=>{s.loading.show({message:"Obeteniendo Datos"});const l=await b.getInvoice(P.params.inv);l.fail?l.fail.status==401?(w.push("/distribute/invoice"),s.notify({message:"La factura ya se realizo",type:"negative",position:"center"}),s.loading.hide()):(l.fail.status=404)?(w.push("/distribute/invoice"),s.notify({message:"No existe la Factura",type:"negative",position:"center"}),s.loading.hide()):console.log(l):(console.log(l),u.value=l,r.value=l.products,s.loading.hide())},L=l=>{console.log(l);let e=r.value.findIndex(a=>a.id==l.id);console.log(e),e>=0?(t.value.val=r.value[e],console.log(t.value.val),d.value.val=d.value.opts.find(a=>a.id==t.value.val.pivot._supply_by),console.log(d.value),t.value.state=!0,t.value.edit=!0):(t.value.val=l,t.value.val.pivot=E.value,t.value.val.pivot.ipack=l.pieces,t.value.state=!0)},G=l=>{console.log(l);let e=r.value.findIndex(a=>a.id==l.id);console.log(e),e>=0?(t.value.val=r.value[e],console.log(t.value.val),d.value.val=d.value.opts.find(a=>a.id==t.value.val.pivot._supply_by),console.log(d.value),t.value.state=!0,t.value.edit=!0):(t.value.val=l,t.value.val.pivot=E.value,t.value.val.pivot.ipack=l.pieces,t.value.state=!0)},J=async()=>{s.loading.show({message:"Creando Factura"}),console.log(u.value);const l=await b.changestate(u.value);l.fail?console.log(l):(console.log(l),U.emit("order_refresh",{order:l.requisitiion}),U.emit("orderpartition_refresh",{order:l.partition}),he.invoiceFormat(l.partition),K(l.partition))},K=async l=>{const e=await b.addInvoiceFS(l);e.fail?e.fail.status==503?(s.notify({message:"No hubo conexion a cedis, Intentarlo mas tarde",type:"negative",position:"bottom"}),w.push("/distribute/invoice"),s.loading.hide()):console.log(e):(s.notify({message:`Salida Creada ${e}`,type:"positive",position:"bottom"}),w.push("/distribute/invoice"),s.loading.hide())},D=()=>{t.value={state:!1,val:null,edit:!1}},W=async()=>{s.loading.show({message:"Insertando Producto"});let l={_requisition:P.params.inv,_product:t.value.val.id,units:C.value,comments:"",stock:t.value.val.stocks.find(a=>a.id==z.session.store.id_viz).pivot.gen,amount:1,cost:t.value.val.cost,total:t.value.val.cost*C.value,_supply_by:d.value.val.id,toDelivered:t.value.val.pivot.toDelivered,checkout:1,ipack:t.value.val.pivot.ipack,_suplier:u.value.partition[0]._suplier,_suplier_id:u.value.partition[0]._suplier_id,_partition:u.value.partition[0].id};const e=await b.addProduct(l);e.fail?console.log(e):(s.loading.hide(),r.value.push(e)),D()},X=async()=>{s.loading.show({message:"Eliminando Producto"}),console.log(t.value);let l={_requisition:P.params.inv,_product:t.value.val.id};console.log(l);const e=await b.deleteProduct(l);if(e.fail)console.log(e);else{console.log(e),s.loading.hide();let a=r.value.findIndex(I=>I.id==l._product);r.value.splice(a,1)}D()},Z=async()=>{s.loading.show({message:"Editando Producto"}),console.log(t.value);let l={_requisition:P.params.inv,_product:t.value.val.id,units:C.value,comments:"",stock:t.value.val.stocks.find(a=>a.id==1).pivot.gen,amount:0,cost:t.value.val.cost,total:t.value.val.cost*C.value,_supply_by:d.value.val.id,toDelivered:t.value.val.pivot.toDelivered,checkout:1,ipack:t.value.val.pivot.ipack,_suplier:u.value.partition[0]._suplier,_suplier_id:u.value.partition[0]._suplier_id,_partition:u.value.partition[0].id};console.log(l);const e=await b.editProduct(l);if(e.fail)console.log(e);else{console.log(e),s.loading.hide();let a=r.value.findIndex(I=>I.id==l.id);console.log(t.value.val),r.value.splice(a,1,e)}D()},H=(l,e)=>{console.log(e),t.value.val=e,d.value.val=d.value.opts.find(a=>a.id==e.pivot._supply_by),t.value.state=!0,t.value.edit=!0},Y=()=>{A.value.click()},ee=async()=>{let l=document.getElementById("inputFile").files[0],e=new ye.Workbook,a={};e.xlsx.load(l).then(async I=>{let F=e.worksheets[0],te=F.getColumn("A");F.getColumn("B"),te.eachCell({includeEmpty:!0},function(_,c){if(c===1)return;let Q=_.value,le=F.getCell(`B${c}`),N=parseFloat(le.value);Q&&(a[Q]?a[Q]+=N:a[Q]=N)});let q=Object.keys(a).map(_=>({codigo:_,cantidad:a[_]}));if(q.length){let _={codes:q,_requisition:u.value};s.loading.show({message:"Procesando archivo, espera.."}),console.log(_);const c=await be.addMassiveProductsInvoice(_);c.fail?console.log(c):(console.log(c),u.value.products=c.products,r.value=c.products,g.value.state=!0,g.value.added=c.products,g.value.notfound=c.notFound,s.loading.hide())}else s.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})};return M(),(l,e)=>(p(),S($,null,[u.value?(p(),k(me,{key:0,padding:""},{default:n(()=>[o(ve,{class:"bg-primary text-white"},{default:n(()=>[o(f,{flat:"",round:"",dense:"",icon:"arrow_back ",onClick:e[0]||(e[0]=a=>ne(w).push("/distribute/invoice"))}),o(re,{class:"row"},{default:n(()=>[i("div",we,"Origen : "+v(u.value.to.name),1),i("div",Ce,"Destino : "+v(u.value.from.name),1),i("div",Pe,v(u.value.created_by.nick),1)]),_:1})]),_:1}),o(y,{spaced:"",inset:"",vertical:"",dark:""}),r.value.length>0?(p(),k(ce,{key:0,rows:r.value,"hide-bottom":"",columns:R.value.columns,pagination:R.value.pagination,onRowClick:H},null,8,["rows","columns","pagination"])):h("",!0),o(pe,{reveal:"",elevated:"",bordered:""},{default:n(()=>[o(y,{spaced:"",inset:"",vertical:"",dark:""}),i("div",De,[i("div",null,[o(f,{icon:"upload",flat:"",onClick:Y})]),o(y,{spaced:"",inset:"",vertical:"",dark:""}),o(B,{class:"col"},{default:n(()=>[o(ke,{checkState:!1,onInput:L,with_prices_Invoice:"",with_stock:"",onAgregar:G,with_locations:""})]),_:1}),o(y,{spaced:"",inset:"",vertical:"",dark:""}),i("div",null,[r.value.length>0?(p(),k(f,{key:0,flat:"",icon:"send",onClick:J})):h("",!0)])]),o(y,{spaced:"",inset:"",vertical:"",dark:""})]),_:1})]),_:1})):h("",!0),o(O,{modelValue:t.value.state,"onUpdate:modelValue":e[4]||(e[4]=a=>t.value.state=a),position:"bottom"},{default:n(()=>[t.value.val?(p(),k(B,{key:0},{default:n(()=>[o(x,{class:""},{default:n(()=>[i("div",Ie,[i("div",Qe,[i("div",Ve,"ID: "+v(t.value.val.id),1),i("div",Fe,v(t.value.val.code),1)]),i("div",Se,[i("div",Be,v(t.value.val.name),1),i("div",Ae,v(t.value.val.barcode),1)])])]),_:1}),o(y),o(x,null,{default:n(()=>[V(v(t.value.val.description),1)]),_:1}),o(x,{class:"row justify-around items-center"},{default:n(()=>[i("div",Ee,[i("div",Re,v(t.value.val.pieces),1),e[6]||(e[6]=i("div",{class:"text--2"},"PxC",-1))]),(p(!0),S($,null,de(t.value.val.stocks,a=>(p(),S("div",{key:a.id,class:"text-center"},[i("div",qe,v(a.pivot.gen),1),i("div",Ne,v(a.alias),1)]))),128))]),_:1}),o(x,null,{default:n(()=>[i("div",Oe,[i("div",$e,[o(fe,{modelValue:d.value.val,"onUpdate:modelValue":e[1]||(e[1]=a=>d.value.val=a),options:d.value.opts,label:"Unidad Medida",filled:"",dense:""},null,8,["modelValue","options"])]),i("div",je,[e[7]||(e[7]=i("div",null,"Conteo",-1)),o(j,{dense:"",borderless:"",modelValue:t.value.val.pivot.toDelivered,"onUpdate:modelValue":e[2]||(e[2]=a=>t.value.val.pivot.toDelivered=a),type:"number",min:"0","input-class":"text-h6 text-center",ref:"iptcounter"},null,8,["modelValue"])]),i("div",Te,[e[8]||(e[8]=i("div",null,"PxC",-1)),o(j,{dense:"",borderless:"",modelValue:t.value.val.pivot.ipack,"onUpdate:modelValue":e[3]||(e[3]=a=>t.value.val.pivot.ipack=a),type:"number","input-class":"text-h6 text-center",disable:d.value.val.id!=3},null,8,["modelValue","disable"])]),i("div",Ue,[e[9]||(e[9]=i("div",null,"Piezas",-1)),i("div",ze,v(C.value),1)])])]),_:1}),o(T,null,{default:n(()=>[o(f,{flat:"",icon:"close",onClick:D}),o(ge),t.value.edit?h("",!0):(p(),k(f,{key:0,flat:"",icon:"add",color:"positive",onClick:W})),t.value.edit?(p(),k(f,{key:1,flat:"",icon:"delete",color:"negative",onClick:X})):h("",!0),t.value.edit?(p(),k(f,{key:2,flat:"",icon:"edit",color:"warning",onClick:Z})):h("",!0)]),_:1})]),_:1})):h("",!0)]),_:1},8,["modelValue"]),o(O,{modelValue:g.value.state,"onUpdate:modelValue":e[5]||(e[5]=a=>g.value.state=a),persistent:""},{default:n(()=>[o(B,null,{default:n(()=>[o(x,{class:"text-center text-h5 text-bold"},{default:n(()=>e[10]||(e[10]=[V(" Resultados de Importacion ")])),_:1}),o(x,{class:"text-centet text-h6 text-bold"},{default:n(()=>[V(" Correctos: "+v(g.value.added.length),1)]),_:1}),o(x,null,{default:n(()=>[e[11]||(e[11]=V(" Modelos sin Coincidencia: ")),i("span",Me,v(g.value.notfound),1)]),_:1}),o(T,{align:"right"},{default:n(()=>[ue(o(f,{flat:"",label:"OK",color:"primary"},null,512),[[_e]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i("input",{type:"file",ref_key:"inputFile",ref:A,id:"inputFile",onInput:ee,hidden:"",accept:".xlsx,.xls"},null,544)],64))}};export{kt as default};

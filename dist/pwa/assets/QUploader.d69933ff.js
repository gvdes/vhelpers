import{r as q,c as y,t as oe,v as re,B as ne,V as ce,j as v,A as pe,x as ve,aR as fe,l as me,m as _e,aS as ge,q as Fe,aN as he,T as ae,S as be,Q as te,i as ye,aM as qe}from"./index.37883b8c.js";import{Q as Se}from"./QCircularProgress.9bea1190.js";import{i as ze,j as xe}from"./use-key-composition.56eb4ad7.js";import{n as le}from"./QSelect.52efbb9f.js";function M(u,g,o,l){const r=[];return u.forEach(f=>{l(f)===!0?r.push(f):g.push({failedPropValidation:o,file:f})}),r}function H(u){u&&u.dataTransfer&&(u.dataTransfer.dropEffect="copy"),ne(u)}const Ue={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},we=["rejected"];function ke({editable:u,dnd:g,getFileInput:o,addFilesToQueue:l}){const{props:r,emit:f,proxy:R}=oe(),x=q(null),A=y(()=>r.accept!==void 0?r.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),j=y(()=>parseInt(r.maxFiles,10)),C=y(()=>parseInt(r.maxTotalSize,10));function O(t){if(u.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&re(t);else{const h=o();h&&h!==t.target&&h.click(t)}}function E(t){u.value&&t&&l(null,t)}function L(t,h,P,T){let i=Array.from(h||t.target.files);const p=[],z=()=>{p.length!==0&&f("rejected",p)};if(r.accept!==void 0&&A.value.indexOf("*/")===-1&&(i=M(i,p,"accept",s=>A.value.some(_=>s.type.toUpperCase().startsWith(_)||s.name.toUpperCase().endsWith(_))),i.length===0))return z();if(r.maxFileSize!==void 0){const s=parseInt(r.maxFileSize,10);if(i=M(i,p,"max-file-size",_=>_.size<=s),i.length===0)return z()}if(r.multiple!==!0&&i.length!==0&&(i=[i[0]]),i.forEach(s=>{s.__key=s.webkitRelativePath+s.lastModified+s.name+s.size}),T===!0){const s=P.map(_=>_.__key);i=M(i,p,"duplicate",_=>s.includes(_.__key)===!1)}if(i.length===0)return z();if(r.maxTotalSize!==void 0){let s=T===!0?P.reduce((_,w)=>_+w.size,0):0;if(i=M(i,p,"max-total-size",_=>(s+=_.size,s<=C.value)),i.length===0)return z()}if(typeof r.filter=="function"){const s=r.filter(i);i=M(i,p,"filter",_=>s.includes(_))}if(r.maxFiles!==void 0){let s=T===!0?P.length:0;if(i=M(i,p,"max-files",()=>(s++,s<=j.value)),i.length===0)return z()}if(z(),i.length!==0)return i}function e(t){H(t),g.value!==!0&&(g.value=!0)}function m(t){ne(t),(t.relatedTarget!==null||ce.is.safari!==!0?t.relatedTarget!==x.value:document.elementsFromPoint(t.clientX,t.clientY).includes(x.value)===!1)===!0&&(g.value=!1)}function S(t){H(t);const h=t.dataTransfer.files;h.length!==0&&l(null,h),g.value=!1}function c(t){if(g.value===!0)return v("div",{ref:x,class:`q-${t}__dnd absolute-full`,onDragenter:H,onDragover:H,onDragleave:m,onDrop:S})}return Object.assign(R,{pickFiles:O,addFiles:E}),{pickFiles:O,addFiles:E,onDragover:e,onDragleave:m,processFiles:L,getDndNode:c,maxFilesNumber:j,maxTotalSizeNumber:C}}function ue(u){return(u*100).toFixed(2)+"%"}const Be={...ze,...Ue,label:String,color:String,textColor:String,square:Boolean,flat:Boolean,bordered:Boolean,noThumbnails:Boolean,thumbnailFit:{type:String,default:"cover"},autoUpload:Boolean,hideUploadBtn:Boolean,disable:Boolean,readonly:Boolean},ie=[...we,"start","finish","added","removed"];function Re(u,g){const o=oe(),{props:l,slots:r,emit:f,proxy:R}=o,{$q:x}=R,A=xe(l,x);function j(a,d,F){if(a.__status=d,d==="idle"){a.__uploaded=0,a.__progress=0,a.__sizeLabel=le(a.size),a.__progressLabel="0.00%";return}if(d==="failed"){R.$forceUpdate();return}a.__uploaded=d==="uploaded"?a.size:F,a.__progress=d==="uploaded"?1:Math.min(.9999,a.__uploaded/a.size),a.__progressLabel=ue(a.__progress),R.$forceUpdate()}const C=y(()=>l.disable!==!0&&l.readonly!==!0),O=q(!1),E=q(null),L=q(null),e={files:q([]),queuedFiles:q([]),uploadedFiles:q([]),uploadedSize:q(0),updateFileStatus:j,isAlive:()=>pe(o)===!1},{pickFiles:m,addFiles:S,onDragover:c,onDragleave:t,processFiles:h,getDndNode:P,maxFilesNumber:T,maxTotalSizeNumber:i}=ke({editable:C,dnd:O,getFileInput:K,addFilesToQueue:J});Object.assign(e,u({props:l,slots:r,emit:f,helpers:e,exposeApi:a=>{Object.assign(e,a)}})),e.isBusy===void 0&&(e.isBusy=q(!1));const p=q(0),z=y(()=>p.value===0?0:e.uploadedSize.value/p.value),s=y(()=>ue(z.value)),_=y(()=>le(p.value)),w=y(()=>C.value===!0&&e.isUploading.value!==!0&&(l.multiple===!0||e.queuedFiles.value.length===0)&&(l.maxFiles===void 0||e.files.value.length<T.value)&&(l.maxTotalSize===void 0||p.value<i.value)),n=y(()=>C.value===!0&&e.isBusy.value!==!0&&e.isUploading.value!==!0&&e.queuedFiles.value.length!==0);ve(fe,V);const N=y(()=>"q-uploader column no-wrap"+(A.value===!0?" q-uploader--dark q-dark":"")+(l.bordered===!0?" q-uploader--bordered":"")+(l.square===!0?" q-uploader--square no-border-radius":"")+(l.flat===!0?" q-uploader--flat no-shadow":"")+(l.disable===!0?" disabled q-uploader--disable":"")+(O.value===!0?" q-uploader--dnd":"")),D=y(()=>"q-uploader__header"+(l.color!==void 0?` bg-${l.color}`:"")+(l.textColor!==void 0?` text-${l.textColor}`:""));me(e.isUploading,(a,d)=>{d===!1&&a===!0?f("start"):d===!0&&a===!1&&f("finish")});function I(){l.disable===!1&&(e.abort(),e.uploadedSize.value=0,p.value=0,G(),e.files.value=[],e.queuedFiles.value=[],e.uploadedFiles.value=[])}function U(){l.disable===!1&&Y(["uploaded"],()=>{e.uploadedFiles.value=[]})}function W(){Y(["idle","failed"],({size:a})=>{p.value-=a,e.queuedFiles.value=[]})}function Y(a,d){if(l.disable===!0)return;const F={files:[],size:0},k=e.files.value.filter(b=>a.indexOf(b.__status)===-1?!0:(F.size+=b.size,F.files.push(b),b.__img!==void 0&&window.URL.revokeObjectURL(b.__img.src),!1));F.files.length!==0&&(e.files.value=k,d(F),f("removed",F.files))}function X(a){l.disable||(a.__status==="uploaded"?e.uploadedFiles.value=e.uploadedFiles.value.filter(d=>d.__key!==a.__key):a.__status==="uploading"?a.__abort():p.value-=a.size,e.files.value=e.files.value.filter(d=>d.__key!==a.__key?!0:(d.__img!==void 0&&window.URL.revokeObjectURL(d.__img.src),!1)),e.queuedFiles.value=e.queuedFiles.value.filter(d=>d.__key!==a.__key),f("removed",[a]))}function G(){e.files.value.forEach(a=>{a.__img!==void 0&&window.URL.revokeObjectURL(a.__img.src)})}function K(){return L.value||E.value.getElementsByClassName("q-uploader__input")[0]}function J(a,d){const F=h(a,d,e.files.value,!0),k=K();k!=null&&(k.value=""),F!==void 0&&(F.forEach(b=>{if(e.updateFileStatus(b,"idle"),p.value+=b.size,l.noThumbnails!==!0&&b.type.toUpperCase().startsWith("IMAGE")){const ee=new Image;ee.src=window.URL.createObjectURL(b),b.__img=ee}}),e.files.value=e.files.value.concat(F),e.queuedFiles.value=e.queuedFiles.value.concat(F),f("added",F),l.autoUpload===!0&&e.upload())}function Z(){n.value===!0&&e.upload()}function $(a,d,F){if(a===!0){const k={type:"a",key:d,icon:x.iconSet.uploader[d],flat:!0,dense:!0};let b;return d==="add"?(k.onClick=m,b=V):k.onClick=F,v(te,k,b)}}function V(){return v("input",{ref:L,class:"q-uploader__input overflow-hidden absolute-full",tabindex:-1,type:"file",title:"",accept:l.accept,multiple:l.multiple===!0?"multiple":void 0,capture:l.capture,onMousedown:re,onClick:m,onChange:J})}function se(){return r.header!==void 0?r.header(Q):[v("div",{class:"q-uploader__header-content column"},[v("div",{class:"flex flex-center no-wrap q-gutter-xs"},[$(e.queuedFiles.value.length!==0,"removeQueue",W),$(e.uploadedFiles.value.length!==0,"removeUploaded",U),e.isUploading.value===!0?v(ae,{class:"q-uploader__spinner"}):null,v("div",{class:"col column justify-center"},[l.label!==void 0?v("div",{class:"q-uploader__title"},[l.label]):null,v("div",{class:"q-uploader__subtitle"},[_.value+" / "+s.value])]),$(w.value,"add"),$(l.hideUploadBtn===!1&&n.value===!0,"upload",e.upload),$(e.isUploading.value,"clear",e.abort)])])]}function de(){return r.list!==void 0?r.list(Q):e.files.value.map(a=>v("div",{key:a.__key,class:"q-uploader__file relative-position"+(l.noThumbnails!==!0&&a.__img!==void 0?" q-uploader__file--img":"")+(a.__status==="failed"?" q-uploader__file--failed":a.__status==="uploaded"?" q-uploader__file--uploaded":""),style:l.noThumbnails!==!0&&a.__img!==void 0?{backgroundImage:'url("'+a.__img.src+'")',backgroundSize:l.thumbnailFit}:null},[v("div",{class:"q-uploader__file-header row flex-center no-wrap"},[a.__status==="failed"?v(be,{class:"q-uploader__file-status",name:x.iconSet.type.negative,color:"negative"}):null,v("div",{class:"q-uploader__file-header-content col"},[v("div",{class:"q-uploader__title"},[a.name]),v("div",{class:"q-uploader__subtitle row items-center no-wrap"},[a.__sizeLabel+" / "+a.__progressLabel])]),a.__status==="uploading"?v(Se,{value:a.__progress,min:0,max:1,indeterminate:a.__progress===0}):v(te,{round:!0,dense:!0,flat:!0,icon:x.iconSet.uploader[a.__status==="uploaded"?"done":"clear"],onClick:()=>{X(a)}})])]))}_e(()=>{e.isUploading.value===!0&&e.abort(),e.files.value.length!==0&&G()});const Q={};for(const a in e)ge(e[a])===!0?Fe(Q,a,()=>e[a].value):Q[a]=e[a];return Object.assign(Q,{upload:Z,reset:I,removeUploadedFiles:U,removeQueuedFiles:W,removeFile:X,pickFiles:m,addFiles:S}),he(Q,{canAddFiles:()=>w.value,canUpload:()=>n.value,uploadSizeLabel:()=>_.value,uploadProgressLabel:()=>s.value}),g({...e,upload:Z,reset:I,removeUploadedFiles:U,removeQueuedFiles:W,removeFile:X,pickFiles:m,addFiles:S,canAddFiles:w,canUpload:n,uploadSizeLabel:_,uploadProgressLabel:s}),()=>{const a=[v("div",{class:D.value},se()),v("div",{class:"q-uploader__list scroll"},de()),P("uploader")];e.isBusy.value===!0&&a.push(v("div",{class:"q-uploader__overlay absolute-full flex flex-center"},[v(ae)]));const d={ref:E,class:N.value};return w.value===!0&&Object.assign(d,{onDragover:c,onDragleave:t}),v("div",d,a)}}const je=()=>!0;function Ce(u){const g={};return u.forEach(o=>{g[o]=je}),g}const Ee=Ce(ie);var Le=({name:u,props:g,emits:o,injectPlugin:l})=>ye({name:u,props:{...Be,...g},emits:qe(o)===!0?{...Ee,...o}:[...ie,...o],setup(r,{expose:f}){return Re(l,f)}});function B(u){return typeof u=="function"?u:()=>u}const Pe="QUploader",Te={url:[Function,String],method:{type:[Function,String],default:"POST"},fieldName:{type:[Function,String],default:()=>u=>u.name},headers:[Function,Array],formFields:[Function,Array],withCredentials:[Function,Boolean],sendRaw:[Function,Boolean],batch:[Function,Boolean],factory:Function},Oe=["factoryFailed","uploaded","failed","uploading"];function Ne({props:u,emit:g,helpers:o}){const l=q([]),r=q([]),f=q(0),R=y(()=>({url:B(u.url),method:B(u.method),headers:B(u.headers),formFields:B(u.formFields),fieldName:B(u.fieldName),withCredentials:B(u.withCredentials),sendRaw:B(u.sendRaw),batch:B(u.batch)})),x=y(()=>f.value>0),A=y(()=>r.value.length!==0);let j;function C(){l.value.forEach(e=>{e.abort()}),r.value.length!==0&&(j=!0)}function O(){const e=o.queuedFiles.value.slice(0);o.queuedFiles.value=[],R.value.batch(e)?E(e):e.forEach(m=>{E([m])})}function E(e){if(f.value++,typeof u.factory!="function"){L(e,{});return}const m=u.factory(e);if(!m)g("factoryFailed",new Error("QUploader: factory() does not return properly"),e),f.value--;else if(typeof m.catch=="function"&&typeof m.then=="function"){r.value.push(m);const S=c=>{o.isAlive()===!0&&(r.value=r.value.filter(t=>t!==m),r.value.length===0&&(j=!1),o.queuedFiles.value=o.queuedFiles.value.concat(e),e.forEach(t=>{o.updateFileStatus(t,"failed")}),g("factoryFailed",c,e),f.value--)};m.then(c=>{j===!0?S(new Error("Aborted")):o.isAlive()===!0&&(r.value=r.value.filter(t=>t!==m),L(e,c))}).catch(S)}else L(e,m||{})}function L(e,m){const S=new FormData,c=new XMLHttpRequest,t=(n,N)=>m[n]!==void 0?B(m[n])(N):R.value[n](N),h=t("url",e);if(!h){console.error("q-uploader: invalid or no URL specified"),f.value--;return}const P=t("formFields",e);P!==void 0&&P.forEach(n=>{S.append(n.name,n.value)});let T=0,i=0,p=0,z=0,s;c.upload.addEventListener("progress",n=>{if(s===!0)return;const N=Math.min(z,n.loaded);o.uploadedSize.value+=N-p,p=N;let D=p-i;for(let I=T;D>0&&I<e.length;I++){const U=e[I];if(D>U.size)D-=U.size,T++,i+=U.size,o.updateFileStatus(U,"uploading",U.size);else{o.updateFileStatus(U,"uploading",D);return}}},!1),c.onreadystatechange=()=>{c.readyState<4||(c.status&&c.status<400?(o.uploadedFiles.value=o.uploadedFiles.value.concat(e),e.forEach(n=>{o.updateFileStatus(n,"uploaded")}),g("uploaded",{files:e,xhr:c})):(s=!0,o.uploadedSize.value-=p,o.queuedFiles.value=o.queuedFiles.value.concat(e),e.forEach(n=>{o.updateFileStatus(n,"failed")}),g("failed",{files:e,xhr:c})),f.value--,l.value=l.value.filter(n=>n!==c))},c.open(t("method",e),h),t("withCredentials",e)===!0&&(c.withCredentials=!0);const _=t("headers",e);_!==void 0&&_.forEach(n=>{c.setRequestHeader(n.name,n.value)});const w=t("sendRaw",e);e.forEach(n=>{o.updateFileStatus(n,"uploading",0),w!==!0&&S.append(t("fieldName",n),n,n.name),n.xhr=c,n.__abort=()=>{c.abort()},z+=n.size}),g("uploading",{files:e,xhr:c}),l.value.push(c),w===!0?c.send(new Blob(e)):c.send(S)}return{isUploading:x,isBusy:A,abort:C,upload:O}}var Ae={name:Pe,props:Te,emits:Oe,injectPlugin:Ne},$e=Le(Ae);export{$e as Q};

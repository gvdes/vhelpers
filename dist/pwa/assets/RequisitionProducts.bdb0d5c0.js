import{Q as H}from"./QToolbarTitle.7571f6bf.js";import{u as K,r as h,o as L,d as j,w as z,e as b,a1 as Z,j as W,k as ee,g as te}from"./index.0f414ca4.js";import{Q as ae}from"./QToolbar.877f12c4.js";import{Q as le}from"./QTable.9cc49d0e.js";import{Q as oe}from"./QPage.75f2c40d.js";import{E as Y}from"./exceljs.min.9e24d01d.js";import{u as ne}from"./use-quasar.14d0dc13.js";import"./dayjs.min.cbcf888d.js";import{p as se}from"./productsApi.acbc20a4.js";import{u as re}from"./ProductsStore.135bc3e2.js";import"./QList.a2313392.js";import"./QSelect.c7572951.js";import"./QLinearProgress.5458103b.js";import"./_commonjsHelpers.88e99c8f.js";import"./axios.ca582435.js";const Pe={__name:"RequisitionProducts",setup(ie){const N=ne();K(),re().setTitle("Pedido Proveedor");const P=h(null);h([]);const c=h({state:!1,data:[]}),p=h({columns:[{name:"code",label:"Codigo",field:e=>e.code,sortable:!0,align:"left"},{name:"description",label:"Descripcion",field:e=>e.description,sortable:!0,align:"left"},{name:"barcode",label:"CB",field:e=>e.barcode,sortable:!0,align:"left"},{name:"section",label:"Seccion",field:e=>{var a,o,d;return(d=(o=(a=e.category)==null?void 0:a.familia)==null?void 0:o.seccion)==null?void 0:d.name},sortable:!0,align:"left"},{name:"family",label:"Familia",field:e=>{var a,o;return(o=(a=e.category)==null?void 0:a.familia)==null?void 0:o.name},sortable:!0,align:"left"},{name:"category",label:"Categoria",field:e=>{var a;return(a=e.category)==null?void 0:a.name},sortable:!0,align:"left"},{name:"pxc",label:"PXC",field:e=>e.pieces,sortable:!0,align:"left"},{name:"salesant",label:"Venta 2024",field:e=>e.salesant,sortable:!0,align:"left"},{name:"purchases",label:"Compra",field:e=>e.compras,sortable:!0,align:"left"},{name:"sales",label:"Venta",field:e=>e.sales,sortable:!0,align:"left"},{name:"stock",label:"Stock",field:e=>e.stock,sortable:!0,align:"left"},{name:"ventstock",label:"Venta+Stock",field:e=>e.ventstock,sortable:!0,align:"left"},{name:"diference",label:"Diferencia",field:e=>e.dif,sortable:!0,align:"left"},{name:"cedis",label:"Cedis",field:e=>e.stockCedis,sortable:!0,align:"left"},{name:"texcoco",label:"Texcoco",field:e=>e.stockTexcoco,sortable:!0,align:"left"},{name:"stockcedis",label:"Stock Cedis",field:e=>e.stocksCed,sortable:!0,align:"left"},{name:"min",label:"Min",field:e=>e.min,sortable:!0,align:"left"},{name:"max",label:"Max",field:e=>e.max,sortable:!0,align:"left"},{name:"faltantes",label:"Faltantes",field:e=>e.faltantes,sortable:!0,align:"left"},{name:"pedir",label:"Pedir",field:e=>e.pedir,sortable:!0,align:"left"},{name:"apartado",label:"Apartado",field:e=>e.invProvider,sortable:!0,align:"left"}]}),$=()=>{P.value.click()},q=async()=>{let e=document.getElementById("inputFile").files[0],a=new Y.Workbook,o={};a.xlsx.load(e).then(async d=>{let g=a.worksheets[0],n=g.getColumn("A");g.getColumn("B"),n.eachCell({includeEmpty:!0},function(r,l){if(l===1)return;let t=r.value,u=g.getCell(`B${l}`),k=parseFloat(u.value);t&&(o[t]?o[t]+=k:o[t]=k)});let s=Object.keys(o).map(r=>({codigo:r,cantidad:o[r]}));if(s.length){let r={codes:s};N.loading.show({message:"Procesando archivo, espera.."}),console.log(r);const l=await se.getReportProvider(r);l.fail?console.log(l):(console.log(l),c.value.data=l.map(t=>{var M,R,_,T,A,E,V,D;const u=((R=(M=t.stocks)==null?void 0:M.find(C=>C.id===1))==null?void 0:R.pivot)||{},k=((T=(_=t.stocks)==null?void 0:_.find(C=>C.id===2))==null?void 0:T.pivot)||{},v=Number(t.pieces||1),m=Math.round(t.SalesSubYear/t.pieces),O=Math.round(t.PurchaseYear/t.pieces),S=Math.round(t.SalesYear/t.pieces),B=Math.round(t.SumStock/t.pieces),w=Number(S)+Number(B),U=Number(m)-Number(w),F=Math.round(((A=u.stock)!=null?A:0)/v),Q=Math.round(((E=k.stock)!=null?E:0)/v),i=Number(F)+Number(Q),x=Math.round(((V=u.min)!=null?V:0)/v),y=Math.round(((D=u.max)!=null?D:0)/v),J=Number(m)-Number(w),X=Number(m)<=8&&Number(i)<=8&&Number(Number(i)<=Number(x)?Number(y)-Number(i):0)==0?10:0,f=Number(i)<=Number(x)?Number(y)-Number(i):X,G=Number(m)<=8&&Number(i)<=8&&Number(Number(f)<=t.invProvider?Number(f):t.invProvider)==0?10:Number(f)<=t.invProvider?Number(f):t.invProvider;return{...t,salesant:m,compras:O,sales:S,stock:B,ventstock:w,diference:U,stockCedis:F,stockTexcoco:Q,stocksCed:i,min:x,max:y,dif:J,faltantes:f,pedir:G}}),c.value.state=!0,N.loading.hide())}else N.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},I=e=>{console.log(e);const a=new Y.Workbook,o=a.addWorksheet("Reporte");p.value.columns.map(n=>({name:n.name,filterButton:!0}));const d=e.map(n=>p.value.columns.map(s=>{try{return typeof s.field=="function"?s.field(n):n[s.field]}catch{return""}}));o.addTable({name:"ReporteAlta",ref:"A1",headerRow:!0,style:{showRowStripes:!0},columns:p.value.columns.map(n=>({name:n.label,filterButton:!0})),rows:d}),o.columns.forEach(n=>{let s=0;n.eachCell({includeEmpty:!0},r=>{const l=r.value?r.value.toString().length:10;l>s&&(s=l)}),n.width=s<10?10:s}),(async()=>{const n=await a.xlsx.writeBuffer(),s=new Blob([n],{type:"application/octet-stream"}),r=URL.createObjectURL(s),l=document.createElement("a");l.href=r,l.download="Reporte.xlsx",document.body.appendChild(l),l.click(),document.body.removeChild(l)})()};return(e,a)=>(L(),j(oe,{padding:""},{default:z(()=>[b(ae,null,{default:z(()=>[b(H),b(Z,{spaced:"",inset:"",vertical:"",dark:""}),b(W,{flat:"",round:"",dense:"",icon:"upload_file",size:"lg",onClick:$,title:"Subir Archivo"}),b(W,{flat:"",round:"",dense:"",icon:"download",size:"lg",onClick:a[0]||(a[0]=o=>I(c.value.data)),title:"Descargar Archivo",disable:c.value.data.length==0},null,8,["disable"])]),_:1}),c.value.state?(L(),j(le,{key:0,rows:c.value.data,columns:p.value.columns},null,8,["rows","columns"])):ee("",!0),te("input",{type:"file",ref_key:"inputFile",ref:P,id:"inputFile",onInput:q,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1}))}};export{Pe as default};

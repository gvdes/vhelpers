import{aH as se,a as oe,u as le,r as x,o as y,d as P,w as d,h as B,f as s,e as o,a1 as p,Q as w,a0 as r,g as D,a2 as O,a3 as z,ak as g,a4 as R,S as ae,bd as ie}from"./index.5bb28a0a.js";import{d as de,Q as j}from"./QSelect.772f451f.js";import{Q as b}from"./QCardSection.90e8692b.js";import{Q as $}from"./QCard.6be7857a.js";import{b as k,Q as U,a as ne}from"./QList.154f30c0.js";import{Q as re}from"./QExpansionItem.8f079acc.js";import{Q as E}from"./QCardActions.d4f6ccbe.js";import{Q as ue}from"./QFooter.b6be5dfe.js";import{Q as pe}from"./QPage.fa97e3db.js";import{C as M}from"./ClosePopup.72c3434b.js";import"./dayjs.min.cbcf888d.js";import"./axios.23799c3f.js";import{P as ce}from"./ProductsAutocomplete.446369be.js";import{_ as ve}from"./productView.462c24f7.js";import{o as N}from"./orderApi.c472f8e2.js";import{u as me}from"./OrderStore.7007d462.js";import{u as fe}from"./use-quasar.fd5e994b.js";import{$sktOrders as _e}from"./socket.05630e21.js";import"./use-key-composition.99e19843.js";import"./QResizeObserver.8816664c.js";import"./_commonjsHelpers.88e99c8f.js";import"./QInput.6125c91e.js";/* empty css                                                                         */import"./QSpace.96c1fada.js";import"./resoursesOrder.2800390e.js";const xe={class:"row items-center justify-between bg-primary text-white q-py-xs q-px-sm"},ye={class:"row items-center col"},ge={class:"q-pa-xs col text-center"},be={class:"text-body2 text-bold"},he={class:"q-pa-xs col text-center"},we={class:"text-body2 text-bold"},ke={class:"row items-center justify-between q-mt-xs"},Qe={class:"row text-center"},Ve={class:"q-px-md col"},Ce={class:"text-body2 text-bold"},qe={class:"q-px-md col"},Pe={class:"text-body2 text-bold"},$e={class:"q-px-md col"},Se={class:"text-body2 text-bold"},Ie={class:"row full-width items-center justify-between q-py-sm"},Fe={class:"text-bold"},Be=["onClick"],De={class:"row items-center"},Ue={class:"col q-pr-sm"},Ae={class:"row items-center justify-between"},Oe={class:"text-caption text-right text-grey-6"},ze={class:"text--2 text-grey-6"},Re={class:"col text--2 text-caption"},je={class:"text--2 text-amber-13"},Ee={class:"text-right"},Me={class:"text-caption text-bold"},Ne={class:"text-caption"},Te={class:"text-bold text-red"},Le={class:"row q-ml-sm"},yt={__name:"Viewpreorders",setup(Ge){const T=se(),S=oe(),n=me();n.setshowLyt(!1);const v=fe(),I=le(),i=x(null),L=x({opts:[],val:null}),u=x({state:!1,val:null,edit:!1}),m=x({state:!1,notfound:[],added:[]}),G=x(null),Q=x({amount:1,amountDelivered:0,price:0,toDelivered:0,total:0,units:1,_price_list:1,_supply_by:1}),C=x({state:!1,val:null,opts:[]}),H=async()=>{v.loading.show({message:"Obtenidendo datos"});let l={pedido:T.params.oid,store:I.session.store.id_viz,uid:I.session.credentials.staff.id_va};const e=await N.getOrderPrv(l);e.fail?(console.log(e),(e.fail.status==401||e.fail.status==404)&&(v.notify({message:e.fail.response.data.mssg,type:"negative",position:"top"}),S.push("/preorders/pedidos"))):(console.log(e),i.value=e,v.loading.hide())},J=l=>{console.log(l);let e=i.value.products.findIndex(t=>t.id==l.id);e>=0?(l.units=n.units.opts.find(t=>t.id==l.pivot._supply_by),u.value.val=i.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=n.units.val.id,l.pivot={...Q.value},console.log(l.pivot),l.units=n.units.val,u.value.val=l,u.value.state=!0,u.value.edit=!1)},K=l=>{console.log(l);let e=i.value.products.findIndex(t=>t.id==l.id);e>=0?(l.units=n.units.opts.find(t=>t.id==l.pivot._supply_by),u.value.val=i.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=n.units.val.id,l.pivot={...Q.value},console.log(l.pivot),l.units=n.units.val,u.value.val=l,u.value.state=!0,u.value.edit=!1)},F=()=>{u.value={state:!1,val:null,edit:!1},Q.value._supply_by=1},W=l=>{i.value.products.push(l),F()},X=l=>{let e=i.value.products.findIndex(t=>t.id==l.id);e>=0&&(i.value.products.splice(e,1),F())},Y=l=>{console.log(l),console.log(L.value),l.units=n.units.opts.find(e=>e.id==l.pivot._supply_by),u.value.val=l,u.value.state=!0,u.value.edit=!0},Z=async()=>{let l=document.getElementById("inputFile").files[0],e=new ExcelJS.Workbook,t={};e.xlsx.load(l).then(async h=>{let a=e.worksheets[0],f=a.getColumn("A");a.getColumn("B"),f.eachCell({includeEmpty:!0},function(_,c){if(c===1)return;let q=_.value,te=a.getCell(`B${c}`),A=parseFloat(te.value);q&&(t[q]?t[q]+=A:t[q]=A)});let V=Object.keys(t).map(_=>({codigo:_,cantidad:t[_]}));if(V.length){let _={codes:V,_requisition:i.value.id};v.loading.show({message:"Procesando archivo, espera.."}),console.log(_);const c=await RestockApi.addMassiveProducts(_);c.fail?console.log(c):(console.log(c),i.value.products=c.products,m.value.state=!0,m.value.added=c.products,m.value.notfound=c.notFound,v.loading.hide())}else v.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},ee=async()=>{v.loading.show({message:"Mandando Pedido"});let l={id:i.value.id,_printer:n.printers.val};console.log(l);const e=await N.nextStepPrv(l);if(e.fail)console.log(e);else{console.log(e);let t={order:e.order,newstate:e.status};console.log(t),_e.emit("order_update",t),n.addOrUpdate(t),S.push("/preorders/pedidos"),v.loading.hide()}};return H(),(l,e)=>i.value?(y(),P(pe,{key:0,padding:""},{default:d(()=>[s("div",xe,[o(w,{onClick:e[0]||(e[0]=t=>p(S).push("/preorders/pedidos")),dense:"",flat:"",icon:"close",color:"white"}),s("div",ye,[s("div",ge,[e[7]||(e[7]=s("div",{class:"text-caption"},"Folio:",-1)),s("div",be,r(i.value.id),1)]),s("div",he,[e[8]||(e[8]=s("div",{class:"text-caption"},"Cliente:",-1)),s("div",we,r(i.value.name),1)])]),o(w,{icon:"settings",dense:"",flat:""},{default:d(()=>[o(de,{style:{width:"100%"}},{default:d(()=>[o($,null,{default:d(()=>[o(b,{class:"q-pa-sm"},{default:d(()=>[o(j,{modelValue:p(n).units.val,"onUpdate:modelValue":e[1]||(e[1]=t=>p(n).units.val=t),options:p(n).units.opts,label:"Pedir Por",filled:"","option-label":"name",dense:""},null,8,["modelValue","options"])]),_:1}),o(b,null,{default:d(()=>[s("div",ke,[s("div",Qe,[s("div",Ve,[e[9]||(e[9]=s("div",{class:"text-caption"},"Modelos",-1)),s("span",Ce,r(i.value.products.length),1)]),s("div",qe,[e[10]||(e[10]=s("div",{class:"text-caption"},"Unidades",-1)),s("span",Pe,r(i.value.products.reduce((t,h)=>t+Number(h.pivot.units),0)),1)]),s("div",$e,[e[11]||(e[11]=s("div",{class:"text-caption"},"Total",-1)),s("span",Se," $ "+r(i.value.products.reduce((t,h)=>t+Number(h.pivot.total),0)),1)])])])]),_:1})]),_:1})]),_:1})]),_:1})]),o(k),(y(!0),D(z,null,O(p(n).units.opts,(t,h)=>(y(),P(ne,{bordered:"",key:h},{default:d(()=>[i.value.products.filter(a=>a.pivot._supply_by==t.id).length?(y(),P(re,{key:0,"expand-separator":"","default-opened":"","header-class":"text-bold","expand-icon-class":"hidden"},{header:d(()=>[s("div",Ie,[s("div",null,[g(r(t.name.toUpperCase())+" - "+r(i.value.products.filter(a=>a.pivot._supply_by==t.id).length)+" productos ",1),o(ae,{name:"fas fa-caret-right"}),g(" "+r(i.value.products.filter(a=>a.pivot._supply_by==t.id).reduce((a,f)=>a+f.pivot.units,0))+" pzs ",1)]),s("div",Fe,"$ "+r(i.value.products.filter(a=>a.pivot._supply_by==t.id).reduce((a,f)=>a+f.pivot.total,0)),1)])]),default:d(()=>[o(k),o(ie,{appear:"","enter-active-class":"animated zoomIn","leave-active-class":"animated zoomOut"},{default:d(()=>[(y(!0),D(z,null,O(i.value.products.filter(a=>a.pivot._supply_by==t.id),(a,f)=>(y(),D("div",{key:f,class:"q-py-md q-px-sm wrapper_prod",onClick:V=>Y(a)},[s("div",De,[s("div",Ue,[s("div",Ae,[s("div",null,[s("span",null,r(a.code),1),e[12]||(e[12]=g(" -- ")),s("span",null,r(a.name),1)]),s("span",Oe,r(a.category.familia.name)+" (pxc "+r(a.pieces)+")",1)]),e[13]||(e[13]=s("div",{class:"text--3 text-uppercase text-italic"},null,-1)),s("div",ze,r(a.description),1),s("div",Re,r(a._supply_by!=1?`(${a.pivot.units} pzs)`:"")+", PU: $"+r(a.pivot.price),1),s("div",je,r(a.pivot.comments),1)]),s("div",Ee,[s("div",Me,"$ "+r(a.pivot.total),1),s("div",Ne,r(a.prices.find(V=>V.id==a.pivot._price_list).name),1)])]),o(k)],8,Be))),128))]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1024))),128)),o(U,{modelValue:C.value.state,"onUpdate:modelValue":e[3]||(e[3]=t=>C.value.state=t),persistent:""},{default:d(()=>[o($,null,{default:d(()=>[o(b,{class:"row items-center bg-primary text-white text-h6"},{default:d(()=>e[14]||(e[14]=[g(" Selecciona Impresora ")])),_:1}),o(b,{class:""},{default:d(()=>[o(j,{modelValue:p(n).printers.val,"onUpdate:modelValue":e[2]||(e[2]=t=>p(n).printers.val=t),options:p(n).printers.opts.filter(t=>t._type==1),label:"Impresoras","option-label":"name",filled:""},null,8,["modelValue","options"])]),_:1}),o(E,{align:"right"},{default:d(()=>[R(o(w,{flat:"",label:"Cancelar",color:"primary"},null,512),[[M]]),o(w,{flat:"",label:"Terminar",color:"primary",onClick:ee,disabled:!p(n).printers.val},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(U,{modelValue:u.value.state,"onUpdate:modelValue":e[4]||(e[4]=t=>u.value.state=t),persistent:"",position:"bottom"},{default:d(()=>[o(ve,{product:u.value.val,order:i.value,edit:u.value.edit,onReset:F,products:i.value.products,rules:p(n).rules,onAddProduct:W,onDeleteProduct:X,units:p(n).units.opts,unit:p(n).units.val},null,8,["product","order","edit","products","rules","units","unit"])]),_:1},8,["modelValue"]),o(U,{modelValue:m.value.state,"onUpdate:modelValue":e[5]||(e[5]=t=>m.value.state=t),persistent:""},{default:d(()=>[o($,null,{default:d(()=>[o(b,{class:"text-center text-h5 text-bold"},{default:d(()=>e[15]||(e[15]=[g(" Resultados de Importacion ")])),_:1}),o(b,{class:"text-centet text-h6 text-bold"},{default:d(()=>[g(" Correctos: "+r(m.value.added.length),1)]),_:1}),o(b,null,{default:d(()=>[e[16]||(e[16]=g(" Modelos sin Coincidencia: ")),s("span",Te,r(m.value.notfound),1)]),_:1}),o(E,{align:"right"},{default:d(()=>[R(o(w,{flat:"",label:"OK",color:"primary"},null,512),[[M]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(ue,{reveal:"",elevated:"",bordered:""},{default:d(()=>[o(k,{spaced:"",inset:"",vertical:"",dark:""}),s("div",Le,[o($,{class:"col"},{default:d(()=>[o(ce,{checkState:!1,onInput:K,with_prices:"",onAgregar:J,"workpoint-status":[1,2,p(I).session.store.id_viz]},null,8,["workpoint-status"])]),_:1}),o(k,{spaced:"",inset:"",vertical:"",dark:""}),s("div",null,[i.value.products.length>0?(y(),P(w,{key:0,flat:"",icon:"send",onClick:e[6]||(e[6]=t=>C.value.state=!C.value.state)})):B("",!0)])]),o(k,{spaced:"",inset:"",vertical:"",dark:""})]),_:1}),s("input",{type:"file",ref_key:"inputFile",ref:G,id:"inputFile",onInput:Z,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1})):B("",!0)}};export{yt as default};

import{b,Q as M}from"./QList.ecf6eee6.js";import{Q as T}from"./QHeader.cdd5ae2d.js";import{u as j,r as d,c as _,o as h,d as P,w as m,e as r,f as S,Q as f,g as x,h as C,n as N}from"./index.29a7510c.js";import{Q as E}from"./QTable.167fd68a.js";import{Q as O}from"./QPage.68d1400a.js";import{Q as U,a as H}from"./QLayout.0551e906.js";import{_ as F}from"./UserToolbar.bc845689.js";import"./QInput.afbc4f4d.js";import"./QSelect.5b60334f.js";import"./axios.26170d2e.js";import{u as I}from"./use-quasar.8111abfa.js";/* empty css                                                                         */import{_ as J}from"./OptionsLabels.1da6c6db.js";import{p as W}from"./productsApi.5253512e.js";import{d as D}from"./dayjs.min.cbcf888d.js";import{E as G}from"./exceljs.min.9e24d01d.js";import"./jspdf.plugin.autotable.c8baa443.js";import"./browser.c61f550a.js";import{H as K}from"./html5-qrcode-scanner.64619f17.js";import"./QCard.8f8c3142.js";import"./QResizeObserver.2c299db3.js";import"./QLinearProgress.addce488.js";import"./QCheckbox.03c4101c.js";import"./QScrollObserver.cb34d8ef.js";import"./QDrawer.e2704c03.js";import"./QCardSection.834203e9.js";import"./QCardActions.3f6112b9.js";import"./ClosePopup.7191b306.js";import"./auth.1cf543ac.js";import"./QImg.aa843f1d.js";import"./JsBarcode.cb858474.js";import"./labels.ac3f18c7.js";import"./_commonjsHelpers.88e99c8f.js";const X={class:"q-mb-md flex justify-center"},Z={key:0,id:"reader"},ee={key:1,class:"q-mt-md row"},$e={__name:"checkLavelsLYT",setup(oe){const k=j(),y=I();d([]);const p=d({state:!1}),L=d({val:[0,1,2,4],opts:[{label:"Menudeo",value:1},{label:"Mayoreo",value:2},{label:"Docena",value:3},{label:"Caja",value:4}]}),s=d([]);d([]);let n=null;const v=d(!1),g=[{name:"id",label:"Producto",field:o=>o.modelo,align:"left"},{name:"code",label:"Producto",field:o=>{var e;return(e=o.item)==null?void 0:e.code},align:"left"},{name:"description",label:"Descripcion",field:o=>{var e;return(e=o.item)==null?void 0:e.description},align:"left"},{name:"ubicacion",label:"Ubicaciones",field:o=>{var e;return(e=o.item)==null?void 0:e.locations.map(a=>a.path).join("/")},align:"left"},{name:"stock",label:"Stocks",field:o=>{var e;return(e=o.item)==null?void 0:e.stocks[0].pivot.gen},align:"left"},{name:"ult",label:"Ult.Actualizacion",field:o=>{var e;return D((e=o.update)==null?void 0:e.created_at).format("YYYY-MM-DD")},align:"center"}],B=_(()=>{var o;return(o=s.value)==null?void 0:o.filter(e=>e.status)}),u=_(()=>{var o;return(o=s.value)==null?void 0:o.filter(e=>!e.status)}),Y=_(()=>u.value.map(o=>o.item)),R=async()=>{if(y.loading.show({message:"Obteniendo Informacion"}),s.value.size===0){console.log("No hay nada brou");return}const o=s.value,e={products:o,workpoint:k.session.store.id_viz};console.log(`Enviando ${o.length} QR al backend...`);const a=await W.checkLabel(e);a.fail?console.log(a):(console.log(a),a.forEach(t=>{const l=s.value.findIndex(i=>i.modelo===t.code.id);if(l!==-1){s.value[l].status=t.status,s.value[l].item=t.code;let i=$(s.value[l].item.prices);s.value[l].item._copies=1,s.value[l].item.type=i.type,s.value[l].item.usedPrices=i.prices,s.value[l].update=t.actualizado}}),y.loading.hide())},q=()=>{if(n){console.log("La c\xE1mara ya est\xE1 activa");return}v.value=!0,N(()=>{n=new K("reader");const o={fps:10,qrbox:300};n.start({facingMode:"environment"},o,e=>{try{const a=JSON.parse(e);s.value.some(l=>l.modelo===a.modelo&&l.idChange===a.idChange)?console.log(`QR repetido ignorado: ${a.modelo}`):(s.value.push(a),console.log(`QR agregado: ${a.modelo}`))}catch{console.log("QR inv\xE1lido: "+e)}}).catch(e=>console.log("Error al iniciar c\xE1mara: "+e.message)),console.log("C\xE1mara iniciada")})},A=()=>{if(!n){console.log("La c\xE1mara no estaba activa");return}n.stop().then(()=>{n.clear(),n=null,v.value=!1,console.log("C\xE1mara detenida"),R()}).catch(o=>console.log("Error al detener c\xE1mara: "+o.message))},V=async()=>{const o=new G.Workbook,e=o.addWorksheet("ActualizaEtiquetas");e.addRow(g.map(t=>t.label)),u.value.forEach(t=>{var l,i,c,Q,w;return e.addRow([t.modelo,(l=t.item)==null?void 0:l.code,(i=t.item)==null?void 0:i.description,(c=t.item)==null?void 0:c.locations.map(z=>z.path).join("/"),(Q=t.item)==null?void 0:Q.stocks[0].pivot.gen,D((w=t.update)==null?void 0:w.created_at).format("YYYY-MM-DD")])}),(async()=>{const t=await o.xlsx.writeBuffer(),l=new Blob([t],{type:"application/octet-stream"}),i=URL.createObjectURL(l),c=document.createElement("a");c.href=i,c.download=`Comparativo${k.session.store.alias}.xlsx`,document.body.appendChild(c),c.click(),document.body.removeChild(c)})()},$=(o,e)=>{let a=[...o];const t=a.find(i=>i.pivot._type==4),l=a.find(i=>i.pivot._type==1);if(t.pivot.price==l.pivot.price){let i={id:0,alias:"OFERTA",name:"Oferta",pivot:{price:a[0].pivot.price},used:!0};return console.log("oferta"),{type:"off",prices:[i]}}else return console.log("estandar"),{type:"std",prices:a}};return(o,e)=>(h(),P(U,{view:"hHh Lpr fFf"},{default:m(()=>[r(T,{class:"bg-grey-3 text-dark",bordered:""},{default:m(()=>[r(F),r(b)]),_:1}),r(H,null,{default:m(()=>[r(O,{padding:"",class:"q-pa-md"},{default:m(()=>[S("div",X,[r(f,{label:"Iniciar Escaneo",color:"primary",onClick:q}),r(f,{label:"Detener Escaneo",color:"negative",class:"q-ml-md",onClick:A})]),v.value?(h(),x("div",Z)):C("",!0),s.value.length?(h(),x("div",ee,[r(E,{dense:"",title:"Actualizados",rows:B.value,"row-key":"code",columns:g,class:"col"},null,8,["rows"]),r(b,{spaced:"",inset:"",vertical:"",dark:""}),r(E,{dense:"",title:"Sin Actualizar",rows:u.value,"row-key":"code",columns:g,class:"col"},{"top-right":m(()=>[r(f,{color:"primary","icon-right":"archive",flat:"",onClick:V,disable:u.value.length<=0},null,8,["disable"]),r(b,{spaced:"",inset:"",vertical:"",dark:""}),r(f,{class:"col",flat:"",color:"primary",icon:"label",rounded:"",title:"Crear Etiquetas",onClick:e[0]||(e[0]=a=>p.value.state=!p.value.state)})]),_:1},8,["rows"])])):C("",!0),r(M,{modelValue:p.value.state,"onUpdate:modelValue":e[1]||(e[1]=a=>p.value.state=a),persistent:""},{default:m(()=>[r(J,{products:Y.value,prices:L.value},null,8,["products","prices"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}};export{$e as default};

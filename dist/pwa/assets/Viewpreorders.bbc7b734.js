import{Z as oe,f as ae,u as ie,r as b,a as v,h as k,i as d,p as B,k as s,d as l,a7 as c,n as h,a1 as n,Q as q,l as f,a5 as D,a4 as V,c as U,a2 as R,a3 as j,j as _,aX as T,a6 as z,ah as de,bP as ne}from"./index.7b36b598.js";import{e as re,Q as M}from"./QSelect.6d05204b.js";import{Q as ue}from"./QExpansionItem.404142ee.js";import{Q as ce}from"./QList.912e2662.js";import{Q as N}from"./QFooter.8f5d5723.js";import{Q as pe}from"./QPage.4fad267d.js";import{C as L}from"./ClosePopup.8d8b6328.js";import"./dayjs.min.cbcf888d.js";import"./axios.59d61e02.js";import{P as ve}from"./ProductsAutocomplete.4ecbf7f0.js";import{_ as me}from"./productView.b5e8b96c.js";import{o as O}from"./orderApi.1eb65bc2.js";import{u as fe}from"./OrderStore.279650f9.js";import{u as _e}from"./use-quasar.d212ba29.js";import{$sktOrders as xe}from"./socket.168d2ba4.js";import{R as ye}from"./resoursesOrder.2136c8da.js";import{E as ge}from"./exceljs.min.9e24d01d.js";import"./QResizeObserver.aad412c0.js";import"./_commonjsHelpers.88e99c8f.js";/* empty css                                                                         */import"./QSpace.9d6d302e.js";const be={class:"row items-center justify-between bg-primary text-white q-py-xs q-px-sm"},he={class:"row items-center col"},we={class:"q-pa-xs col text-center"},ke={class:"text-body2 text-bold"},Ve={class:"q-pa-xs col text-center"},Ce={class:"text-body2 text-bold"},Qe={class:"row items-center justify-between q-mt-xs"},Pe={class:"row text-center"},qe={class:"q-px-md col"},$e={class:"text-body2 text-bold"},Fe={class:"q-px-md col"},Ie={class:"text-body2 text-bold"},Se={class:"q-px-md col"},Be={class:"text-body2 text-bold"},De={class:"row full-width items-center justify-between q-py-sm"},Ue={class:"text-bold"},ze=["onClick"],Oe={class:"row items-center"},Ae={class:"col q-pr-sm"},Ee={class:"row items-center justify-between"},Re={class:"text-caption text-right text-grey-6"},je={class:"text--2 text-grey-6"},Te={class:"col text--2 text-caption"},Me={class:"text--2 text-amber-13"},Ne={class:"text-right"},Le={class:"text-caption text-bold"},Ge={class:"text-caption"},Je={class:"text-bold text-red"},Ke={class:"row q-ml-sm"},xt={__name:"Viewpreorders",setup(We){const G=oe(),I=ae(),r=fe();r.setshowLyt(!1);const m=_e(),C=ie(),i=b(null),J=b({opts:[],val:null}),u=b({state:!1,val:null,edit:!1}),x=b({state:!1,notfound:[],added:[]}),A=b(null),Q=b({amount:1,amountDelivered:0,price:0,toDelivered:0,total:0,units:1,_price_list:1,_supply_by:1}),$=b({state:!1,val:null,opts:[]}),K=async()=>{m.loading.show({message:"Obtenidendo datos"});let a={pedido:G.params.oid,store:C.session.store.id_viz,uid:C.session.credentials.staff.id_va,_rol:C.session.credentials._rol};const e=await O.getOrderPrv(a);e.fail?(console.log(e),(e.fail.status==401||e.fail.status==404)&&(m.notify({message:e.fail.response.data.mssg,type:"negative",position:"top"}),I.push("/preorders/pedidos"))):(console.log(e),i.value=e,m.loading.hide())},W=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(u.value.val=i.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=r.units.val.id,a.pivot={...Q.value},console.log(a.pivot),a.units=r.units.val,u.value.val=a,u.value.state=!0,u.value.edit=!1)},X=a=>{console.log(a);let e=i.value.products.findIndex(t=>t.id==a.id);e>=0?(u.value.val=i.value.products[e],u.value.state=!0,u.value.edit=!0):(Q.value._supply_by=r.units.val.id,a.pivot={...Q.value},console.log(a.pivot),a.units=r.units.val,u.value.val=a,u.value.state=!0,u.value.edit=!1)},S=()=>{u.value={state:!1,val:null,edit:!1},Q.value._supply_by=1},Z=a=>{i.value.products.push(a),S()},H=a=>{let e=i.value.products.findIndex(t=>t.id==a.id);e>=0&&(i.value.products.splice(e,1),S())},Y=a=>{console.log(a),console.log(J.value),a.units=r.units.opts.find(e=>e.id==a.pivot._supply_by),u.value.val=a,u.value.state=!0,u.value.edit=!0},ee=()=>{A.value.click()},te=async()=>{let a=document.getElementById("inputFile").files[0],e=new ge.Workbook,t={};e.xlsx.load(a).then(async w=>{let o=e.worksheets[0],y=o.getColumn("A");o.getColumn("B"),y.eachCell({includeEmpty:!0},function(g,p){if(p===1)return;let F=g.value,le=o.getCell(`B${p}`),E=parseFloat(le.value);F&&(t[F]?t[F]+=E:t[F]=E)});let P=Object.keys(t).map(g=>({codigo:g,cantidad:t[g]}));if(P.length){let g={codes:P,order:i.value.id};m.loading.show({message:"Procesando archivo, espera.."}),console.log(g);const p=await O.addMassiveProducts(g);p.fail?console.log(p):(console.log(p),i.value.products=p.products,ye.actualizarPreciosProductos(i.value.products,p.order,r.rules),x.value.state=!0,x.value.added=p.products,x.value.notfound=p.notFound,m.loading.hide())}else m.notify({message:"Vaya!! Al parecer este archivo esta vacio.",icon:"fas fa-grin-beam-sweat",color:"negative"})})},se=async()=>{m.loading.show({message:"Mandando Pedido"});let a={id:i.value.id,_printer:r.printers.val};console.log(a);const e=await O.nextStepPrv(a);if(e.fail)console.log(e);else{console.log(e);let t={order:e.order,newstate:e.status};console.log(t),xe.emit("order_update",t),r.addOrUpdate(t),I.push("/preorders/pedidos"),m.loading.hide()}};return K(),(a,e)=>i.value?(v(),k(pe,{key:0,padding:""},{default:d(()=>[s("div",be,[l(h,{onClick:e[0]||(e[0]=t=>c(I).push("/preorders/pedidos")),dense:"",flat:"",icon:"close",color:"white"}),s("div",he,[s("div",we,[e[7]||(e[7]=s("div",{class:"text-caption"},"Folio:",-1)),s("div",ke,n(i.value.id),1)]),s("div",Ve,[e[8]||(e[8]=s("div",{class:"text-caption"},"Cliente:",-1)),s("div",Ce,n(i.value.name),1)])]),l(h,{icon:"settings",dense:"",flat:""},{default:d(()=>[l(re,{style:{width:"100%"}},{default:d(()=>[l(q,null,{default:d(()=>[l(f,{class:"q-pa-sm"},{default:d(()=>[l(M,{modelValue:c(r).units.val,"onUpdate:modelValue":e[1]||(e[1]=t=>c(r).units.val=t),options:c(r).units.opts,label:"Pedir Por",filled:"","option-label":"name",dense:"",disable:i.value._status!=1},null,8,["modelValue","options","disable"])]),_:1}),l(D,{align:"center",class:"q-pa-none"},{default:d(()=>[l(h,{dense:"",flat:"",icon:"upload",color:"primary",onClick:ee})]),_:1}),l(f,null,{default:d(()=>[s("div",Qe,[s("div",Pe,[s("div",qe,[e[9]||(e[9]=s("div",{class:"text-caption"},"Modelos",-1)),s("span",$e,n(i.value.products.length),1)]),s("div",Fe,[e[10]||(e[10]=s("div",{class:"text-caption"},"Unidades",-1)),s("span",Ie,n(i.value.products.reduce((t,w)=>t+Number(w.pivot.units),0)),1)]),s("div",Se,[e[11]||(e[11]=s("div",{class:"text-caption"},"Total",-1)),s("span",Be," $ "+n(i.value.products.reduce((t,w)=>t+Number(w.pivot.total),0)),1)])])])]),_:1})]),_:1})]),_:1})]),_:1})]),l(V),(v(!0),U(j,null,R(c(r).units.opts,(t,w)=>(v(),k(ce,{bordered:"",key:w},{default:d(()=>[i.value.products.filter(o=>o.pivot._supply_by==t.id).length?(v(),k(ue,{key:0,"expand-separator":"","default-opened":"","header-class":"text-bold","expand-icon-class":"hidden"},{header:d(()=>[s("div",De,[s("div",null,[_(n(t.name.toUpperCase())+" - "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).length)+" productos ",1),l(de,{name:"fas fa-caret-right"}),_(" "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.units,0))+" pzs ",1)]),s("div",Ue,"$ "+n(i.value.products.filter(o=>o.pivot._supply_by==t.id).reduce((o,y)=>o+y.pivot.total,0)),1)])]),default:d(()=>[l(V),l(ne,{appear:"","enter-active-class":"animated zoomIn","leave-active-class":"animated zoomOut"},{default:d(()=>[(v(!0),U(j,null,R(i.value.products.filter(o=>o.pivot._supply_by==t.id),(o,y)=>(v(),U("div",{key:y,class:"q-py-md q-px-sm wrapper_prod",onClick:P=>Y(o)},[s("div",Oe,[s("div",Ae,[s("div",Ee,[s("div",null,[s("span",null,n(o.code),1),e[12]||(e[12]=_(" -- ")),s("span",null,n(o.name),1)]),s("span",Re,n(o.category.familia.name)+" (pxc "+n(o.pieces)+")",1)]),e[13]||(e[13]=s("div",{class:"text--3 text-uppercase text-italic"},null,-1)),s("div",je,n(o.description),1),s("div",Te,n(o._supply_by!=1?`(${o.pivot.units} pzs)`:"")+", PU: $"+n(o.pivot.price),1),s("div",Me,n(o.pivot.comments),1)]),s("div",Ne,[s("div",Le,"$ "+n(o.pivot.total),1),s("div",Ge,n(o.prices.find(P=>P.id==o.pivot._price_list).name),1)])]),l(V)],8,ze))),128))]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1024))),128)),l(z,{modelValue:$.value.state,"onUpdate:modelValue":e[3]||(e[3]=t=>$.value.state=t),persistent:""},{default:d(()=>[l(q,null,{default:d(()=>[l(f,{class:"row items-center bg-primary text-white text-h6"},{default:d(()=>e[14]||(e[14]=[_(" Selecciona Impresora ")])),_:1}),l(f,{class:""},{default:d(()=>[l(M,{modelValue:c(r).printers.val,"onUpdate:modelValue":e[2]||(e[2]=t=>c(r).printers.val=t),options:c(r).printers.opts.filter(t=>t._type==1),label:"Impresoras","option-label":"name",filled:""},null,8,["modelValue","options"])]),_:1}),l(D,{align:"right"},{default:d(()=>[T(l(h,{flat:"",label:"Cancelar",color:"primary"},null,512),[[L]]),l(h,{flat:"",label:"Terminar",color:"primary",onClick:se,disabled:!c(r).printers.val},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(z,{modelValue:u.value.state,"onUpdate:modelValue":e[4]||(e[4]=t=>u.value.state=t),persistent:"",position:"bottom"},{default:d(()=>[l(me,{product:u.value.val,order:i.value,edit:u.value.edit,onReset:S,products:i.value.products,rules:c(r).rules,onAddProduct:Z,onDeleteProduct:H,units:c(r).units.opts,unit:c(r).units.val},null,8,["product","order","edit","products","rules","units","unit"])]),_:1},8,["modelValue"]),l(z,{modelValue:x.value.state,"onUpdate:modelValue":e[5]||(e[5]=t=>x.value.state=t),persistent:""},{default:d(()=>[l(q,null,{default:d(()=>[l(f,{class:"text-center text-h5 text-bold"},{default:d(()=>e[15]||(e[15]=[_(" Resultados de Importacion ")])),_:1}),l(f,{class:"text-centet text-h6 text-bold"},{default:d(()=>[_(" Correctos: "+n(x.value.added.length),1)]),_:1}),l(f,null,{default:d(()=>[e[16]||(e[16]=_(" Modelos sin Coincidencia: ")),s("span",Je,n(x.value.notfound),1)]),_:1}),l(D,{align:"right"},{default:d(()=>[T(l(h,{flat:"",label:"OK",color:"primary"},null,512),[[L]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i.value._status==1?(v(),k(N,{key:0,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",Ke,[l(q,{class:"col"},{default:d(()=>[l(ve,{checkState:!0,onInput:X,with_prices:"",onAgregar:W,"workpoint-status":[1,2,c(C).session.store.id_viz],wkpToVal:c(C).session.store.id_viz},null,8,["workpoint-status","wkpToVal"])]),_:1}),l(V,{spaced:"",inset:"",vertical:"",dark:""}),s("div",null,[i.value.products.length>0?(v(),k(h,{key:0,flat:"",icon:"send",onClick:e[6]||(e[6]=t=>$.value.state=!$.value.state)})):B("",!0)])]),l(V,{spaced:"",inset:"",vertical:"",dark:""})]),_:1})):(v(),k(N,{key:1,reveal:"",elevated:"",bordered:""},{default:d(()=>[l(q,{class:"my-card"},{default:d(()=>[l(f,{class:"text-center text-bold bg-primary"},{default:d(()=>e[17]||(e[17]=[_(" El pedido ya esta terminado :/ ")])),_:1})]),_:1})]),_:1})),s("input",{type:"file",ref_key:"inputFile",ref:A,id:"inputFile",onInput:te,hidden:"",accept:".xlsx,.xls"},null,544)]),_:1})):B("",!0)}};export{xt as default};

import{Q as K}from"./QCircularProgress.af1b6d1c.js";import{Q}from"./QCard.3248d843.js";import{Q as b}from"./QCardSection.2772bee0.js";import{Q as Z}from"./QTable.f0e964fd.js";import{Q as ee}from"./QSelect.c275295e.js";import{r as f,aW as te,a as oe,u as se,c as U,l as ae,o as y,d as w,w as i,e as o,f as r,a0 as g,a1 as q,al as E,ak as le,Q as _,h as V,b5 as ie,am as re,a4 as ne}from"./index.722c96ba.js";import{Q as M}from"./QFooter.93094112.js";import{b as ce,Q as z}from"./QList.b9334b06.js";import{Q as ue}from"./QInput.905c375d.js";import{Q as I}from"./QCardActions.acc2993a.js";import{Q as de}from"./QForm.71f00d85.js";import{Q as pe}from"./QPage.c4c89dc0.js";import{C as me}from"./ClosePopup.fcc85c1b.js";import{u as ve}from"./use-quasar.70cae317.js";import{d as fe}from"./dayjs.min.cbcf888d.js";import"./QDrawer.66399704.js";import"./QExpansionItem.73a1f451.js";import"./axios.511d92c0.js";import{C as $}from"./cicsdb.8c4d4ddf.js";import"./QTr.24493be0.js";import"./QTd.9d22f9d8.js";/* empty css                                                                         */import{c as ge}from"./cyclecountStore.48807628.js";import"./OrderStore.f31f1f4c.js";import{$sktCounters as k}from"./socket.168d2ba4.js";import"./format.8ac60962.js";import"./use-key-composition.4dbf594e.js";import"./QLinearProgress.9441f2d2.js";import"./QCheckbox.ddce8d62.js";import"./use-checkbox.eaa0af27.js";import"./QResizeObserver.36318aa8.js";import"./_commonjsHelpers.88e99c8f.js";import"./QScrollObserver.1037fb2d.js";const _e={class:"col"},ke={class:"text-h5 text-primary"},Ce={class:"text-caption text-grey"},be={class:"row justify-between"},ye={class:"text-left"},we={class:"text--3"},xe={class:"text-h6"},he={class:"row"},Qe={class:"text-center col"},Ve={class:"text-center col"},Pe={class:"text-center text-bold text-h6"},nt={__name:"viewCounted",setup(De){f("");const u=ve(),d=te(),S=oe(),C=se(),c=ge();c.settitle(`Ciclico ${d.params.cid}`),c.setshowBtns(!1);const n=f(null);f({});const m=f(null),j=f({rowsPerPage:20}),N=f([]),x=f(!1),F=[{name:"code",label:"code",field:"code",align:"left",classes:t=>c.lockedProducts[t.id]?P():""},{name:"ubicacion",label:"Ubicacion",field:t=>{var e;return(e=t.locations)==null?void 0:e.map(l=>l.path).join("/")},align:"left",classes:t=>c.lockedProducts[t.id]?P():""},{name:"conteo",label:"Stock",field:t=>{var e;return((e=t.pivot)==null?void 0:e.stock_acc)||0},align:"right",classes:t=>c.lockedProducts[t.id]?P():""}],a=f({state:!1,val:null}),Y=async()=>{u.loading.show({message:"Obteniendo Datos"});let t={cyclecount:d.params.cid,_rol:C.session.credentials._rol,id:C.session.credentials.staff.id_va};console.log(t);const e=await $.getCyclecount(t);e.fail?e.fail.status==403||e.fail.status==404?(u.notify({message:`${e.fail.response.data.message}`,type:"negative",position:"top"}),S.push("/ciclicos/counted")):console.log(e):(n.value=e,console.log(e),u.loading.hide(),k.emit("joinat",{user:c.socket_user.profile,room:`COUNTER${d.params.cid}`}))},A=(t,e,l)=>{e(()=>{const p=t.toUpperCase();N.value=n.value.products.filter(s=>{var T;const v=(T=s.variants)==null?void 0:T.some(D=>(D==null?void 0:D.barcode.toUpperCase().indexOf(p))>-1),h=s.code.toUpperCase().indexOf(p)>-1||s.barcode.toUpperCase().indexOf(p)>-1||s.name.toUpperCase().indexOf(p)>-1;return v||h})})},O=U(()=>u.dark.isActive),B=U(()=>{var t,e;return(e=(t=n.value)==null?void 0:t.products)==null?void 0:e.filter(l=>l.pivot.stock_acc>0)}),R=U(()=>{var l;const t=((l=n.value)==null?void 0:l.products)||[];if(t.length===0)return 0;const e=t.filter(p=>Number(p.pivot.stock_acc)>0).length;return Math.round(e/t.length*100)}),H=async()=>{u.loading.show({message:"Registrando Contreo"});let t={_user:C.session.credentials.staff.id_va,_inventory:d.params.cid,_product:a.value.val.id,stock:a.value.val.pivot.stock_acc};const e=await $.saveValue(t);if(e.fail)console.log(e);else{let l={by:c.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`,settings:"config"};k.emit("countingconfirmed",l),a.value={state:!1,val:null},u.loading.hide()}},L=()=>{let t={by:c.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`};k.emit("cancelcounting",t),a.value={state:!1,val:null}},W=t=>{if(c.lockedProducts[t.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),m.value=null;return}if(n.value._status==2){a.value.state=!0,a.value.val=t,m.value=null;let e={by:c.socket_user.profile,product:t,room:`COUNTER${d.params.cid}`};k.emit("counting",e)}},X=(t,e)=>{if(c.lockedProducts[e.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),m.value=null;return}if(n.value._status==2){a.value.state=!0,a.value.val=e,m.value=null;let l={by:c.socket_user.profile,product:e,room:`COUNTER${d.params.cid}`};k.emit("counting",l)}},G=t=>{m.value=t,console.log(m.value)},P=()=>(O.value,"bg-red"),J=async()=>{u.loading.show({message:"Terminando Conteo"});let t={_inventory:d.params.cid,workpoint:C.session.credentials._rol,user:C.session.credentials.staff.id_va};const e=await $.nextStep(t);if(e.fail)console.log(e);else{console.log(e);let l={by:c.socket_user.profile,counter:e.inventario,room:`COUNTER${d.params.cid}`};k.emit("endingCounting",l),u.loading.hide()}};return Y(),ae(()=>c.currentLockedProduct,t=>{if(!t)return;const e=n.value.products.findIndex(l=>l.id===t.id);e!==-1&&(n.value.products[e]={...n.value.products[e],...t})}),(t,e)=>(y(),w(pe,{padding:""},{default:i(()=>{var l,p;return[o(Q,{flat:"",bordered:"",class:"q-pa-md row"},{default:i(()=>{var s,v,h;return[r("div",_e,[r("div",ke,g(((s=n.value)==null?void 0:s.notes)||"Inventario C\xEDclico"),1),r("div",Ce," ID: "+g((v=n.value)==null?void 0:v.id)+" \u2022 Creado: "+g(q(fe)((h=n.value)==null?void 0:h.created_at).format("YYYY-MM-DD H:mm:ss")),1)]),r("div",null,[o(K,{"show-value":"","font-size":"12px",value:R.value,size:"45px",thickness:.22,color:"teal","track-color":"grey-3",class:"q-ma-md"},{default:i(()=>[E(g(R.value)+"% ",1)]),_:1},8,["value"])])]}),_:1}),o(Q,{bordered:""},{default:i(()=>{var s;return[o(b,null,{default:i(()=>e[6]||(e[6]=[r("div",{class:"text-h6"},"Productos",-1)])),_:1}),o(Z,{rows:((s=n.value)==null?void 0:s.products)||[],columns:F,"row-key":"id",dense:"",flat:"",bordered:"",onRowClick:X,pagination:j.value},null,8,["rows","pagination"])]}),_:1}),((l=n.value)==null?void 0:l._status)==2?(y(),w(M,{key:0,class:le(["row q-ml-sm q-mr-sm",O.value?"bg-grey-10 text-white":"bg-grey-4 text-dark"])},{default:i(()=>{var s;return[o(ee,{class:"col",modelValue:m.value,"onUpdate:modelValue":[e[0]||(e[0]=v=>m.value=v),W],options:N.value,filled:"","option-label":"code","use-input":"","fill-input":"","hide-selected":"","input-debounce":"0",onFilter:A,onInputValue:G,dense:""},null,8,["modelValue","options"]),((s=B.value)==null?void 0:s.length)>0?(y(),w(_,{key:0,size:"sm",icon:"send",onClick:e[1]||(e[1]=v=>x.value=!x.value)})):V("",!0)]}),_:1},8,["class"])):V("",!0),((p=n.value)==null?void 0:p._status)>2?(y(),w(M,{key:1,class:"q-ml-sm q-mr-sm"},{default:i(()=>{var s;return[((s=B.value)==null?void 0:s.length)>0?(y(),w(_,{key:0,size:"sm",label:"Salir",onClick:e[2]||(e[2]=v=>q(S).push("/ciclicos/counted")),class:"full-width"})):V("",!0)]}),_:1})):V("",!0),o(z,{modelValue:a.value.state,"onUpdate:modelValue":e[4]||(e[4]=s=>a.value.state=s),persistent:"",position:"bottom"},{default:i(()=>[o(Q,null,{default:i(()=>[o(b,null,{default:i(()=>[r("div",be,[r("div",ye,[r("div",we,"CCO: "+g(a.value.val.name),1),r("div",xe,g(a.value.val.code),1)])])]),_:1}),o(ce),o(b,null,{default:i(()=>[E(g(a.value.val.description),1)]),_:1}),o(de,{onSubmit:ie(H,["prevent"])},{default:i(()=>[o(b,null,{default:i(()=>[r("div",he,[r("div",Qe,[e[7]||(e[7]=r("div",null,"Conteo",-1)),o(ue,{dense:"",borderless:"",modelValue:a.value.val.pivot.stock_acc,"onUpdate:modelValue":e[3]||(e[3]=s=>a.value.val.pivot.stock_acc=s),type:"number",min:"0","input-class":"text-h6 text-center",ref:"iptcounter",autofocus:""},null,8,["modelValue"])]),r("div",Ve,[e[8]||(e[8]=r("div",null,"PXC",-1)),r("div",Pe,g(a.value.val.pieces),1)])])]),_:1}),o(I,{align:"center"},{default:i(()=>[o(_,{flat:"",icon:"close",color:"negative",onClick:L}),o(_,{color:"positive",type:"submit",square:"",icon:"done_all",flat:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(z,{modelValue:x.value,"onUpdate:modelValue":e[5]||(e[5]=s=>x.value=s),persistent:""},{default:i(()=>[o(Q,null,{default:i(()=>[o(b,{class:"row items-center"},{default:i(()=>[o(re,{icon:"warning",color:"warning","text-color":"white"}),e[9]||(e[9]=r("span",{class:"q-ml-sm"},"Estas Seguro de terminar ?",-1))]),_:1}),o(I,{align:"right"},{default:i(()=>[ne(o(_,{flat:"",label:"No",color:"negative"},null,512),[[me]]),o(_,{flat:"",label:"Si",color:"positive",onClick:J})]),_:1})]),_:1})]),_:1},8,["modelValue"])]}),_:1}))}};export{nt as default};

import{Q as g}from"./QTd.e7d4f47a.js";import{aH as W,r,c as h,o as F,d as H,w as i,f as _,e as l,ak as Q,a0 as m,Q as f,S as J}from"./index.7d932cec.js";import{Q as X}from"./QTr.63c65b8e.js";import{Q as U}from"./QTable.9e3cb568.js";import{Q as D}from"./QSelect.33ba93ff.js";import{Q as C}from"./QCardSection.2da9fba7.js";import{Q as E}from"./QInput.28f4ef28.js";import{Q as G}from"./QCardActions.445dad37.js";import{Q as R}from"./QCard.c43496fd.js";import{Q as A,b as S}from"./QList.15d88b4b.js";import{Q as K}from"./QSpace.c70e7a18.js";import{Q as Y}from"./QPage.2cb9f7ca.js";import{R as x}from"./RestockApi.a77587af.js";import{u as Z}from"./use-quasar.bf32b052.js";import{E as ee}from"./exceljs.min.9e24d01d.js";import{$sktRestock as N}from"./socket.05630e21.js";import"./use-key-composition.bad2484f.js";import"./QLinearProgress.25afea2b.js";import"./QCheckbox.2d866e24.js";import"./axios.a94c162f.js";import"./_commonjsHelpers.88e99c8f.js";const ae={class:"col-2 q-table__title q-mr-xl"},oe={class:"text-overline"},xe={__name:"automate",setup(le){const d=Z();W();const n=r({state:!1,val:null}),c=r({columns:[{name:"code",label:"Codigo",align:"left",field:e=>e.code},{name:"shortcode",label:"Codigo Corto",align:"left",field:e=>e.name},{name:"section",label:"Seccion",align:"left",field:e=>e.category.familia.seccion.name},{name:"family",label:"Familia",align:"left",field:e=>e.category.familia.name},{name:"category",label:"Categoria",align:"left",field:e=>e.category.name},{name:"description",label:"Descripcion",align:"left",field:e=>e.description},{name:"supplyby",label:"Surtir por ",align:"left",field:e=>e.pivot._supply_by==1?"Pieza":e.pivot._supply_by==3?"Caja":"Docena"},{name:"amount",label:"Cantidad",align:"left",field:e=>e.pivot.amount},{name:"piezas",label:"Cantidad en Piezas",align:"left",field:e=>e.pivot.units},{name:"transit",label:"Transito",align:"left",field:e=>{var a;return(a=e.stocks[0])==null?void 0:a.pivot.in_transit}},{name:"stockSuc",label:"Stock Sucursal",align:"left",field:e=>{var a;return(a=e.stocks[0])==null?void 0:a.pivot.stock}},{name:"min",label:"MIN",align:"left",field:e=>{var a;return(a=e.stocks[0])==null?void 0:a.pivot.min}},{name:"max",label:"MAX",align:"left",field:e=>{var a;return(a=e.stocks[0])==null?void 0:a.pivot.max}}],filter:""}),k=r([]),V=r({opts:[]}),y=r(!1),p=r(!1);r("");const w=r(null),T=r({cols:[{name:"id",label:"ID",align:"center"},{name:"alias",label:"ALIAS",align:"center"},{name:"name",label:"SUCURSAL",align:"left"},{name:"actions",label:"",align:"left"}]}),s=r({cats:[],_workpoint_from:null,_workpoint_to:null,_type:2,notes:null}),B=h(()=>s.value.cats.length>0&&s.value._workpoint_to),q=h(()=>k.value.filter(e=>e._type==1)),I=async()=>{d.loading.show({message:"Obteniendo Sucursales"});const e=await x.getStoresAutomate();e.status==200?(console.log(e.data),k.value=e.data.stores,V.value.opts=e.data.sections,d.loading.hide()):alert("Problemas con la obtencion de datos")},$=e=>{p.value=!0,w.value=e},j=async e=>{y.value=!0,d.loading.show({message:"Creando Pedido"});let a={cats:s.value.cats.map(t=>"'"+t.name+"'").join(),_workpoint_from:w.value,_workpoint_to:s.value._workpoint_to.id,_type:2,notes:s.value.notes};console.log(a);const o=await x.createAutomate(a);o.status==200?(console.log(o.data),y.value=!1,d.loading.hide(),d.notify({type:"positive",message:`Pedido ${o.data.order.id} creado`,position:"center"}),n.value.state=!0,n.value.val=o.data.order,console.log(o),N.emit("creating",{order:o.data.order}),s.value={cats:[],_workpoint_from:null,_workpoint_to:null,_type:2,notes:null},p.value=!1):alert("Nosegeneroelpedido")},z=e=>e.id==w.value,L=()=>{s.value={cats:[],_workpoint_from:null,_workpoint_to:null,_type:2,notes:null},p.value=!1},M=async()=>{const e=new ee.Workbook,a=e.addWorksheet("Comparativo");a.addRow(c.value.columns.map(t=>t.label)),n.value.val.products.forEach(t=>{var v,b,u,P;a.addRow([t.code,t.name,t.category.familia.seccion.name,t.category.familia.name,t.category.name,t.description,t.pivot._supply_by==1?"Pieza":t.pivot._supply_by==3?"Caja":"Docena",t.pivot.amount,t.pivot.units,(v=t.stocks[0])==null?void 0:v.pivot.in_transit,(b=t.stocks[0])==null?void 0:b.pivot.stock,(u=t.stocks[0])==null?void 0:u.pivot.min,(P=t.stocks[0])==null?void 0:P.pivot.max])}),(async()=>{const t=await e.xlsx.writeBuffer(),v=new Blob([t],{type:"application/octet-stream"}),b=URL.createObjectURL(v),u=document.createElement("a");u.href=b,u.download=`Pedido${n.value.val.id}.xlsx`,document.body.appendChild(u),u.click(),document.body.removeChild(u)})()},O=async()=>{d.loading.show({message:"Enviando Pedido"});const e=await x.nextStep({id:n.value.val.id});console.log(e),e.status==200?(console.log(e),d.notify({message:"Pedido Enviado :)",type:"positive",position:"center"}),n.value={state:!1,val:null},N.emit("order_refresh",{order:e.data.requisition}),d.loading.hide()):alert("Problema con el envio de el pedido ")};return I(),(e,a)=>(F(),H(Y,{padding:""},{default:i(()=>[_("div",null,[l(U,{title:"Sucursales",rows:k.value,"row-key":"id",columns:T.value.cols,pagination:{rowsPerPage:20}},{body:i(o=>[l(X,{props:o},{default:i(()=>[l(g,{key:"id",props:o},{default:i(()=>[Q(m(o.row.id),1)]),_:2},1032,["props"]),l(g,{key:"alias",props:o},{default:i(()=>[Q(m(o.row.alias),1)]),_:2},1032,["props"]),l(g,{key:"name",props:o},{default:i(()=>[Q(m(o.row.name),1)]),_:2},1032,["props"]),l(g,{key:"actions",props:o},{default:i(()=>[l(f,{flat:"",rounded:"","icon-right":"arrow_circle_right",label:"Crear Pedido",color:"primary",onClick:t=>$(o.row.id),disable:y.value},null,8,["onClick","disable"])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"]),l(A,{modelValue:p.value,"onUpdate:modelValue":a[3]||(a[3]=o=>p.value=o),persistent:""},{default:i(()=>[l(R,{style:{"min-width":"350px"}},{default:i(()=>[l(C,null,{default:i(()=>[l(D,{modelValue:s.value.cats,"onUpdate:modelValue":a[0]||(a[0]=o=>s.value.cats=o),options:V.value.opts,label:"Seccion","option-label":"name",filled:"",multiple:"","use-chips":""},null,8,["modelValue","options"])]),_:1}),l(C,null,{default:i(()=>[l(D,{modelValue:s.value._workpoint_to,"onUpdate:modelValue":a[1]||(a[1]=o=>s.value._workpoint_to=o),options:q.value,label:"Destino","option-label":"name",filled:"","option-disable":o=>z(o)},null,8,["modelValue","options","option-disable"])]),_:1}),l(C,{class:"q-pt-none"},{default:i(()=>[a[6]||(a[6]=_("div",{class:"text-bold"},"Notas",-1)),l(E,{dense:"",modelValue:s.value.notes,"onUpdate:modelValue":a[2]||(a[2]=o=>s.value.notes=o),autofocus:""},null,8,["modelValue"])]),_:1}),l(G,{align:"right",class:"text-primary"},{default:i(()=>[l(f,{flat:"",label:"Cancel",onClick:L}),l(f,{flat:"",label:"Continuar",onClick:j,disable:!B.value},null,8,["disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(A,{modelValue:n.value.state,"onUpdate:modelValue":a[5]||(a[5]=o=>n.value.state=o),"full-width":""},{default:i(()=>[l(R,null,{default:i(()=>[l(U,{rows:n.value.val.products,columns:c.value.columns,filter:c.value.filter},{top:i(o=>[_("div",ae,"Pedido : "+m(n.value.val.id),1),_("div",oe,"Notas : "+m(n.value.val.notes),1),l(K),l(S,{spaced:"",inset:"",vertical:""}),l(f,{color:"primary",icon:"send",onClick:O,flat:"",round:"",title:"Enviar Pedido"}),l(S,{spaced:"",inset:"",vertical:""}),l(f,{color:"primary",icon:"download",onClick:M,flat:"",round:"",title:"Descargar"}),l(S,{spaced:"",inset:"",vertical:""}),l(E,{borderless:"",dense:"",debounce:"300",modelValue:c.value.filter,"onUpdate:modelValue":a[4]||(a[4]=t=>c.value.filter=t),placeholder:"Search"},{append:i(()=>[l(J,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["rows","columns","filter"])]),_:1})]),_:1},8,["modelValue"])])]),_:1}))}};export{xe as default};

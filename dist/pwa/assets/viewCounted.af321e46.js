import{Q as K}from"./QCircularProgress.8bf6c1f5.js";import{r as f,Z as W,f as ee,u as te,g as U,w as oe,a as C,h as y,i,d as o,k as n,a1 as g,a7 as q,j as E,Q,l as w,b9 as se,n as _,p as V,a4 as ae,bc as le,m as ie,a5 as M,a6 as j,ba as ne,aX as re}from"./index.6772a291.js";import{Q as ce}from"./QTable.b4dcb871.js";import{Q as ue}from"./QSelect.4738e4d7.js";import{Q as z}from"./QFooter.45d04765.js";import{Q as de}from"./QForm.5265d4cf.js";import{Q as pe}from"./QPage.a5cb312a.js";import{C as me}from"./ClosePopup.fff889ca.js";import{u as ve}from"./use-quasar.e757a0da.js";import{d as fe}from"./dayjs.min.cbcf888d.js";import"./QImg.087d1b59.js";import"./QList.832348b5.js";import"./QSpace.62a5af0f.js";import"./QExpansionItem.5fb7069d.js";import"./favorites.f52709b7.js";import"./axios.b16d05b9.js";import{C as $}from"./cicsdb.9168d9cb.js";import"./QTr.edb39c38.js";import"./QTd.90f0f49e.js";/* empty css                                                                         */import{c as ge}from"./cyclecountStore.35e4f0e9.js";import"./exceljs.min.9e24d01d.js";import"./OrderStore.b019d38e.js";import{$sktCounters as k}from"./socket.168d2ba4.js";import"./QLinearProgress.427c6ef3.js";import"./QResizeObserver.212d10b7.js";import"./_commonjsHelpers.88e99c8f.js";import"./QScrollObserver.6bb52127.js";const _e={class:"col"},ke={class:"text-h5 text-primary"},be={class:"text-caption text-grey"},Ce={class:"row justify-between"},ye={class:"text-left"},we={class:"text--3"},xe={class:"text-h6"},he={class:"row"},Qe={class:"text-center col"},Ve={class:"text-center col"},Pe={class:"text-center text-bold text-h6"},st={__name:"viewCounted",setup(De){f("");const u=ve(),d=W(),S=ee(),b=te(),c=ge();c.settitle(`Ciclico ${d.params.cid}`),c.setshowBtns(!1);const r=f(null);f({});const m=f(null),I=f({rowsPerPage:20}),N=f([]),x=f(!1),F=[{name:"code",label:"code",field:"code",align:"left",classes:t=>c.lockedProducts[t.id]?P():"",sortable:!0},{name:"ubicacion",label:"Ubicacion",field:t=>{var e;return(e=t.locations)==null?void 0:e.map(l=>l.path).join("/")},align:"left",classes:t=>c.lockedProducts[t.id]?P():"",sortable:!0},{name:"conteo",label:"Stock",field:t=>{var e;return((e=t.pivot)==null?void 0:e.stock_acc)||0},align:"right",classes:t=>c.lockedProducts[t.id]?P():"",sortable:!0}],a=f({state:!1,val:null}),Y=async()=>{u.loading.show({message:"Obteniendo Datos"});let t={cyclecount:d.params.cid,_rol:b.session.credentials._rol,id:b.session.credentials.staff.id_va};console.log(t);const e=await $.getCyclecount(t);e.fail?e.fail.status==403||e.fail.status==404?(u.notify({message:`${e.fail.response.data.message}`,type:"negative",position:"top"}),S.push("/ciclicos/counted")):console.log(e):(r.value=e,console.log(e),u.loading.hide(),k.emit("joinat",{user:c.socket_user.profile,room:`COUNTER${d.params.cid}`}))},A=(t,e,l)=>{e(()=>{const p=t.toUpperCase();N.value=r.value.products.filter(s=>{var T;const v=(T=s.variants)==null?void 0:T.some(D=>(D==null?void 0:D.barcode.toUpperCase().indexOf(p))>-1),h=s.code.toUpperCase().indexOf(p)>-1||s.barcode.toUpperCase().indexOf(p)>-1||s.name.toUpperCase().indexOf(p)>-1;return v||h})})},O=U(()=>u.dark.isActive),B=U(()=>{var t,e;return(e=(t=r.value)==null?void 0:t.products)==null?void 0:e.filter(l=>l.pivot.stock_acc>0)}),R=U(()=>{var l;const t=((l=r.value)==null?void 0:l.products)||[];if(t.length===0)return 0;const e=t.filter(p=>Number(p.pivot.stock_acc)>0).length;return Math.round(e/t.length*100)}),X=async()=>{u.loading.show({message:"Registrando Contreo"});let t={_user:b.session.credentials.staff.id_va,_inventory:d.params.cid,_product:a.value.val.id,stock:a.value.val.pivot.stock_acc};const e=await $.saveValue(t);if(e.fail)console.log(e);else{let l={by:c.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`,settings:"config"};k.emit("countingconfirmed",l),a.value={state:!1,val:null},u.loading.hide()}},H=()=>{let t={by:c.socket_user.profile,product:a.value.val,room:`COUNTER${d.params.cid}`};k.emit("cancelcounting",t),a.value={state:!1,val:null}},L=t=>{if(c.lockedProducts[t.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),m.value=null;return}if(r.value._status==2){a.value.state=!0,a.value.val=t,m.value=null;let e={by:c.socket_user.profile,product:t,room:`COUNTER${d.params.cid}`};k.emit("counting",e)}},Z=(t,e)=>{if(c.lockedProducts[e.id]){u.notify({type:"warning",message:"Este producto est\xE1 siendo contado por otro usuario."}),m.value=null;return}if(r.value._status==2){a.value.state=!0,a.value.val=e,m.value=null;let l={by:c.socket_user.profile,product:e,room:`COUNTER${d.params.cid}`};k.emit("counting",l)}},G=t=>{m.value=t,console.log(m.value)},P=()=>(O.value,"bg-red"),J=async()=>{u.loading.show({message:"Terminando Conteo"});let t={_inventory:d.params.cid,workpoint:b.session.credentials._rol,user:b.session.credentials.staff.id_va};const e=await $.nextStep(t);if(e.fail)console.log(e);else{console.log(e);let l={by:c.socket_user.profile,counter:e.inventario,room:`COUNTER${d.params.cid}`};k.emit("endingCounting",l),u.loading.hide()}};return Y(),oe(()=>c.currentLockedProduct,t=>{if(!t)return;const e=r.value.products.findIndex(l=>l.id===t.id);e!==-1&&(r.value.products[e]={...r.value.products[e],...t})}),(t,e)=>(C(),y(pe,{padding:""},{default:i(()=>{var l,p;return[o(Q,{flat:"",bordered:"",class:"q-pa-md row"},{default:i(()=>{var s,v,h;return[n("div",_e,[n("div",ke,g(((s=r.value)==null?void 0:s.notes)||"Inventario C\xEDclico"),1),n("div",be," ID: "+g((v=r.value)==null?void 0:v.id)+" \u2022 Creado: "+g(q(fe)((h=r.value)==null?void 0:h.created_at).format("YYYY-MM-DD H:mm:ss")),1)]),n("div",null,[o(K,{"show-value":"","font-size":"12px",value:R.value,size:"45px",thickness:.22,color:"teal","track-color":"grey-3",class:"q-ma-md"},{default:i(()=>[E(g(R.value)+"% ",1)]),_:1},8,["value"])])]}),_:1}),o(Q,{bordered:""},{default:i(()=>{var s;return[o(w,null,{default:i(()=>e[6]||(e[6]=[n("div",{class:"text-h6"},"Productos",-1)])),_:1}),o(ce,{rows:((s=r.value)==null?void 0:s.products)||[],columns:F,"row-key":"id",dense:"",flat:"",bordered:"",onRowClick:Z,pagination:I.value},null,8,["rows","pagination"])]}),_:1}),((l=r.value)==null?void 0:l._status)==2?(C(),y(z,{key:0,class:se(["row q-ml-sm q-mr-sm",O.value?"bg-grey-10 text-white":"bg-grey-4 text-dark"])},{default:i(()=>{var s;return[o(ue,{class:"col",modelValue:m.value,"onUpdate:modelValue":[e[0]||(e[0]=v=>m.value=v),L],options:N.value,filled:"","option-label":"code","use-input":"","fill-input":"","hide-selected":"","input-debounce":"0",onFilter:A,onInputValue:G,dense:""},null,8,["modelValue","options"]),((s=B.value)==null?void 0:s.length)>0?(C(),y(_,{key:0,size:"sm",icon:"send",onClick:e[1]||(e[1]=v=>x.value=!x.value)})):V("",!0)]}),_:1},8,["class"])):V("",!0),((p=r.value)==null?void 0:p._status)>2?(C(),y(z,{key:1,class:"q-ml-sm q-mr-sm"},{default:i(()=>{var s;return[((s=B.value)==null?void 0:s.length)>0?(C(),y(_,{key:0,size:"sm",label:"Salir",onClick:e[2]||(e[2]=v=>q(S).push("/ciclicos/counted")),class:"full-width"})):V("",!0)]}),_:1})):V("",!0),o(j,{modelValue:a.value.state,"onUpdate:modelValue":e[4]||(e[4]=s=>a.value.state=s),persistent:"",position:"bottom"},{default:i(()=>[o(Q,null,{default:i(()=>[o(w,null,{default:i(()=>[n("div",Ce,[n("div",ye,[n("div",we,"CCO: "+g(a.value.val.name),1),n("div",xe,g(a.value.val.code),1)])])]),_:1}),o(ae),o(w,null,{default:i(()=>[E(g(a.value.val.description),1)]),_:1}),o(de,{onSubmit:le(X,["prevent"])},{default:i(()=>[o(w,null,{default:i(()=>[n("div",he,[n("div",Qe,[e[7]||(e[7]=n("div",null,"Conteo",-1)),o(ie,{dense:"",borderless:"",modelValue:a.value.val.pivot.stock_acc,"onUpdate:modelValue":e[3]||(e[3]=s=>a.value.val.pivot.stock_acc=s),type:"number",min:"0","input-class":"text-h6 text-center",ref:"iptcounter",autofocus:""},null,8,["modelValue"])]),n("div",Ve,[e[8]||(e[8]=n("div",null,"PXC",-1)),n("div",Pe,g(a.value.val.pieces),1)])])]),_:1}),o(M,{align:"center"},{default:i(()=>[o(_,{flat:"",icon:"close",color:"negative",onClick:H}),o(_,{color:"positive",type:"submit",square:"",icon:"done_all",flat:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(j,{modelValue:x.value,"onUpdate:modelValue":e[5]||(e[5]=s=>x.value=s),persistent:""},{default:i(()=>[o(Q,null,{default:i(()=>[o(w,{class:"row items-center"},{default:i(()=>[o(ne,{icon:"warning",color:"warning","text-color":"white"}),e[9]||(e[9]=n("span",{class:"q-ml-sm"},"Estas Seguro de terminar ?",-1))]),_:1}),o(M,{align:"right"},{default:i(()=>[re(o(_,{flat:"",label:"No",color:"negative"},null,512),[[me]]),o(_,{flat:"",label:"Si",color:"positive",onClick:J})]),_:1})]),_:1})]),_:1},8,["modelValue"])]}),_:1}))}};export{st as default};

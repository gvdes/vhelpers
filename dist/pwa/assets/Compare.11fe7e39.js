import{Q as $,a as J}from"./QTable.9c2ee698.js";import{aH as le,a as oe,u as ie,r as x,c as z,o as Q,d as E,w as o,h as se,e as a,f,a0 as d,Q as _,a6 as r,g as ne,a4 as re,a3 as de,b1 as B,a5 as k,a7 as ue,S as C}from"./index.f206967d.js";import{a as m}from"./QSelect.e229e9a4.js";import{a as F,b as y,Q as ce,c as N}from"./QSeparator.243f9883.js";import{Q as K}from"./QList.5bc323e0.js";import{Q as P,a as S}from"./QCard.96933c98.js";import{Q as A,a as b}from"./QTr.393a2f67.js";import{Q as L}from"./QInput.c65e1852.js";import{Q as M}from"./QPopupEdit.11d902e5.js";import{Q as q}from"./QCardActions.858b406e.js";import{Q as ve}from"./QPage.5e491fa0.js";import{C as T}from"./ClosePopup.6345927e.js";import"./dayjs.min.cbcf888d.js";import{R as me}from"./RestockApi.bf1dd71a.js";import{i as R}from"./invoicesApi.caf686c9.js";import{u as fe}from"./Restock.d7a7f586.js";import{u as pe}from"./axios.6390b5c3.js";import{$sktRestock as h}from"./socket.3fae67a0.js";import"./QBtnGroup.f316eb69.js";import"./QLinearProgress.2b955dd6.js";import"./QCheckbox.21d0a706.js";import"./_commonjsHelpers.88e99c8f.js";const ge={class:"text-bold text-center text-h6"},_e={class:"text-caption"},ye={class:"text-caption"},be={class:"text-center text-bold"},we={class:"text-center text-bold"},xe={class:"text-center text-bold"},Le={__name:"Compare",setup(Se){le(),oe();const V=fe(),u=pe(),j=ie(),i=x({state:!1,val:null}),c=x({state:!1,val:null}),p=x([]),w=x(!1),G=z(()=>V.partitions.filter(e=>e._status==10&&e.requisition._workpoint_to==j.session.store.id_viz)),I=z(()=>G.value.filter(e=>e.products.some(t=>t.pivot.toReceived!==t.pivot.toDelivered)||!e.invoice||!e.invoice_received)),H=async()=>{V.setShowLYT(!0),V.setTitle("Comparativo"),V.setButtonShow(!0)},D=x({columnsPrimary:[{name:"name",align:"left",label:"Sucursal",field:e=>e.requisition.from.name},{name:"order",align:"center",label:"Pedido",field:e=>e.requisition.id},{name:"partition",align:"center",label:"Particion",field:e=>e.id},{name:"notes",align:"center",label:"Notas",field:e=>e.requisition.notes},{name:"invoice",align:"center",label:"Salida",field:e=>e.invoice},{name:"entry",align:"center",label:"Entrada",field:e=>e.invoice_received},{name:"modified",align:"center",label:"Diferencias",field:e=>e.products.filter(t=>t.pivot.toReceived!==t.pivot.toDelivered).length}],columnsProduct:[{name:"code",align:"left",label:"Codigo",field:e=>e.code},{name:"description",align:"left",label:"Descripcion",field:e=>e.description},{name:"toDelivered",align:"center",label:"Salida",field:e=>e.pivot.toDelivered*g(e.pivot._supply_by,e)},{name:"toReceived",align:"center",label:"Entrada",field:e=>e.pivot.toReceived*g(e.pivot._supply_by,e)},{name:"Diference",align:"center",label:"Diferencia",field:e=>Number(e.pivot.toDelivered-e.pivot.toReceived)*g(e.pivot._supply_by,e)}],pagination:{rowsPerPage:0}}),Y=async()=>{u.loading.show({message:"Realizando Cambios"});const e=p.value.products.map(s=>({id:s.id,toReceived:s.pivot.toReceived})),t=p.value.products.map(s=>({id:s.id,toDelivered:s.pivot.toDelivered}));console.log(i.value.val);try{const s=await me.correction(i.value.val);if(s.status!=200)console.log(s),i.value.val.products=JSON.parse(JSON.stringify(p.value.products));else{if(console.log(s.data),c.value.val=s.data,c.value.state=!0,s.data.res.Eliminar.success){const l=s.data.deleted.map(n=>n);i.value.val.products=i.value.val.products.filter(n=>!l.includes(n.id))}else console.log(p),i.value.val.products=JSON.parse(JSON.stringify(p.value.products));s.data.res.Entrada.success?s.data.toReceived.forEach(l=>{const n=i.value.val.products.find(v=>v.id===l._product);n&&(n.pivot.toReceived=l.toReceived)}):e.forEach(l=>{const n=i.value.val.products.find(v=>v.id===l.id);n&&(n.pivot.toReceived=l.toReceived)}),s.data.res.Salida.success?s.data.toDelivered.forEach(l=>{const n=i.value.val.products.find(v=>v.id===l._product);n&&(n.pivot.toDelivered=l.toDelivered)}):t.forEach(l=>{const n=i.value.val.products.find(v=>v.id===l.id);n&&(n.pivot.toDelivered=l.toDelivered)})}}catch(s){i.value.val.products=JSON.parse(JSON.stringify(p.value.products)),console.error("Error al guardar:",s)}finally{h.emit("orderpartition_refresh",{order:i.value.val}),w.value=!1,u.loading.hide(),i.value={state:!1,val:null},p.value=[]}},W=e=>{let t=i.value.val.products.findIndex(s=>s.id==e.id);i.value.val.products.splice(t,1),console.log(e.pivot)},X=(e,t)=>{i.value.state=!i.value.state,i.value.val=JSON.parse(JSON.stringify(t)),p.value=JSON.parse(JSON.stringify(t))},Z=()=>{i.value.val.requisition.from._type==1?O(i.value.val,!0):te(i.value.val)},ee=()=>{i.value.val.requisition.from._type==1?O(i.value.val,!1):ae(i.value.val)},ae=async e=>{u.loading.show({message:"generando entrada"});const t=await R.addEntryFS(e);t.fail?t.fail.status==503?(u.notify({message:"No hubo conexion a cedis, Intentarlo mas tarde",type:"negative",position:"bottom"}),u.loading.hide()):console.log(t):(console.log(t),u.notify({message:`Entrada Creada ${t}`,type:"positive",position:"bottom"}),e.invoice_received=t,h.emit("orderpartition_refresh",{order:e}),u.loading.hide())},te=async e=>{u.loading.show({message:"salida"});const t=await R.addInvoiceFS(e);t.fail?t.fail.status==503?(u.notify({message:"No hubo conexion a cedis, Intentarlo mas tarde",type:"negative",position:"bottom"}),u.loading.hide()):console.log(t):(console.log(t),u.notify({message:`Salida Creada ${t}`,type:"positive",position:"bottom"}),e.invoice=t,h.emit("orderpartition_refresh",{order:e}),u.loading.hide())},O=async(e,t)=>{if(u.loading.show({message:"generando traspaso"}),t){const s=await R.addTransferFS(e);s.fail?s.fail.status==503?(u.notify({message:"No hubo conexion a cedis, Intentarlo mas tarde",type:"negative",position:"bottom"}),u.loading.hide()):console.log(s):(console.log(s),u.notify({message:`Traspaso Creado ${s}`,type:"positive",position:"bottom"}),e.invoice=s,h.emit("orderpartition_refresh",{order:e}),u.loading.hide())}else{const s=await R.endTransferFS(e);s.fail?s.fail.status==503?(u.notify({message:"No hubo conexion a cedis, Intentarlo mas tarde",type:"negative",position:"bottom"}),u.loading.hide()):console.log(s):(console.log(s),u.notify({message:`Traspaso Creado ${s}`,type:"positive",position:"bottom"}),e.invoice_received=s,h.emit("orderpartition_refresh",{order:e}),u.loading.hide())}},g=(e,t)=>{let s;switch(e){case 1:s=1;break;case 2:s=12;break;case 3:s=t.pieces}return s},U=e=>{let t;switch(e){case 1:t="Pieza";break;case 2:t="Docena";break;case 3:t="Caja"}return t};return H(),(e,t)=>(Q(),E(ve,{padding:""},{default:o(()=>{var s;return[((s=I.value)==null?void 0:s.length)>0?(Q(),E($,{key:0,dense:"",title:"Modificacion Sucursales",rows:I.value,columns:D.value.columnsPrimary,pagination:D.value.pagination,"hide-bottom":"",onRowClick:X},null,8,["rows","columns","pagination"])):se("",!0),a(N,{modelValue:i.value.state,"onUpdate:modelValue":t[1]||(t[1]=l=>i.value.state=l),persistent:""},{default:o(()=>[a(P,{style:{width:"800px","max-width":"80vw"}},{default:o(()=>[a(S,{class:"items-center"},{default:o(()=>[f("div",ge,"Particion - "+d(i.value.val.id),1),a(K,{bordered:""},{default:o(()=>[a(F,null,{default:o(()=>[a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:!!i.value.val.invoice},{default:o(()=>[a(_,{flat:!!i.value.val.invoice,onClick:Z,disable:!!i.value.val.invoice},{default:o(()=>[r(d(i.value.val.requisition.from._type==2?"Factura":"Traspaso"),1)]),_:1},8,["flat","disable"])]),_:1},8,["caption"]),a(m,{class:"text-center text-bold"},{default:o(()=>[r(d(i.value.val.invoice),1)]),_:1})]),_:1}),a(ce,{spaced:"",inset:"",vertical:"",dark:""}),a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:!!i.value.val.invoice_received},{default:o(()=>[a(_,{flat:!!i.value.val.invoice_received,onClick:ee,disable:!!i.value.val.invoice_received},{default:o(()=>[r(d(i.value.val.requisition.from._type==2?"Entrada":"Traspaso"),1)]),_:1},8,["flat","disable"])]),_:1},8,["caption"]),a(m,{class:"text-center text-bold"},{default:o(()=>[r(d(i.value.val.invoice_received),1)]),_:1})]),_:1})]),_:1})]),_:1}),a(K,{bordered:""},{default:o(()=>[a(F,null,{default:o(()=>[a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:""},{default:o(()=>t[4]||(t[4]=[r("Surtidor")])),_:1}),a(m,{class:"text-center text-caption"},{default:o(()=>[r(d(i.value.val._suplier),1)]),_:1})]),_:1}),a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:""},{default:o(()=>t[5]||(t[5]=[r("Verificador")])),_:1}),a(m,{class:"text-center text-caption"},{default:o(()=>{var l;return[r(d((l=i.value.val.verified)==null?void 0:l.complete_name),1)]}),_:1})]),_:1}),a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:""},{default:o(()=>t[6]||(t[6]=[r("Chofer")])),_:1}),a(m,{class:"text-center text-caption"},{default:o(()=>{var l;return[r(d((l=i.value.val.driving)==null?void 0:l.complete_name),1)]}),_:1})]),_:1}),a(y,null,{default:o(()=>[a(m,{class:"text-center",caption:""},{default:o(()=>t[7]||(t[7]=[r("Recibo")])),_:1}),a(m,{class:"text-center text-caption"},{default:o(()=>{var l;return[r(d((l=i.value.val.receipt)==null?void 0:l.complete_name),1)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(S,null,{default:o(()=>[a($,{rows:i.value.val.products,columns:D.value.columnsProduct,pagination:D.value.pagination,"hide-bottom":""},{header:o(l=>[a(A,{props:l},{default:o(()=>[(Q(!0),ne(de,null,re(l.cols,n=>(Q(),E(J,{key:n.name,props:l},{default:o(()=>[r(d(n.label),1)]),_:2},1032,["props"]))),128)),a(J,{"auto-width":""})]),_:2},1032,["props"])]),body:o(l=>[a(A,{props:l},{default:o(()=>[a(b,null,{default:o(()=>[r(d(l.row.code),1)]),_:2},1024),a(b,null,{default:o(()=>[r(d(l.row.description),1)]),_:2},1024),a(b,{class:"text-center"},{default:o(()=>[r(d(l.row.pivot.toDelivered*g(l.row.pivot._supply_by,l.row))+" ",1),a(M,{modelValue:l.row.pivot.toDelivered,"onUpdate:modelValue":n=>l.row.pivot.toDelivered=n},{default:o(n=>[a(L,{type:"number",modelValue:n.value,"onUpdate:modelValue":v=>n.value=v,dense:"",autofocus:"",onKeyup:B(v=>n.set(),["enter"]),min:1},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),f("div",_e," Surtido Por "+d(U(l.row.pivot._supply_by)),1),r(" Piezas: "+d(n.value*g(l.row.pivot._supply_by,l.row)),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(b,{class:"text-center"},{default:o(()=>[r(d(l.row.pivot.toReceived*g(l.row.pivot._supply_by,l.row))+" ",1),a(M,{modelValue:l.row.pivot.toReceived,"onUpdate:modelValue":n=>l.row.pivot.toReceived=n},{default:o(n=>[a(L,{type:"number",modelValue:n.value,"onUpdate:modelValue":v=>n.value=v,dense:"",autofocus:"",onKeyup:B(v=>n.set(),["enter"]),min:1},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),f("div",ye," Surtido Por "+d(U(l.row.pivot._supply_by)),1),r(" Piezas: "+d(n.value*g(l.row.pivot._supply_by,l.row)),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(b,{class:"text-center"},{default:o(()=>[r(d(Number(l.row.pivot.toDelivered-l.row.pivot.toReceived)*g(l.row.pivot._supply_by,l.row)),1)]),_:2},1024),a(b,{"auto-width":""},{default:o(()=>[a(_,{color:l.row.pivot.toDelivered>=0&&l.row.pivot.toReceived>0?"grey":"negative",icon:"delete",onClick:n=>W(l.row),disable:l.row.pivot.toDelivered>=0&&l.row.pivot.toReceived>0,flat:""},null,8,["color","onClick","disable"])]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","columns","pagination"])]),_:1}),a(q,{align:"right"},{default:o(()=>[k(a(_,{flat:"",label:"Cancel",color:"primary"},null,512),[[T]]),a(_,{flat:"",label:"Guardar",color:"primary",onClick:t[0]||(t[0]=l=>w.value=!w.value)})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(N,{modelValue:w.value,"onUpdate:modelValue":t[2]||(t[2]=l=>w.value=l),persistent:""},{default:o(()=>[a(P,null,{default:o(()=>[a(S,{class:"row items-center"},{default:o(()=>[a(ue,{icon:"warning",color:"white","text-color":"negative"}),t[8]||(t[8]=f("span",{class:"q-ml-sm text-bold text-h6"},"Se realizara las modificaciones correspondientes",-1))]),_:1}),a(q,{align:"right"},{default:o(()=>[k(a(_,{flat:"",label:"Cancelar",color:"primary"},null,512),[[T]]),a(_,{flat:"",label:"Enviar",color:"primary",onClick:Y})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(N,{modelValue:c.value.state,"onUpdate:modelValue":t[3]||(t[3]=l=>c.value.state=l),persistent:""},{default:o(()=>[a(P,null,{default:o(()=>[a(S,{class:"text-center text-bold text-h6"},{default:o(()=>t[9]||(t[9]=[r(" Resultado de la Modificacin ")])),_:1}),a(S,null,{default:o(()=>[f("div",be,[t[10]||(t[10]=f("span",{class:"text-center q-mr-md"},"Elminar :",-1)),r(d(c.value.val.res.Eliminar.message?c.value.val.res.Eliminar.message:""),1),a(C,{class:"q-mb-sm",size:"sm",color:c.value.val.res.Eliminar.success?"positive":"negative",name:c.value.val.res.Eliminar.success?"check":"close"},null,8,["color","name"])]),f("div",we,[t[11]||(t[11]=f("span",{class:"text-center q-mr-md"},"Salida :",-1)),r(d(c.value.val.res.Salida.message?c.value.val.res.Salida.message:"")+" ",1),a(C,{class:"q-ml-md q-mb-sm",size:"sm",color:c.value.val.res.Salida.success?"positive":"negative",name:c.value.val.res.Salida.success?"check":"close"},null,8,["color","name"])]),f("div",xe,[t[12]||(t[12]=f("span",{class:"text-center q-mr-md"},"Entrada :",-1)),r(d(c.value.val.res.Entrada.message?c.value.val.res.Entrada.message:""),1),a(C,{class:"q-ml-md q-mb-sm",size:"sm",color:c.value.val.res.Entrada.success?"positive":"negative",name:c.value.val.res.Entrada.success?"check":"close"},null,8,["color","name"])])]),_:1}),a(q,{align:"right"},{default:o(()=>[k(a(_,{flat:"",label:"OK",color:"primary"},null,512),[[T]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]}),_:1}))}};export{Le as default};
